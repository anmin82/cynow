{% extends 'base.html' %}

{% block title %}{{ cylinder.cylinder_no }} - CYNOW{% endblock %}

{% block content %}
<nav class="breadcrumb mb-3">
    <a class="breadcrumb-item" href="{% url 'cylinders:list' %}">ìš©ê¸° ë¦¬ìŠ¤íŠ¸</a>
    <span class="breadcrumb-item active">{{ cylinder.cylinder_no }}</span>
</nav>

<div class="mb-4">
    <h1 class="page-title">{{ cylinder.cylinder_no }}</h1>
    <p class="page-subtitle">ìš©ê¸° ìƒì„¸ ì •ë³´</p>
</div>

<div class="row g-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">ê¸°ë³¸ ì •ë³´</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="text-muted" style="width: 40%;">ìš©ê¸°ë²ˆí˜¸</td>
                                <td><strong class="font-monospace fs-5">{{ cylinder.cylinder_no }}</strong></td>
                            </tr>
                            <tr>
                                <td class="text-muted">ê°€ìŠ¤ëª…</td>
                                <td>{{ cylinder.gas_name }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">ìš©ëŸ‰</td>
                                <td>{{ cylinder.capacity|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">ë°¸ë¸Œ ìŠ¤í™</td>
                                <td>{{ cylinder.valve_spec|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">ìš©ê¸° ìŠ¤í™</td>
                                <td>{{ cylinder.cylinder_spec|default:"-" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="text-muted" style="width: 40%;">í˜„ì¬ ìƒíƒœ</td>
                                <td><span class="status-badge status-{{ cylinder.status }}">{{ cylinder.status }}</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted">í˜„ì¬ ìœ„ì¹˜</td>
                                <td>{{ cylinder.location|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">ì œì¡°ì¼</td>
                                <td>{{ cylinder.manufacture_date|date:"Y-m-d"|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">ë‚´ì••ì‹œí—˜ì¼</td>
                                <td>{{ cylinder.pressure_test_date|date:"Y-m-d"|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">ê²€ì‚¬ì£¼ê¸°</td>
                                <td>
                                    {% if cylinder.needs_fcms_fix %}
                                    <span class="badge bg-danger">{{ cylinder.pressure_test_term|default:"-" }}ë…„ âš ï¸ FCMS ìˆ˜ì • í•„ìš”</span>
                                    {% else %}
                                    {{ cylinder.pressure_test_term|default:"-" }}ë…„
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">ë‚´ì••ë§Œë£Œì¼</td>
                                <td>{{ cylinder.pressure_expire_date|date:"Y-m-d"|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">ë§ˆì§€ë§‰ ì´ë²¤íŠ¸</td>
                                <td>{{ cylinder.last_event_at|default:"-" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FCMS ìƒì„¸ ì •ë³´ -->
        <div class="card mt-3">
            <div class="card-header">FCMS ìƒì„¸ ì •ë³´</div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td class="text-muted" style="width: 40%;">ì¶œí•˜ì¼ì</td>
                        <td>
                            {% if cylinder.status == 'ì¶œí•˜' or cylinder.status == 'ì¶œí•˜ì¤‘' %}
                                {{ cylinder.ship_date|date:"Y-m-d"|default:"-" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted" style="width: 40%;">ìµœê·¼ì´ë™ì„œ</td>
                        <td><span class="font-monospace">{{ cylinder.move_report_no|default:"-" }}</span></td>
                    </tr>
                    <tr>
                        <td class="text-muted">ì œì¡°LOT</td>
                        <td><span class="font-monospace">{{ cylinder.manufacture_lot|default:"-" }}</span></td>
                    </tr>
                    <tr>
                        <td class="text-muted">ì¶©ì „LOT</td>
                        <td><span class="font-monospace">{{ cylinder.filling_lot|default:"-" }}</span></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">ë¹ ë¥¸ ì•¡ì…˜</div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'dashboard:detail' %}?gas_name={{ cylinder.gas_name }}" class="btn btn-outline-light">
                        ë™ì¼ ê°€ìŠ¤ í˜„í™© ë³´ê¸°
                    </a>
                    <a href="{% url 'cylinders:list' %}?gas_name={{ cylinder.gas_name }}" class="btn btn-outline-light">
                        ë™ì¼ ê°€ìŠ¤ ìš©ê¸° ëª©ë¡
                    </a>
                    <a href="{% url 'cylinders:list' %}?location={{ cylinder.location }}" class="btn btn-outline-light">
                        ë™ì¼ ìœ„ì¹˜ ìš©ê¸° ëª©ë¡
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë©”ëª¨ ê²Œì‹œíŒ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“ ë©”ëª¨</span>
                <span class="badge bg-secondary">{{ memos|length }}ê±´</span>
            </div>
            <div class="card-body">
                <!-- ë©”ëª¨ ì‘ì„± í¼ -->
                <form method="post" action="{% url 'cylinders:memo_create' cylinder.cylinder_no %}" class="mb-4">
                    {% csrf_token %}
                    <div class="row g-2">
                        <div class="col-md-2">
                            <input type="text" name="author_name" class="form-control form-control-sm" 
                                   placeholder="ì‘ì„±ìëª…" required maxlength="50">
                        </div>
                        <div class="col-md-2">
                            <input type="password" name="password" class="form-control form-control-sm" 
                                   placeholder="ì•”í˜¸ (4ìë¦¬)" required maxlength="4" pattern="[0-9]{4}" title="4ìë¦¬ ìˆ«ì">
                        </div>
                        <div class="col-md-6">
                            <input type="text" name="content" class="form-control form-control-sm" 
                                   placeholder="ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary btn-sm w-100">ë“±ë¡</button>
                        </div>
                    </div>
                </form>
                
                <!-- ë©”ì‹œì§€ í‘œì‹œ -->
                {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show py-2" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
                {% endif %}
                
                <!-- ë©”ëª¨ ëª©ë¡ -->
                {% if memos %}
                <div class="memo-list">
                    {% for memo in memos %}
                    <div class="memo-item border-bottom pb-3 mb-3" id="memo-{{ memo.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="text-primary">{{ memo.author_name }}</strong>
                                <small class="text-muted ms-2">{{ memo.created_at|date:"Y-m-d H:i" }}</small>
                                {% if memo.updated_at != memo.created_at %}
                                <small class="text-warning ms-1">(ìˆ˜ì •ë¨)</small>
                                {% endif %}
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary btn-sm reply-toggle" 
                                        data-memo-id="{{ memo.id }}" type="button">
                                    ë‹µê¸€ {{ memo.active_replies.count }}
                                </button>
                                <button class="btn btn-outline-warning btn-sm edit-toggle" 
                                        data-memo-id="{{ memo.id }}" type="button" title="ìˆ˜ì •">âœï¸</button>
                                <button class="btn btn-outline-danger btn-sm delete-toggle" 
                                        data-memo-id="{{ memo.id }}" type="button" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <p class="mt-2 mb-2 memo-content" id="memo-content-{{ memo.id }}">{{ memo.content }}</p>
                        
                        <!-- ìˆ˜ì • í¼ -->
                        <div class="edit-form mt-2" id="edit-form-{{ memo.id }}" style="display: none;">
                            <form method="post" action="{% url 'cylinders:memo_edit' cylinder.cylinder_no memo.id %}">
                                {% csrf_token %}
                                <div class="row g-2">
                                    <div class="col-2">
                                        <input type="password" name="password" class="form-control form-control-sm" 
                                               placeholder="ì•”í˜¸" required maxlength="4" pattern="[0-9]{4}">
                                    </div>
                                    <div class="col-8">
                                        <input type="text" name="content" class="form-control form-control-sm" 
                                               value="{{ memo.content }}" required>
                                    </div>
                                    <div class="col-2">
                                        <button type="submit" class="btn btn-warning btn-sm w-100">ìˆ˜ì •</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- ì‚­ì œ í¼ -->
                        <div class="delete-form mt-2" id="delete-form-{{ memo.id }}" style="display: none;">
                            <form method="post" action="{% url 'cylinders:memo_delete' cylinder.cylinder_no memo.id %}" 
                                  onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                {% csrf_token %}
                                <div class="row g-2 align-items-center">
                                    <div class="col-auto">
                                        <span class="text-danger small">ì‚­ì œí•˜ë ¤ë©´ ì•”í˜¸ ì…ë ¥:</span>
                                    </div>
                                    <div class="col-3">
                                        <input type="password" name="password" class="form-control form-control-sm" 
                                               placeholder="ì•”í˜¸" required maxlength="4" pattern="[0-9]{4}">
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-danger btn-sm">ì‚­ì œ</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- ë‹µê¸€ ëª©ë¡ -->
                        {% if memo.active_replies.count > 0 %}
                        <div class="replies ms-4 mt-2" id="replies-{{ memo.id }}">
                            {% for reply in memo.active_replies %}
                            <div class="reply-item bg-dark bg-opacity-25 rounded p-2 mb-2">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="text-info">â†³ {{ reply.author_name }}</small>
                                        <small class="text-muted ms-2">{{ reply.created_at|date:"Y-m-d H:i" }}</small>
                                    </div>
                                </div>
                                <p class="mb-0 mt-1 small">{{ reply.content }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- ë‹µê¸€ ì‘ì„± í¼ -->
                        <div class="reply-form ms-4 mt-2" id="reply-form-{{ memo.id }}" style="display: none;">
                            <form method="post" action="{% url 'cylinders:memo_reply' cylinder.cylinder_no memo.id %}">
                                {% csrf_token %}
                                <div class="row g-2">
                                    <div class="col-2">
                                        <input type="text" name="author_name" class="form-control form-control-sm" 
                                               placeholder="ì‘ì„±ìëª…" required maxlength="50">
                                    </div>
                                    <div class="col-2">
                                        <input type="password" name="password" class="form-control form-control-sm" 
                                               placeholder="ì•”í˜¸ (4ìë¦¬)" required maxlength="4" pattern="[0-9]{4}">
                                    </div>
                                    <div class="col-6">
                                        <input type="text" name="content" class="form-control form-control-sm" 
                                               placeholder="ë‹µê¸€ ë‚´ìš©..." required>
                                    </div>
                                    <div class="col-2">
                                        <button type="submit" class="btn btn-outline-primary btn-sm w-100">ë‹µê¸€</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <p class="mb-0">ë“±ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <small>ì´ ìš©ê¸°ì— ëŒ€í•œ ì²« ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ë‹µê¸€ í† ê¸€ ë²„íŠ¼
    document.querySelectorAll('.reply-toggle').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var memoId = this.dataset.memoId;
            var replyForm = document.getElementById('reply-form-' + memoId);
            if (replyForm.style.display === 'none') {
                replyForm.style.display = 'block';
                this.classList.add('active');
            } else {
                replyForm.style.display = 'none';
                this.classList.remove('active');
            }
        });
    });
    
    // ìˆ˜ì • í† ê¸€ ë²„íŠ¼
    document.querySelectorAll('.edit-toggle').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var memoId = this.dataset.memoId;
            var editForm = document.getElementById('edit-form-' + memoId);
            var deleteForm = document.getElementById('delete-form-' + memoId);
            deleteForm.style.display = 'none';
            if (editForm.style.display === 'none') {
                editForm.style.display = 'block';
                this.classList.add('active');
            } else {
                editForm.style.display = 'none';
                this.classList.remove('active');
            }
        });
    });
    
    // ì‚­ì œ í† ê¸€ ë²„íŠ¼
    document.querySelectorAll('.delete-toggle').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var memoId = this.dataset.memoId;
            var deleteForm = document.getElementById('delete-form-' + memoId);
            var editForm = document.getElementById('edit-form-' + memoId);
            editForm.style.display = 'none';
            if (deleteForm.style.display === 'none') {
                deleteForm.style.display = 'block';
                this.classList.add('active');
            } else {
                deleteForm.style.display = 'none';
                this.classList.remove('active');
            }
        });
    });
});
</script>

<style>
.memo-item:last-child {
    border-bottom: none !important;
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}
.reply-toggle.active {
    background-color: var(--bs-primary);
    color: white;
}
.reply-item {
    border-left: 3px solid var(--bs-info);
}
</style>
{% endblock %}
