{% extends 'base.html' %}
{% load humanize %}

{% block title %}입하 보고서 - {{ report_date|date:"Y년 m월 d일" }}{% endblock %}

{% block extra_css %}
<style>
    /* 기본 스타일 */
    .info-table th {
        width: 120px;
        background: #f8f9fa;
        font-weight: 500;
    }
    
    .items-table {
        font-size: 0.9rem;
    }
    .items-table th {
        background: #f8f9fa;
        font-weight: 500;
        white-space: nowrap;
    }
    .items-table td {
        vertical-align: middle;
    }
    
    .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .status-normal { background: #d4edda; color: #155724; }
    .status-warning { background: #fff3cd; color: #856404; }
    .status-danger { background: #f8d7da; color: #721c24; }
    
    .totals-row {
        background: #e7f3ff !important;
        font-weight: 600;
    }
    .totals-row td {
        border-top: 2px solid #0d6efd;
    }
    
    /* 인쇄 스타일 */
    @media print {
        .no-print { display: none !important; }
        
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body { 
            background: white !important;
            font-size: 9pt !important;
            line-height: 1.4 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .container-fluid, .container {
            padding: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
        }
        
        .row { margin: 0 !important; }
        
        .card { 
            box-shadow: none !important;
            border: 1px solid #ccc !important;
            margin-bottom: 10px !important;
            break-inside: avoid;
        }
        .card-header {
            background: #333 !important;
            color: white !important;
            padding: 5px 10px !important;
            font-size: 10pt !important;
        }
        .card-body {
            padding: 10px !important;
        }
        
        .navbar, nav.breadcrumb, .breadcrumb { display: none !important; }
        
        /* 인쇄 헤더 */
        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px double #333;
        }
        .print-header h1 {
            font-size: 20pt;
            font-weight: bold;
            margin: 0 0 5px 0;
        }
        .print-header p {
            font-size: 9pt;
            margin: 0;
            color: #333;
        }
        
        /* 정보 테이블 */
        .info-table {
            font-size: 9pt !important;
        }
        .info-table th {
            width: 80px !important;
            padding: 3px 8px !important;
            background: #f0f0f0 !important;
        }
        .info-table td {
            padding: 3px 8px !important;
        }
        
        /* 품목 테이블 */
        .items-table {
            font-size: 8pt !important;
            width: 100% !important;
        }
        .items-table th {
            background: #e0e0e0 !important;
            padding: 4px 5px !important;
            font-size: 8pt !important;
            border: 1px solid #999 !important;
        }
        .items-table td {
            padding: 3px 5px !important;
            border: 1px solid #ccc !important;
        }
        
        /* 테이블 페이지 처리 */
        table { page-break-inside: auto; }
        tr { page-break-inside: avoid; }
        thead { display: table-header-group; }
        
        .totals-row {
            background: #f5f5f5 !important;
        }
        .totals-row td {
            border-top: 2px solid #333 !important;
        }
        
        /* 인쇄 푸터 */
        .print-footer {
            display: block !important;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
            text-align: center;
            font-size: 8pt;
            color: #666;
        }
        
        @page {
            size: A4;
            margin: 12mm 10mm;
        }
    }
    
    .print-header { display: none; }
    .print-footer { display: none; }
</style>
{% endblock %}

{% block content %}
<!-- 인쇄용 헤더 -->
<div class="print-header">
    <h1>입 하 보 고 서</h1>
    <p>KDFPK Co., Ltd. | {{ report_date|date:"Y년 m월 d일" }} | 작성: {{ generated_at|date:"H:i" }}</p>
</div>

<!-- 필터 섹션 (화면용) -->
<div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <div>
        <h4 class="mb-0"><i class="bi bi-box-arrow-in-down me-2"></i>입하 보고서</h4>
        <small class="text-muted">{{ report_date|date:"Y년 m월 d일 (l)" }} 기준</small>
    </div>
    <div>
        <form method="get" class="d-inline-flex gap-2">
            <input type="date" name="date" value="{{ report_date|date:'Y-m-d' }}" class="form-control form-control-sm" style="width: auto;">
            <button type="submit" class="btn btn-sm btn-primary">조회</button>
        </form>
        <button onclick="printReport()" class="btn btn-sm btn-outline-primary ms-2">
            <i class="bi bi-printer me-1"></i>PDF 출력
        </button>
        <a href="{% url 'reports:daily' %}?date={{ report_date|date:'Y-m-d' }}" class="btn btn-sm btn-outline-secondary ms-2">
            <i class="bi bi-arrow-left me-1"></i>일일보고서
        </a>
    </div>
</div>

<div class="row">
    <!-- 기본 정보 -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <i class="bi bi-info-circle me-1"></i>보고서 정보
            </div>
            <div class="card-body p-0">
                <table class="table table-sm info-table mb-0">
                    <tr>
                        <th>보고일자</th>
                        <td>{{ report_date|date:"Y년 m월 d일 (l)" }}</td>
                    </tr>
                    <tr>
                        <th>작성시간</th>
                        <td>{{ generated_at|date:"H:i" }}</td>
                    </tr>
                    <tr>
                        <th>입하총량</th>
                        <td><strong class="text-primary">{{ summary.total }}건</strong></td>
                    </tr>
                    <tr>
                        <th>정상용기</th>
                        <td><strong class="text-success">{{ summary.normal }}건</strong></td>
                    </tr>
                    {% if summary.expired > 0 or summary.expiring_soon > 0 %}
                    <tr>
                        <th>주의용기</th>
                        <td>
                            {% if summary.expired > 0 %}<span class="text-danger">내압만료 {{ summary.expired }}건</span>{% endif %}
                            {% if summary.expiring_soon > 0 %}<span class="text-warning ms-2">만료임박 {{ summary.expiring_soon }}건</span>{% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    
    <!-- 엔드유저별 현황 -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <i class="bi bi-people me-1"></i>엔드유저별 입하
            </div>
            <div class="card-body p-0">
                <table class="table table-sm info-table mb-0">
                    {% for e in by_enduser %}
                    <tr>
                        <th>{{ e.enduser }}</th>
                        <td><strong>{{ e.count }}건</strong></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-muted text-center py-3">데이터 없음</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 제품별 입하 현황 -->
<div class="card mb-3">
    <div class="card-header py-2">
        <i class="bi bi-box-seam me-1"></i>제품별 입하 현황
    </div>
    <div class="card-body p-0">
        <table class="table table-sm table-hover items-table mb-0">
            <thead>
                <tr>
                    <th class="text-center" style="width: 40px;">No</th>
                    <th>제품</th>
                    <th class="text-center" style="width: 70px;">수량</th>
                    <th class="text-center" style="width: 70px;">정상</th>
                    <th class="text-center" style="width: 70px;">만료</th>
                </tr>
            </thead>
            <tbody>
                {% for item in by_item %}
                <tr>
                    <td class="text-center text-muted">{{ forloop.counter }}</td>
                    <td>{{ item.item_name }}</td>
                    <td class="text-center"><strong>{{ item.count }}</strong></td>
                    <td class="text-center text-success">{{ item.normal }}</td>
                    <td class="text-center {% if item.expired > 0 %}text-danger fw-bold{% endif %}">{{ item.expired }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-3 text-muted">입하 내역 없음</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="totals-row">
                    <td></td>
                    <td class="text-end"><strong>합계</strong></td>
                    <td class="text-center"><strong>{{ summary.total }}</strong></td>
                    <td class="text-center text-success"><strong>{{ summary.normal }}</strong></td>
                    <td class="text-center text-danger"><strong>{{ summary.expired }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

{% if summary.expired > 0 or summary.expiring_soon > 0 %}
<!-- 주의 용기 목록 -->
<div class="card mb-3">
    <div class="card-header py-2 bg-danger text-white">
        <i class="bi bi-exclamation-triangle me-1"></i>주의 필요 용기
    </div>
    <div class="card-body p-0">
        <table class="table table-sm table-hover items-table mb-0">
            <thead>
                <tr>
                    <th class="text-center" style="width: 40px;">No</th>
                    <th>용기번호</th>
                    <th>제품</th>
                    <th class="text-center">내압만료일</th>
                    <th class="text-center">상태</th>
                </tr>
            </thead>
            <tbody>
                {% for a in arrivals %}
                {% if a.is_expired or a.is_expiring_soon %}
                <tr>
                    <td class="text-center text-muted">{{ forloop.counter }}</td>
                    <td><code>{{ a.cylinder_no }}</code></td>
                    <td>{{ a.gas_name }} {% if a.capacity %}({{ a.capacity }}L){% endif %}</td>
                    <td class="text-center">{{ a.pressure_expiry_date|date:"Y-m-d"|default:"-" }}</td>
                    <td class="text-center">
                        {% if a.is_expired %}
                        <span class="status-badge status-danger">내압만료</span>
                        {% else %}
                        <span class="status-badge status-warning">만료임박</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- 현재 보유 가용 용기 현황 -->
<div class="card mb-3">
    <div class="card-header py-2">
        <i class="bi bi-archive me-1"></i>현재 보유 가용 용기 현황
        <span class="badge bg-success float-end">가용 {{ total_available|intcomma }}본 / 전체 {{ total_inventory|intcomma }}본</span>
    </div>
    <div class="card-body p-0">
        <table class="table table-sm table-hover items-table mb-0">
            <thead>
                <tr>
                    <th class="text-center" style="width: 40px;">No</th>
                    <th>제품</th>
                    <th class="text-center" style="width: 70px;">가용</th>
                    <th class="text-center" style="width: 70px;">전체</th>
                </tr>
            </thead>
            <tbody>
                {% for inv in inventory_list %}
                <tr>
                    <td class="text-center text-muted">{{ forloop.counter }}</td>
                    <td>{{ inv.item_name }}</td>
                    <td class="text-center">
                        <strong class="{% if inv.available_qty == 0 %}text-danger{% elif inv.available_qty < 5 %}text-warning{% else %}text-success{% endif %}">
                            {{ inv.available_qty }}
                        </strong>
                    </td>
                    <td class="text-center text-muted">{{ inv.total_qty }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-3 text-muted">데이터 없음</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card-footer text-muted small py-1">
        <i class="bi bi-info-circle me-1"></i>가용 수량 기준 상위 15개 표시
    </div>
</div>

<!-- 전체 입하 목록 (화면용) -->
<div class="card mb-3 no-print">
    <div class="card-header py-2" data-bs-toggle="collapse" data-bs-target="#fullList" style="cursor: pointer;">
        <i class="bi bi-list-ul me-1"></i>전체 입하 목록
        <i class="bi bi-chevron-down float-end"></i>
        <span class="badge bg-primary float-end me-2">{{ arrivals|length }}건</span>
    </div>
    <div class="collapse" id="fullList">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px;">
                <table class="table table-sm table-hover items-table mb-0">
                    <thead class="sticky-top bg-light">
                        <tr>
                            <th class="text-center" style="width: 40px;">No</th>
                            <th>용기번호</th>
                            <th>제품</th>
                            <th>이동서번호</th>
                            <th class="text-center">상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in arrivals %}
                        <tr>
                            <td class="text-center text-muted">{{ forloop.counter }}</td>
                            <td><code>{{ a.cylinder_no }}</code></td>
                            <td>{{ a.item_name }}</td>
                            <td>{{ a.move_report_no|default:"-" }}</td>
                            <td class="text-center">
                                {% if a.is_expired %}
                                <span class="status-badge status-danger">내압만료</span>
                                {% elif a.is_expiring_soon %}
                                <span class="status-badge status-warning">만료임박</span>
                                {% else %}
                                <span class="status-badge status-normal">정상</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-3 text-muted">입하 내역 없음</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 인쇄용 푸터 -->
<div class="print-footer">
    <p>본 보고서는 CYNOW 용기 관리 시스템에서 자동 생성되었습니다.</p>
    <p>KDFPK Co., Ltd. | {{ generated_at|date:"Y-m-d H:i" }}</p>
</div>

<script>
function printReport() {
    const originalTitle = document.title;
    const dateStr = '{{ report_date|date:"Ymd" }}';
    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
    document.title = `입하보고서_${dateStr}_${timeStr}`;
    
    window.print();
    
    setTimeout(() => {
        document.title = originalTitle;
    }, 1000);
}
</script>
{% endblock %}
