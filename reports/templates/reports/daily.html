{% extends 'base.html' %}
{% load humanize %}

{% block title %}일일 보고서 - {{ report_date }}{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .navbar, .no-print, .filter-section { display: none !important; }
        .main-container { padding: 0 !important; max-width: 100% !important; }
        .card { box-shadow: none !important; border: 1px solid #ddd !important; }
        .print-header { display: block !important; }
        body { background: white !important; font-size: 12px !important; }
        .table { font-size: 11px !important; }
        .metric-value { font-size: 28px !important; }
        @page { margin: 15mm; size: A4 landscape; }
    }
    
    .print-header {
        display: none;
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #333;
    }
    
    .print-header h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: #1C1C1E;
    }
    
    .print-header .subtitle {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
    }
    
    .summary-card.primary { background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); }
    .summary-card.success { background: linear-gradient(135deg, #34C759 0%, #30D158 100%); }
    .summary-card.warning { background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%); }
    .summary-card.info { background: linear-gradient(135deg, #5AC8FA 0%, #32ADE6 100%); }
    .summary-card.purple { background: linear-gradient(135deg, #AF52DE 0%, #BF5AF2 100%); }
    
    .summary-card .value {
        font-size: 32px;
        font-weight: 800;
        line-height: 1;
    }
    
    .summary-card .label {
        font-size: 13px;
        opacity: 0.9;
        margin-top: 4px;
    }
    
    .move-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .move-10 { background: rgba(90, 200, 250, 0.2); color: #0A84FF; }
    .move-19 { background: rgba(255, 59, 48, 0.2); color: #FF3B30; }
    .move-21, .move-22, .move-31 { background: rgba(255, 204, 0, 0.2); color: #D4A600; }
    .move-41, .move-42 { background: rgba(175, 82, 222, 0.2); color: #AF52DE; }
    .move-50, .move-51 { background: rgba(0, 122, 255, 0.2); color: #007AFF; }
    .move-60, .move-65 { background: rgba(52, 199, 89, 0.2); color: #34C759; }
    .move-70 { background: rgba(255, 59, 48, 0.2); color: #FF3B30; }
    
    .status-table th {
        background: #f8f9fa;
        font-weight: 600;
    }
    
    .briefing-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .briefing-section h5 {
        color: #1C1C1E;
        font-weight: 700;
        margin-bottom: 15px;
    }
    
    .briefing-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e5ea;
    }
    
    .briefing-item:last-child {
        border-bottom: none;
    }
    
    .briefing-item .label {
        color: #666;
    }
    
    .briefing-item .value {
        font-weight: 700;
        color: #1C1C1E;
    }
</style>
{% endblock %}

{% block content %}
<!-- 인쇄용 헤더 -->
<div class="print-header">
    <h1>CYNOW 일일 보고서</h1>
    <div class="subtitle">{{ report_date|date:"Y년 m월 d일 (l)" }} 용기 이동 현황</div>
</div>

<!-- 필터 섹션 -->
<div class="filter-section no-print">
    <div class="row align-items-center">
        <div class="col-md-6">
            <h4 class="mb-0">
                <i class="bi bi-calendar-day me-2"></i>일일 보고서
            </h4>
            <small class="text-muted">{{ report_date|date:"Y년 m월 d일 (l)" }} 기준</small>
        </div>
        <div class="col-md-6 text-end">
            <form method="get" class="d-inline-flex gap-2">
                <input type="date" name="date" value="{{ report_date|date:'Y-m-d' }}" class="form-control form-control-sm" style="width: auto;">
                <button type="submit" class="btn btn-sm btn-primary">조회</button>
            </form>
            <button onclick="window.print()" class="btn btn-sm btn-outline-primary ms-2">
                <i class="bi bi-printer me-1"></i>인쇄
            </button>
        </div>
    </div>
</div>

<!-- 요약 카드 -->
<div class="summary-grid">
    <div class="summary-card primary">
        <div class="value">{{ total_movements|intcomma }}</div>
        <div class="label">오늘 이동</div>
    </div>
    {% for item in item_summary|slice:":5" %}
    <div class="summary-card {% cycle 'info' 'success' 'warning' 'purple' 'primary' %}">
        <div class="value">{{ item.count|intcomma }}</div>
        <div class="label">{{ item.item_name }}</div>
    </div>
    {% endfor %}
</div>

<div class="row">
    <!-- 이동 요약 -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-bar-chart me-2"></i>이동 유형별 현황 <small class="text-muted">(클릭시 상세)</small>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th>이동 유형</th>
                            <th class="text-end">건수</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in move_summary %}
                        <tr class="move-type-row" data-code="{{ item.code }}" data-label="{{ item.label }}" style="cursor: pointer;">
                            <td>
                                <span class="move-badge move-{{ item.code }}">{{ item.label }}</span>
                            </td>
                            <td class="text-end fw-bold">{{ item.count|intcomma }} <i class="bi bi-chevron-right text-muted"></i></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="2" class="text-center text-muted py-4">
                                오늘 이동 내역이 없습니다
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 제품별 이동 현황 -->
    <div class="col-md-8 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-grid me-2"></i>제품별 이동 현황
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-sm mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>제품명</th>
                                <th>이동유형</th>
                                <th class="text-end">건수</th>
                                <th class="text-center">내압만료</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in move_by_item %}
                            <tr>
                                <td class="fw-bold">{{ item.item_name }}</td>
                                <td><span class="move-badge move-{{ item.move_code }}">{{ item.move_label }}</span></td>
                                <td class="text-end fw-bold">{{ item.count }}</td>
                                <td class="text-center">
                                    {% if item.expired > 0 %}
                                    <span class="badge bg-danger">{{ item.expired }}</span>
                                    {% elif item.expiring_soon > 0 %}
                                    <span class="badge bg-warning text-dark">{{ item.expiring_soon }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    오늘 이동 내역이 없습니다
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 이동유형별 상세 분석 -->
{% if move_detail_stats %}
<div class="row">
    {% for stats in move_detail_stats %}
    <div class="col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <span class="move-badge move-{{ stats.code }}">{{ stats.label }}</span>
                <div>
                    <span class="badge bg-primary">{{ stats.total }}건</span>
                    {% if stats.expired > 0 %}
                    <span class="badge bg-danger">만료 {{ stats.expired }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <tbody>
                        {% for item in stats.by_item %}
                        <tr>
                            <td>{{ item.item_name }}</td>
                            <td class="text-end fw-bold">{{ item.count }}건</td>
                            <td class="text-end" style="width: 60px;">
                                {% if item.expired > 0 %}
                                <span class="badge bg-danger">{{ item.expired }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- 입하 용기 상세 분석 (접이식) -->
{% if arrival_details %}
<div class="card mb-4 no-print">
    <div class="card-header d-flex justify-content-between align-items-center bg-info text-white" 
         data-bs-toggle="collapse" data-bs-target="#arrivalDetails" style="cursor: pointer;">
        <span><i class="bi bi-box-arrow-in-down me-2"></i>입하 용기 상세 <i class="bi bi-chevron-down ms-2"></i></span>
        <div>
            <span class="badge bg-light text-dark me-2">전체 {{ arrival_summary.total }}건</span>
            {% if arrival_summary.expired > 0 %}
            <span class="badge bg-danger">내압만료 {{ arrival_summary.expired }}건</span>
            {% endif %}
            {% if arrival_summary.expiring_soon > 0 %}
            <span class="badge bg-warning text-dark">만료임박 {{ arrival_summary.expiring_soon }}건</span>
            {% endif %}
        </div>
    </div>
    <div class="collapse" id="arrivalDetails">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 300px;">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>용기번호</th>
                            <th>제품</th>
                            <th class="text-center">내압만료</th>
                            <th class="text-center">상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in arrival_details %}
                        <tr class="{% if a.is_expired %}table-danger{% elif a.is_expiring_soon %}table-warning{% endif %}">
                            <td class="text-muted">{{ forloop.counter }}</td>
                            <td><code class="fw-bold">{{ a.cylinder_no }}</code></td>
                            <td>{{ a.item_code|default:"-" }} {% if a.capacity %}({{ a.capacity }}L){% endif %}</td>
                            <td class="text-center">{% if a.pressure_expiry_date %}{{ a.pressure_expiry_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                            <td class="text-center">
                                {% if a.is_expired %}
                                <span class="badge bg-danger">내압만료</span>
                                {% elif a.is_expiring_soon %}
                                <span class="badge bg-warning text-dark">만료임박</span>
                                {% else %}
                                <span class="badge bg-success">정상</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 상세 이동 목록 (접이식) -->
<div class="card no-print">
    <div class="card-header d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#movementDetails" style="cursor: pointer;">
        <span><i class="bi bi-list-ul me-2"></i>이동 상세 목록 <i class="bi bi-chevron-down ms-2"></i></span>
        <span class="badge bg-primary">{{ movements|length }}건</span>
    </div>
    <div class="collapse" id="movementDetails">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px;">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>용기번호</th>
                            <th>제품</th>
                            <th>이동유형</th>
                            <th>이동서번호</th>
                            <th>비고</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in movements %}
                        <tr>
                            <td class="text-muted">{{ forloop.counter }}</td>
                            <td><code class="fw-bold">{{ m.cylinder_no }}</code></td>
                            <td>{{ m.item_name|default:"-" }}</td>
                            <td><span class="move-badge move-{{ m.move_code }}">{{ m.move_label }}</span></td>
                            <td>
                                {% if m.move_report_no %}
                                <code class="text-success">{{ m.move_report_no }}</code>
                                {% else %}-{% endif %}
                            </td>
                            <td class="small text-muted">{{ m.remarks|default:"-"|truncatechars:30 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fa-3x mb-3 d-block"></i>
                                오늘 이동 내역이 없습니다
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 이동 유형별 상세 모달 -->
<div class="modal fade" id="moveDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span id="modalMoveLabel" class="move-badge"></span> 상세 목록
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>용기번호</th>
                            <th>제품명</th>
                            <th>이동서번호</th>
                            <th>고객/공급처</th>
                            <th class="text-center">상태</th>
                        </tr>
                    </thead>
                    <tbody id="modalMoveBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <span id="modalMoveCount" class="me-auto text-muted"></span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 인쇄용 푸터 -->
<div class="text-center text-muted mt-4 small print-footer" style="display: none;">
    <p>CYNOW 용기 관리 시스템 | 생성: {{ generated_at|date:"Y-m-d H:i" }}</p>
</div>

<style>
@media print {
    .print-footer { display: block !important; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 이동 데이터를 JavaScript 객체로 저장
    const movements = [
        {% for m in movements %}
        {
            cylinder_no: "{{ m.cylinder_no }}",
            move_code: "{{ m.move_code }}",
            move_label: "{{ m.move_label }}",
            move_report_no: "{{ m.move_report_no }}",
            supplier: "{{ m.supplier }}",
            customer: "{{ m.customer }}",
            filling_lot: "{{ m.filling_lot }}",
            remarks: "{{ m.remarks|escapejs }}",
            item_code: "{{ m.item_code }}",
            item_name: "{{ m.item_name }}",
            capacity: {{ m.capacity }},
            is_expired: {{ m.is_expired|yesno:"true,false" }},
            is_expiring_soon: {{ m.is_expiring_soon|yesno:"true,false" }}
        },
        {% endfor %}
    ];
    
    const modal = new bootstrap.Modal(document.getElementById('moveDetailModal'));
    
    // 이동 유형 행 클릭 이벤트
    document.querySelectorAll('.move-type-row').forEach(row => {
        row.addEventListener('click', function() {
            const code = this.dataset.code;
            const label = this.dataset.label;
            
            // 해당 유형의 이동만 필터링
            const filtered = movements.filter(m => m.move_code === code);
            
            // 모달 제목 설정
            document.getElementById('modalMoveLabel').textContent = label;
            document.getElementById('modalMoveLabel').className = 'move-badge move-' + code;
            document.getElementById('modalMoveCount').textContent = `총 ${filtered.length}건`;
            
            // 테이블 바디 생성
            const tbody = document.getElementById('modalMoveBody');
            tbody.innerHTML = '';
            
            filtered.forEach((m, idx) => {
                const tr = document.createElement('tr');
                let statusBadge = '<span class="badge bg-success">정상</span>';
                if (m.is_expired) {
                    statusBadge = '<span class="badge bg-danger">만료</span>';
                    tr.className = 'table-danger';
                } else if (m.is_expiring_soon) {
                    statusBadge = '<span class="badge bg-warning text-dark">임박</span>';
                    tr.className = 'table-warning';
                }
                tr.innerHTML = `
                    <td class="text-muted">${idx + 1}</td>
                    <td><code class="fw-bold">${m.cylinder_no}</code></td>
                    <td>${m.item_name}</td>
                    <td>${m.move_report_no ? '<code class="text-success">' + m.move_report_no + '</code>' : '-'}</td>
                    <td>${m.customer || m.supplier || '-'}</td>
                    <td class="text-center">${statusBadge}</td>
                `;
                tbody.appendChild(tr);
            });
            
            modal.show();
        });
    });
});
</script>
{% endblock %}

