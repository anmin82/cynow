{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ report_type }} 입하보고서 - {{ start_date|date:"m/d" }}~{{ end_date|date:"m/d" }}{% endblock %}

{% block extra_css %}
<style>
    @page {
        size: A4 portrait;
        margin: 15mm;
    }
    
    body {
        font-family: 'Noto Sans KR', sans-serif;
    }
    
    .report-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 3px solid #0d6efd;
    }
    .report-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #0d6efd;
        margin-bottom: 5px;
    }
    .report-period {
        font-size: 1.1rem;
        color: #666;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }
    .summary-box {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        background: #f8f9fa;
    }
    .summary-box.primary { background: #e7f3ff; border: 2px solid #0d6efd; }
    .summary-box.danger { background: #ffe5e5; border: 2px solid #dc3545; }
    .summary-box.warning { background: #fff8e5; border: 2px solid #ffc107; }
    .summary-box.success { background: #e5f7ed; border: 2px solid #28a745; }
    
    .summary-number {
        font-size: 2rem;
        font-weight: 700;
    }
    .summary-label {
        font-size: 0.85rem;
        color: #666;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    .data-table th {
        background: #343a40;
        color: white;
        padding: 8px 6px;
        text-align: left;
        font-weight: 500;
    }
    .data-table td {
        padding: 6px;
        border-bottom: 1px solid #dee2e6;
    }
    .data-table tr:nth-child(even) {
        background: #f8f9fa;
    }
    
    .status-expired { color: #dc3545; font-weight: 600; }
    .status-soon { color: #ffc107; font-weight: 600; }
    .status-normal { color: #28a745; }
    
    @media print {
        .no-print { display: none !important; }
        body { font-size: 9pt; }
        .summary-number { font-size: 1.5rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- 인쇄 버튼 -->
    <div class="d-flex justify-content-end mb-3 no-print">
        <button onclick="window.print()" class="btn btn-primary">
            <i class="bi bi-printer me-1"></i>PDF 출력
        </button>
        <a href="{% if report_type == '주간' %}{% url 'reports:weekly' %}{% else %}{% url 'reports:monthly' %}{% endif %}" class="btn btn-outline-secondary ms-2">
            <i class="bi bi-arrow-left me-1"></i>돌아가기
        </a>
    </div>
    
    <!-- 보고서 헤더 -->
    <div class="report-header">
        <div class="report-title">{{ report_type }} 입하 보고서</div>
        <div class="report-period">{{ start_date|date:"Y년 m월 d일" }} ~ {{ end_date|date:"m월 d일" }}</div>
    </div>
    
    <!-- 요약 -->
    <div class="summary-grid">
        <div class="summary-box primary">
            <div class="summary-number">{{ summary.total|intcomma }}</div>
            <div class="summary-label">총 입하</div>
        </div>
        <div class="summary-box success">
            <div class="summary-number" style="color:#28a745;">{{ summary.normal|intcomma }}</div>
            <div class="summary-label">정상</div>
        </div>
        <div class="summary-box warning">
            <div class="summary-number" style="color:#ffc107;">{{ summary.expiring_soon|intcomma }}</div>
            <div class="summary-label">만료임박 (90일 이내)</div>
        </div>
        <div class="summary-box danger">
            <div class="summary-number" style="color:#dc3545;">{{ summary.expired|intcomma }}</div>
            <div class="summary-label">내압만료</div>
        </div>
    </div>
    
    <div class="row mb-4">
        <!-- 날짜별 집계 -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light py-2">
                    <strong><i class="bi bi-calendar3 me-1"></i>날짜별</strong>
                </div>
                <div class="card-body p-0">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th class="text-end">건수</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in by_date %}
                            <tr>
                                <td>{{ item.date|date:"m/d" }}</td>
                                <td class="text-end fw-bold">{{ item.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 제품별 집계 -->
        <div class="col-md-5">
            <div class="card h-100">
                <div class="card-header bg-light py-2">
                    <strong><i class="bi bi-box me-1"></i>제품별</strong>
                </div>
                <div class="card-body p-0">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>제품명</th>
                                <th class="text-center">건수</th>
                                <th class="text-center">만료</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in by_item %}
                            <tr>
                                <td style="font-size:0.8rem;">{{ item.item_name|truncatechars:35 }}</td>
                                <td class="text-center fw-bold">{{ item.count }}</td>
                                <td class="text-center {% if item.expired > 0 %}status-expired{% endif %}">
                                    {{ item.expired }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- EndUser별 -->
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-header bg-light py-2">
                    <strong><i class="bi bi-building me-1"></i>EndUser별</strong>
                </div>
                <div class="card-body p-0">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>EndUser</th>
                                <th class="text-end">건수</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in by_enduser %}
                            <tr>
                                <td>{{ item.enduser }}</td>
                                <td class="text-end fw-bold">{{ item.count }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="2" class="text-center text-muted">-</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 상세 목록 -->
    <div class="card">
        <div class="card-header bg-dark text-white py-2">
            <strong><i class="bi bi-list-ul me-1"></i>입하 상세 ({{ arrivals|length }}건)</strong>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>용기번호</th>
                            <th>제품</th>
                            <th>거래처</th>
                            <th>내압만료</th>
                            <th>상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in arrivals %}
                        <tr>
                            <td>{{ item.move_date|date:"m/d" }}</td>
                            <td><code>{{ item.cylinder_no }}</code></td>
                            <td style="font-size:0.8rem;">{{ item.item_name|truncatechars:30 }}</td>
                            <td>{{ item.supplier|truncatechars:15 }}</td>
                            <td>
                                {% if item.pressure_expiry_date %}
                                    {{ item.pressure_expiry_date|date:"Y-m-d" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="{% if item.is_expired %}status-expired{% elif item.is_expiring_soon %}status-soon{% else %}status-normal{% endif %}">
                                {{ item.pressure_status }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center text-muted py-4">입하 데이터 없음</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="text-center text-muted small mt-3 no-print">
        생성: {{ generated_at|date:"Y-m-d H:i" }}
    </div>
</div>
{% endblock %}

