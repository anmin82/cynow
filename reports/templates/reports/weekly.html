{% extends 'base.html' %}
{% load humanize %}

{% block title %}주간 보고서 - {{ start_date|date:"m/d" }}~{{ end_date|date:"m/d" }}{% endblock %}

{% block extra_css %}
<style>
    /* 기본 스타일 */
    .info-table th {
        width: 120px;
        background: #f8f9fa;
        font-weight: 500;
    }
    
    .items-table {
        font-size: 0.9rem;
    }
    .items-table th {
        background: #f8f9fa;
        font-weight: 500;
        white-space: nowrap;
    }
    .items-table td {
        vertical-align: middle;
    }
    
    .move-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        background: rgba(99, 102, 106, 0.15);
        color: #636366;
    }
    
    /* 입하/입고 계열 - 파랑 */
    .move-10 { background: rgba(90, 200, 250, 0.2); color: #0A84FF; }
    .move-50 { background: rgba(0, 122, 255, 0.2); color: #007AFF; }
    .move-86 { background: rgba(90, 200, 250, 0.2); color: #0A84FF; }
    
    /* 충전/외부충전 계열 - 노랑/주황 */
    .move-21, .move-22, .move-31 { background: rgba(255, 204, 0, 0.2); color: #D4A600; }
    
    /* 분석 계열 - 보라 */
    .move-41, .move-42 { background: rgba(175, 82, 222, 0.2); color: #AF52DE; }
    
    /* 출하/영업외출하 - 초록 */
    .move-60, .move-65 { background: rgba(52, 199, 89, 0.2); color: #34C759; }
    .move-30 { background: rgba(52, 199, 89, 0.2); color: #34C759; }
    
    /* 수주연결/해제 - 인디고 */
    .move-51, .move-52 { background: rgba(88, 86, 214, 0.2); color: #5856D6; }
    
    /* 회수 계열 - 틸 */
    .move-11, .move-12, .move-13, .move-14 { background: rgba(100, 210, 255, 0.2); color: #32ADE6; }
    .move-15, .move-16 { background: rgba(100, 210, 255, 0.2); color: #32ADE6; }
    
    /* 재보관 - 회색 */
    .move-17 { background: rgba(142, 142, 147, 0.2); color: #8E8E93; }
    
    /* 이상처리/반품/폐기 - 빨강 */
    .move-19 { background: rgba(255, 59, 48, 0.2); color: #FF3B30; }
    .move-70 { background: rgba(255, 59, 48, 0.2); color: #FF3B30; }
    .move-99 { background: rgba(255, 59, 48, 0.2); color: #FF3B30; }
    
    /* 전출 - 분홍 */
    .move-85 { background: rgba(255, 45, 85, 0.2); color: #FF2D55; }
    
    .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .status-normal { background: #d4edda; color: #155724; }
    .status-warning { background: #fff3cd; color: #856404; }
    .status-danger { background: #f8d7da; color: #721c24; }
    
    .totals-row {
        background: #e7f3ff !important;
        font-weight: 600;
    }
    .totals-row td {
        border-top: 2px solid #0d6efd;
    }
    
    .summary-card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: none;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #0d6efd;
    }
    
    .daily-chart {
        height: 200px;
    }
    
    /* 인쇄 스타일 */
    @media print {
        .no-print { display: none !important; }
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        body { 
            background: white !important;
            font-size: 9pt !important;
        }
        .card { 
            box-shadow: none !important;
            border: 1px solid #ccc !important;
            margin-bottom: 10px !important;
        }
        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px double #333;
        }
        .print-header h1 {
            font-size: 20pt;
            font-weight: bold;
            margin: 0 0 5px 0;
        }
    }
    
    .print-header { display: none; }
</style>
{% endblock %}

{% block content %}
<!-- 인쇄용 헤더 -->
<div class="print-header">
    <h1>주 간 보 고 서</h1>
    <p>KDFPK Co., Ltd. | {{ start_date|date:"Y년 m월 d일" }} ~ {{ end_date|date:"m월 d일" }} | 작성: {{ generated_at|date:"Y-m-d H:i" }}</p>
</div>

<!-- 필터 섹션 (화면용) -->
<div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <div>
        <h4 class="mb-0"><i class="bi bi-calendar-week me-2"></i>주간 보고서</h4>
        <small class="text-muted">{{ start_date|date:"Y년 m월 d일" }} ~ {{ end_date|date:"m월 d일" }} (7일간)</small>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'reports:weekly_arrival' %}" class="btn btn-sm btn-primary">
            <i class="bi bi-file-pdf me-1"></i>주간 입하보고서
        </a>
        <button onclick="printReport()" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-printer me-1"></i>인쇄
        </button>
        <a href="{% url 'reports:daily' %}" class="btn btn-sm btn-outline-secondary">일일</a>
        <a href="{% url 'reports:monthly' %}" class="btn btn-sm btn-outline-secondary">월간</a>
    </div>
</div>

<!-- 요약 카드 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card summary-card text-center">
            <div class="card-body py-3">
                <div class="stat-number">{{ total_movements|intcomma }}</div>
                <div class="text-muted">총 이동 건수</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card summary-card text-center">
            <div class="card-body py-3">
                <div class="stat-number text-info">{{ arrival_summary.total|intcomma }}</div>
                <div class="text-muted">입하 (10)</div>
                {% if arrival_summary.expired > 0 %}
                <small class="text-danger">만료 {{ arrival_summary.expired }}건</small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card summary-card text-center">
            <div class="card-body py-3">
                <div class="stat-number text-success">{{ total_cylinders|intcomma }}</div>
                <div class="text-muted">현재 보유 용기</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card summary-card text-center">
            <div class="card-body py-3">
                <div class="stat-number text-warning">{{ move_summary|length }}</div>
                <div class="text-muted">이동 유형</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 기본 정보 -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <i class="bi bi-info-circle me-1"></i>보고서 정보
            </div>
            <div class="card-body p-0">
                <table class="table table-sm info-table mb-0">
                    <tr>
                        <th>보고기간</th>
                        <td>{{ start_date|date:"Y년 m월 d일" }} ~ {{ end_date|date:"m월 d일" }} (7일)</td>
                    </tr>
                    <tr>
                        <th>작성시간</th>
                        <td>{{ generated_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                    <tr>
                        <th>총 이동</th>
                        <td><strong class="text-primary">{{ total_movements|intcomma }}건</strong></td>
                    </tr>
                    <tr>
                        <th>일평균</th>
                        <td>{{ total_movements|floatformat:0|divisibleby:7 }}건/일</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 이동 유형별 요약 -->
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header py-2">
                <i class="bi bi-bar-chart me-1"></i>이동 유형별 현황 (Top 8)
            </div>
            <div class="card-body p-0">
                <table class="table table-sm info-table mb-0">
                    {% for item in move_summary|slice:":8" %}
                    <tr>
                        <th><span class="move-badge move-{{ item.code }}">{{ item.label }}</span></th>
                        <td><strong>{{ item.count|intcomma }}건</strong></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-muted text-center py-3">이동 내역 없음</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 일별 이동 추이 -->
{% if daily_summary %}
<div class="card mb-3">
    <div class="card-header py-2">
        <i class="bi bi-graph-up me-1"></i>일별 이동 현황
    </div>
    <div class="card-body p-0">
        <table class="table table-sm table-hover items-table mb-0">
            <thead>
                <tr>
                    <th class="text-center" style="width: 120px;">날짜</th>
                    <th class="text-center" style="width: 80px;">총 건수</th>
                    <th>주요 이동유형</th>
                </tr>
            </thead>
            <tbody>
                {% for day in daily_summary %}
                <tr>
                    <td class="text-center">{{ day.date|date:"m/d (D)" }}</td>
                    <td class="text-center"><strong>{{ day.total|intcomma }}</strong></td>
                    <td>
                        {% for label, count in day.by_move_code.items %}
                        {% if count > 0 %}
                        <span class="badge bg-secondary me-1">{{ label }} {{ count }}</span>
                        {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- 제품별 이동 현황 -->
<div class="card mb-3">
    <div class="card-header py-2">
        <i class="bi bi-box-seam me-1"></i>제품별 이동 현황 (Top 30)
    </div>
    <div class="card-body p-0">
        <table class="table table-sm table-hover items-table mb-0">
            <thead>
                <tr>
                    <th class="text-center" style="width: 40px;">No</th>
                    <th>제품</th>
                    <th class="text-center">이동유형</th>
                    <th class="text-center" style="width: 70px;">수량</th>
                    <th class="text-center" style="width: 70px;">내압만료</th>
                </tr>
            </thead>
            <tbody>
                {% for item in move_by_item|slice:":50" %}
                <tr>
                    <td class="text-center text-muted">{{ forloop.counter }}</td>
                    <td>{{ item.item_name }}</td>
                    <td class="text-center"><span class="move-badge move-{{ item.move_code }}">{{ item.move_label }}</span></td>
                    <td class="text-center"><strong>{{ item.count }}</strong></td>
                    <td class="text-center {% if item.expired > 0 %}text-danger fw-bold{% endif %}">
                        {% if item.expired > 0 %}{{ item.expired }}{% else %}-{% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-3 text-muted">이동 내역 없음</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="totals-row">
                    <td></td>
                    <td class="text-end" colspan="2"><strong>합계</strong></td>
                    <td class="text-center"><strong>{{ total_movements|intcomma }}</strong></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- 이동유형별 상세 분석 -->
{% if move_detail_stats %}
<div class="card mb-3">
    <div class="card-header py-2" data-bs-toggle="collapse" data-bs-target="#moveDetailStats" style="cursor: pointer;">
        <i class="bi bi-grid me-1"></i>이동유형별 상세
        <i class="bi bi-chevron-down float-end"></i>
    </div>
    <div class="collapse" id="moveDetailStats">
        <div class="card-body p-0">
            <table class="table table-sm table-hover items-table mb-0">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 40px;">No</th>
                        <th>이동유형</th>
                        <th>제품</th>
                        <th class="text-center" style="width: 70px;">수량</th>
                        <th class="text-center" style="width: 70px;">만료</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stats in move_detail_stats %}
                    {% for item in stats.by_item|slice:":5" %}
                    <tr>
                        {% if forloop.first %}
                        <td class="text-center text-muted" rowspan="{{ stats.by_item|slice:':5'|length }}">{{ forloop.parentloop.counter }}</td>
                        <td rowspan="{{ stats.by_item|slice:':5'|length }}">
                            <span class="move-badge move-{{ stats.code }}">{{ stats.label }}</span>
                            <span class="badge bg-primary ms-1">{{ stats.total }}건</span>
                        </td>
                        {% endif %}
                        <td>{{ item.item_name }}</td>
                        <td class="text-center"><strong>{{ item.count }}</strong></td>
                        <td class="text-center {% if item.expired > 0 %}text-danger fw-bold{% endif %}">
                            {% if item.expired > 0 %}{{ item.expired }}{% else %}-{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- 입하 용기 상세 (입하가 있을 때만) -->
{% if arrival_details %}
<div class="card mb-3">
    <div class="card-header py-2 bg-info text-white" data-bs-toggle="collapse" data-bs-target="#arrivalList" style="cursor: pointer;">
        <i class="bi bi-box-arrow-in-down me-1"></i>입하 용기 상세
        <span class="badge bg-light text-dark float-end">
            {{ arrival_summary.total }}건
            {% if arrival_summary.expired > 0 %}<span class="text-danger ms-1">(만료 {{ arrival_summary.expired }})</span>{% endif %}
        </span>
        <i class="bi bi-chevron-down float-end me-2"></i>
    </div>
    <div class="collapse" id="arrivalList">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px;">
                <table class="table table-sm table-hover items-table mb-0">
                    <thead class="sticky-top bg-light">
                        <tr>
                            <th class="text-center" style="width: 40px;">No</th>
                            <th>용기번호</th>
                            <th>제품</th>
                            <th class="text-center">입하일</th>
                            <th class="text-center">내압만료일</th>
                            <th class="text-center">상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in arrival_details %}
                        <tr class="{% if a.is_expired %}table-danger{% elif a.is_expiring_soon %}table-warning{% endif %}">
                            <td class="text-center text-muted">{{ forloop.counter }}</td>
                            <td><code>{{ a.cylinder_no }}</code></td>
                            <td>{{ a.item_code|default:"-" }}</td>
                            <td class="text-center">{{ a.move_date|date:"m/d" }}</td>
                            <td class="text-center">{{ a.pressure_expiry_date|date:"Y-m-d"|default:"-" }}</td>
                            <td class="text-center">
                                {% if a.is_expired %}
                                <span class="status-badge status-danger">내압만료</span>
                                {% elif a.is_expiring_soon %}
                                <span class="status-badge status-warning">만료임박</span>
                                {% else %}
                                <span class="status-badge status-normal">정상</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 전체 이동 목록 (화면용) -->
<div class="card mb-3 no-print">
    <div class="card-header py-2" data-bs-toggle="collapse" data-bs-target="#fullList" style="cursor: pointer;">
        <i class="bi bi-list-ul me-1"></i>전체 이동 목록
        <i class="bi bi-chevron-down float-end"></i>
        <span class="badge bg-primary float-end me-2">{{ movements|length }}건{% if total_movements > 500 %} (최대 500건){% endif %}</span>
    </div>
    <div class="collapse" id="fullList">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px;">
                <table class="table table-sm table-hover items-table mb-0">
                    <thead class="sticky-top bg-light">
                        <tr>
                            <th class="text-center" style="width: 40px;">No</th>
                            <th>날짜</th>
                            <th>용기번호</th>
                            <th>제품</th>
                            <th class="text-center">이동유형</th>
                            <th>이동서번호</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in movements %}
                        <tr>
                            <td class="text-center text-muted">{{ forloop.counter }}</td>
                            <td>{{ m.move_date|date:"m/d" }}</td>
                            <td><code>{{ m.cylinder_no }}</code></td>
                            <td>{{ m.item_name|default:"-" }}</td>
                            <td class="text-center"><span class="move-badge move-{{ m.move_code }}">{{ m.move_label }}</span></td>
                            <td>{{ m.move_report_no|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-3 text-muted">이동 내역 없음</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 현재 용기 상태 요약 -->
{% if status_summary %}
<div class="card mb-3">
    <div class="card-header py-2">
        <i class="bi bi-pie-chart me-1"></i>현재 용기 상태
    </div>
    <div class="card-body">
        <div class="row">
            {% for status, count in status_summary.items %}
            <div class="col-md-2 col-4 mb-2">
                <div class="text-center p-2 bg-light rounded">
                    <div class="fw-bold">{{ count|intcomma }}</div>
                    <small class="text-muted">{{ status }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<div class="text-center text-muted small mt-3">
    생성: {{ generated_at|date:"Y-m-d H:i" }}
</div>

<script>
function printReport() {
    const originalTitle = document.title;
    const startStr = '{{ start_date|date:"Ymd" }}';
    const endStr = '{{ end_date|date:"md" }}';
    document.title = `주간보고서_${startStr}-${endStr}`;
    
    window.print();
    
    setTimeout(() => {
        document.title = originalTitle;
    }, 1000);
}
</script>
{% endblock %}
