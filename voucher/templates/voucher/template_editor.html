{% extends "base.html" %}

{% block title %}{{ filename }} 편집 - CYNOW{% endblock %}

{% block extra_css %}
<style>
    /* 풀스크린 모달 */
    .editor-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        z-index: 99999;
        display: flex;
        flex-direction: column;
    }
    
    .editor-modal-header {
        height: 50px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        align-items: center;
        padding: 0 20px;
        gap: 15px;
        flex-shrink: 0;
        border-bottom: 1px solid #0f3460;
    }
    
    .editor-modal-header .filename {
        flex: 1;
        color: #fff;
        font-size: 1rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .editor-modal-header .filename i {
        color: #4fc3f7;
    }
    
    .editor-modal-header .badge {
        background: #00c853;
        font-size: 0.75rem;
    }
    
    .editor-modal-header .btn-close-editor {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
    }
    
    .editor-modal-header .btn-close-editor:hover {
        background: #c0392b;
    }
    
    .editor-modal-body {
        flex: 1;
        background: #fff;
        overflow: hidden;
    }
    
    #onlyoffice-editor {
        width: 100%;
        height: 100%;
    }
    
    #onlyoffice-editor iframe {
        width: 100% !important;
        height: 100% !important;
        border: none !important;
    }
    
    /* 로딩 상태 */
    .editor-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: #f5f5f5;
    }
    
    .editor-loading .spinner-border {
        width: 3rem;
        height: 3rem;
        color: #3498db;
    }
    
    .editor-loading p {
        margin-top: 1rem;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<!-- 풀스크린 모달 에디터 -->
<div class="editor-modal" id="editorModal">
    <!-- 헤더 -->
    <div class="editor-modal-header">
        <div class="filename">
            <i class="bi bi-file-earmark-word"></i>
            <span>{{ filename }}</span>
        </div>
        <span class="badge">편집 모드</span>
        <span style="color: #aaa; font-size: 0.85rem;">자동 저장됨</span>
        <button class="btn-close-editor" onclick="closeEditor()">
            <i class="bi bi-x-lg"></i> 닫기
        </button>
    </div>
    
    <!-- 에디터 본문 -->
    <div class="editor-modal-body">
        <div id="onlyoffice-editor">
            <div class="editor-loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">로딩중...</span>
                </div>
                <p>ONLYOFFICE 에디터 로딩중...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ONLYOFFICE API -->
<script src="{{ onlyoffice_api_url }}"></script>

<script>
// 에디터 닫기
function closeEditor() {
    if (confirm('편집을 종료하시겠습니까? 변경사항은 자동 저장됩니다.')) {
        window.location.href = "{% url 'voucher:template_list' %}";
    }
}

// ESC 키로 닫기
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditor();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // 에디터 설정
    const editorConfig = {{ editor_config|safe }};
    
    console.log('ONLYOFFICE Config:', editorConfig);
    console.log('Document URL:', editorConfig.document?.url);
    console.log('Callback URL:', editorConfig.editorConfig?.callbackUrl);
    
    // DocsAPI 존재 확인
    if (typeof DocsAPI === 'undefined') {
        console.error('DocsAPI가 로드되지 않았습니다!');
        document.getElementById('onlyoffice-editor').innerHTML = `
            <div class="editor-loading">
                <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                <p class="text-danger">ONLYOFFICE API를 로드할 수 없습니다.</p>
                <p class="text-muted">ONLYOFFICE Document Server 연결을 확인하세요.</p>
                <p><code>{{ onlyoffice_api_url }}</code></p>
                <a href="{% url 'voucher:template_list' %}" class="btn btn-primary mt-3">
                    목록으로 돌아가기
                </a>
            </div>
        `;
        return;
    }
    
    // ONLYOFFICE 에디터 초기화
    try {
        console.log('DocsAPI.DocEditor 초기화 시도...');
        new DocsAPI.DocEditor("onlyoffice-editor", editorConfig);
        console.log('DocsAPI.DocEditor 초기화 완료');
    } catch (error) {
        console.error('ONLYOFFICE 에디터 로드 오류:', error);
        document.getElementById('onlyoffice-editor').innerHTML = `
            <div class="editor-loading">
                <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                <p class="text-danger">에디터를 로드할 수 없습니다.</p>
                <p class="text-muted">${error.message}</p>
                <a href="{% url 'voucher:template_list' %}" class="btn btn-primary mt-3">
                    목록으로 돌아가기
                </a>
            </div>
        `;
    }
});
</script>
{% endblock %}

