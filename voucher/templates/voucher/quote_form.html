{% extends "base.html" %}
{% load humanize %}

{% block title %}{% if quote %}견적서 수정{% else %}새 견적서{% endif %} - CYNOW{% endblock %}

{% block extra_css %}
<style>
    .product-table {
        max-height: 500px;
        overflow-y: auto;
    }
    .product-table th {
        position: sticky;
        top: 0;
        background: var(--ios-gray-6);
        z-index: 1;
    }
    .product-row:hover {
        background: rgba(0, 122, 255, 0.1);
    }
    .product-row input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
    .currency-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
    }
    .select-all-btn {
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'voucher:quote_list' %}">제품견적</a></li>
        <li class="breadcrumb-item active">{% if quote %}{{ quote.quote_no }} 수정{% else %}새 견적서{% endif %}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">{% if quote %}견적서 수정{% else %}새 견적서{% endif %}</h1>
        <p class="page-subtitle">{% if quote %}{{ quote.quote_no }}{% else %}제품을 선택하면 최신 단가가 자동 적용됩니다{% endif %}</p>
    </div>
</div>

<form method="post" id="quoteForm">
    {% csrf_token %}
    
    <div class="row g-4">
        <!-- 기본 정보 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>기본 정보
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">견적번호 *</label>
                            <input type="text" name="quote_no" class="form-control" 
                                   value="{% if quote %}{{ quote.quote_no }}{% else %}{{ suggested_quote_no|default:'' }}{% endif %}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">견적일자</label>
                            <input type="date" name="quote_date" class="form-control" 
                                   value="{{ quote.quote_date|date:'Y-m-d'|default:today }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">견적건명 *</label>
                        <input type="text" name="title" class="form-control" 
                               value="{{ quote.title|default:'' }}" 
                               placeholder="예: {{ next_year }}년 특수가스 납품 단가" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">단가 적용 기간 (유효기간)</label>
                        <input type="date" name="valid_until" class="form-control" 
                               value="{{ quote.valid_until|date:'Y-m-d'|default:'' }}"
                               placeholder="이 날짜 이후 적용되는 단가로 견적 생성">
                        <small class="text-muted">이 날짜가 속한 연도의 단가가 적용됩니다</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 거래처 선택 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-building me-2"></i>거래처 선택
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">거래처 *</label>
                        <select name="customer" class="form-select" id="customerSelect" required>
                            <option value="">-- 거래처 선택 --</option>
                            {% for c in customers %}
                            <option value="{{ c.pk }}" {% if quote.customer_id == c.pk %}selected{% endif %}>
                                {{ c.name }} ({{ c.code }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        거래처와 자사 정보는 회사정보에서 자동으로 가져옵니다.
                        <a href="{% url 'voucher:company_list' %}">회사정보 관리</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if not quote %}
    <!-- 제품 선택 (신규 생성 시에만) -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-box-seam me-2"></i>제품 선택</span>
            <div>
                <button type="button" class="btn btn-sm btn-outline-light select-all-btn" onclick="selectAll()">
                    <i class="bi bi-check-all"></i> 전체 선택
                </button>
                <button type="button" class="btn btn-sm btn-outline-light select-all-btn" onclick="deselectAll()">
                    <i class="bi bi-x-lg"></i> 전체 해제
                </button>
                <span class="badge bg-primary ms-2" id="selectedCount">0개 선택</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="product-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>제품코드</th>
                            <th>가스명</th>
                            <th>용기 스펙</th>
                            <th>밸브 스펙</th>
                            <th>용량(L)</th>
                            <th>충전량(kg)</th>
                            <th>통화</th>
                            <th class="text-end">단가(/kg)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in products %}
                        <tr class="product-row">
                            <td>
                                <input type="checkbox" name="products" value="{{ p.pk }}" 
                                       class="product-checkbox" onchange="updateCount()">
                            </td>
                            <td><code>{{ p.trade_condition_no }}</code></td>
                            <td>{{ p.gas_name|default:'-' }}</td>
                            <td><small>{{ p.cylinder_spec_name|default:'-' }}</small></td>
                            <td><small>{{ p.valve_spec_name|default:'-' }}</small></td>
                            <td>{{ p.capacity|floatformat:0|default:'-' }}</td>
                            <td>{{ p.filling_weight|default:'-' }}</td>
                            <td>
                                {% if p.default_currency == 'KRW' %}
                                <span class="badge bg-success currency-badge">₩ KRW</span>
                                {% elif p.default_currency == 'JPY' %}
                                <span class="badge bg-warning text-dark currency-badge">¥ JPY</span>
                                {% elif p.default_currency == 'USD' %}
                                <span class="badge bg-primary currency-badge">$ USD</span>
                                {% else %}
                                <span class="badge bg-secondary currency-badge">{{ p.default_currency }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if p.current_price_per_kg %}
                                {{ p.current_price_per_kg|floatformat:0|intcomma }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-4 text-muted">
                                등록된 제품이 없습니다.
                                <a href="{% url 'products:list' %}">제품코드 관리</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 버튼 -->
    <div class="d-flex justify-content-between mt-4">
        <a href="{% if quote %}{% url 'voucher:quote_detail' quote.pk %}{% else %}{% url 'voucher:quote_list' %}{% endif %}" 
           class="btn btn-outline-light">
            <i class="bi bi-x-lg"></i> 취소
        </a>
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-lg"></i> {% if quote %}저장{% else %}견적서 생성{% endif %}
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
function selectAll() {
    document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = true);
    updateCount();
}

function deselectAll() {
    document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
    updateCount();
}

function updateCount() {
    const count = document.querySelectorAll('.product-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count + '개 선택';
}

// 행 클릭 시 체크박스 토글
document.querySelectorAll('.product-row').forEach(row => {
    row.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox') {
            const checkbox = this.querySelector('.product-checkbox');
            checkbox.checked = !checkbox.checked;
            updateCount();
        }
    });
});
</script>
{% endblock %}
