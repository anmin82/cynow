{% extends 'base.html' %}
{% block title %}수요 추이 - CYNOW{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="page-title">용기 수요 추이</h1>
        <p class="page-subtitle">입하 / 출하 / 충전 그래프</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'history:history' %}" class="btn btn-outline-secondary btn-sm">전체 이력</a>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        {% if error_message %}
        <div class="alert alert-warning mb-3">{{ error_message }}</div>
        {% endif %}
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">용기종류</label>
                <select name="cylinder_type_key" class="form-select" required>
                    <option value="">선택</option>
                    {% for opt in cylinder_type_options %}
                    <option value="{{ opt.cylinder_type_key }}" {% if cylinder_type_key == opt.cylinder_type_key %}selected{% endif %}>
                        {{ opt.display_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">시작일</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">종료일</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100">조회</button>
                <a href="{% url 'history:history_trend' %}?reset=1" class="btn btn-outline-secondary w-100">초기화</a>
            </div>
        </form>
    </div>
</div>

<div class="row g-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">주간 추이</div>
            <div class="card-body">
                <div class="d-flex gap-2 mb-2">
                    <label class="small text-muted">그래프 유형</label>
                    <select id="weeklyChartType" class="form-select form-select-sm" style="width:auto">
                        <option value="line" selected>선형(Line)</option>
                        <option value="bar">막대(Bar)</option>
                        <option value="bar-stacked">누적 막대(Stacked Bar)</option>
                        <option value="area">영역(Area)</option>
                        <option value="radar">레이더(Radar)</option>
                    </select>
                </div>
                <canvas id="trendWeekly" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-header">월간 추이</div>
            <div class="card-body">
                <div class="d-flex gap-2 mb-2">
                    <label class="small text-muted">그래프 유형</label>
                    <select id="monthlyChartType" class="form-select form-select-sm" style="width:auto">
                        <option value="line" selected>선형(Line)</option>
                        <option value="bar">막대(Bar)</option>
                        <option value="bar-stacked">누적 막대(Stacked Bar)</option>
                        <option value="area">영역(Area)</option>
                        <option value="radar">레이더(Radar)</option>
                    </select>
                </div>
                <canvas id="trendMonthly" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-header">월말 출하 상태 병수</div>
            <div class="card-body">
                <canvas id="trendMonthlyShipStock" height="140"></canvas>
                <div class="small text-muted mt-2">
                    각 월의 <strong>마지막 스냅샷</strong> 기준으로, 상태가 <strong>출하</strong>(또는 출하중)인 병수 합계입니다.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-header">월간 점유율(%) - 가용/공정중/제품/출하/비가용</div>
            <div class="card-body">
                <canvas id="trendMonthlyOccupancy" height="170"></canvas>
                <div class="small text-muted mt-2">
                    각 월의 <strong>마지막 스냅샷</strong> 기준 총량 대비 점유율입니다.
                    (가용=보관, 비가용=이상/정비대상/폐기)
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-3">
    <div class="col-12 mb-2">
        <div class="d-flex gap-3 align-items-center">
            <label class="text-muted mb-0">표 양식:</label>
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="tableType" id="tableTypeBasic" value="basic" checked>
                <label class="btn btn-outline-primary btn-sm" for="tableTypeBasic">기본</label>
                
                <input type="radio" class="btn-check" name="tableType" id="tableTypeRatio" value="ratio">
                <label class="btn btn-outline-primary btn-sm" for="tableTypeRatio">비율(%)</label>
                
                <input type="radio" class="btn-check" name="tableType" id="tableTypeDelta" value="delta">
                <label class="btn btn-outline-primary btn-sm" for="tableTypeDelta">증감</label>
            </div>
            <a class="btn btn-sm btn-success ms-auto" href="{% url 'history:history_trend_export' %}?cylinder_type_key={{ cylinder_type_key }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">
                <i class="bi bi-file-earmark-excel"></i> 전체 엑셀 다운로드
            </a>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">주간 데이터</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="weeklyTable" class="table table-sm mb-0">
                        <thead><tr><th>기간</th><th class="text-end">입하</th><th class="text-end">출하</th><th class="text-end">충전</th></tr></thead>
                        <tbody>
                        {% for r in weekly_summary %}
                            <tr data-inbound="{{ r.inbound_cnt|default:0 }}" data-ship="{{ r.ship_cnt|default:0 }}" data-charge="{{ r.charge_cnt|default:0 }}">
                                <td class="font-monospace">{{ r.label|default:"" }}</td>
                                <td class="text-end cell-inbound">{{ r.inbound_cnt|default:0 }}</td>
                                <td class="text-end cell-ship">{{ r.ship_cnt|default:0 }}</td>
                                <td class="text-end cell-charge">{{ r.charge_cnt|default:0 }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="4" class="text-center text-muted">데이터 없음</td></tr>
                        {% endfor %}
                        {% if weekly_summary %}
                        <tr class="table-light fw-bold total-row" data-inbound="{{ weekly_total_row.inbound }}" data-ship="{{ weekly_total_row.ship }}" data-charge="{{ weekly_total_row.charge }}">
                            <td>합계</td>
                            <td class="text-end cell-inbound">{{ weekly_total_row.inbound }}</td>
                            <td class="text-end cell-ship">{{ weekly_total_row.ship }}</td>
                            <td class="text-end cell-charge">{{ weekly_total_row.charge }}</td>
                        </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">월간 데이터</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="monthlyTable" class="table table-sm mb-0">
                        <thead><tr><th>기간</th><th class="text-end">입하</th><th class="text-end">출하</th><th class="text-end">충전</th></tr></thead>
                        <tbody>
                        {% for r in monthly_summary %}
                            <tr data-inbound="{{ r.inbound_cnt|default:0 }}" data-ship="{{ r.ship_cnt|default:0 }}" data-charge="{{ r.charge_cnt|default:0 }}">
                                <td class="font-monospace">{{ r.label|default:"" }}</td>
                                <td class="text-end cell-inbound">{{ r.inbound_cnt|default:0 }}</td>
                                <td class="text-end cell-ship">{{ r.ship_cnt|default:0 }}</td>
                                <td class="text-end cell-charge">{{ r.charge_cnt|default:0 }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="4" class="text-center text-muted">데이터 없음</td></tr>
                        {% endfor %}
                        {% if monthly_summary %}
                        <tr class="table-light fw-bold total-row" data-inbound="{{ monthly_total_row.inbound }}" data-ship="{{ monthly_total_row.ship }}" data-charge="{{ monthly_total_row.charge }}">
                            <td>합계</td>
                            <td class="text-end cell-inbound">{{ monthly_total_row.inbound }}</td>
                            <td class="text-end cell-ship">{{ monthly_total_row.ship }}</td>
                            <td class="text-end cell-charge">{{ monthly_total_row.charge }}</td>
                        </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    const weeklyData = {{ weekly_chart|safe }};
    const monthlyData = {{ monthly_chart|safe }};
    const monthlyShipStockData = {{ monthly_ship_stock_chart|safe }};
    const monthlyOccupancyData = {{ monthly_occupancy_chart|safe }};

    function renderTrend(elId, data, type) {
        const ctx = document.getElementById(elId);
        if (!ctx) return;
        const hasData = data.labels && data.labels.length > 0;
        
        // 기존 차트 제거 후 재생성
        if (ctx.__chart) {
            ctx.__chart.destroy();
        }
        
        // 그래프 타입별 설정
        let chartType = type || 'line';
        let isStacked = false;
        let fillOption = false;
        
        if (type === 'bar-stacked') {
            chartType = 'bar';
            isStacked = true;
        } else if (type === 'area') {
            chartType = 'line';
            fillOption = true;
        }
        
        const datasets = [
            { 
                label: '입하', 
                data: hasData ? data.inbound : [0], 
                borderColor: '#0d6efd', 
                backgroundColor: 'rgba(13,110,253,0.6)', 
                tension: 0.3, 
                fill: fillOption 
            },
            { 
                label: '출하', 
                data: hasData ? data.ship : [0], 
                borderColor: '#198754', 
                backgroundColor: 'rgba(25,135,84,0.6)', 
                tension: 0.3, 
                fill: fillOption 
            },
            { 
                label: '충전', 
                data: hasData ? data.charge : [0], 
                borderColor: '#fd7e14', 
                backgroundColor: 'rgba(253,126,20,0.6)', 
                tension: 0.3, 
                fill: fillOption 
            },
        ];
        
        ctx.__chart = new Chart(ctx, {
            type: chartType,
            data: {
                labels: hasData ? data.labels : ['데이터 없음'],
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: chartType !== 'radar' ? { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { precision: 0 },
                        stacked: isStacked
                    },
                    x: {
                        stacked: isStacked
                    }
                } : {},
                plugins: { 
                    legend: { position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    function renderShipStock(elId, data) {
        const ctx = document.getElementById(elId);
        if (!ctx) return;
        const hasData = data.labels && data.labels.length > 0;
        
        if (ctx.__chart) {
            ctx.__chart.destroy();
        }
        
        ctx.__chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hasData ? data.labels : ['데이터 없음'],
                datasets: [
                    {
                        label: '월말 출하중(재고)',
                        data: hasData ? data.ship_stock : [0],
                        borderColor: '#D4A600',
                        backgroundColor: 'rgba(255, 204, 0, 0.35)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    function renderOccupancy100(elId, data) {
        const ctx = document.getElementById(elId);
        if (!ctx) return;
        const hasData = data.labels && data.labels.length > 0;

        if (ctx.__chart) {
            ctx.__chart.destroy();
        }

        ctx.__chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: hasData ? data.labels : ['데이터 없음'],
                datasets: [
                    { label: '가용(보관)', data: hasData ? data.available : [0], backgroundColor: 'rgba(13,110,253,0.55)', stack: 'pct' },
                    { label: '공정중', data: hasData ? data.process : [0], backgroundColor: 'rgba(253,126,20,0.55)', stack: 'pct' },
                    { label: '제품', data: hasData ? data.product : [0], backgroundColor: 'rgba(85, 190, 240, 0.55)', stack: 'pct' },
                    { label: '출하', data: hasData ? data.ship : [0], backgroundColor: 'rgba(255,204,0,0.55)', stack: 'pct' },
                    { label: '비가용', data: hasData ? data.unavailable : [0], backgroundColor: 'rgba(255,59,48,0.55)', stack: 'pct' },
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: (v) => `${v}%`
                        }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}%`
                        }
                    }
                }
            }
        });
    }

    // 초기 렌더
    renderTrend('trendWeekly', weeklyData, 'line');
    renderTrend('trendMonthly', monthlyData, 'line');
    renderShipStock('trendMonthlyShipStock', monthlyShipStockData);
    renderOccupancy100('trendMonthlyOccupancy', monthlyOccupancyData);

    // 타입 변경 핸들러
    document.getElementById('weeklyChartType').addEventListener('change', (e) => {
        renderTrend('trendWeekly', weeklyData, e.target.value);
    });
    document.getElementById('monthlyChartType').addEventListener('change', (e) => {
        renderTrend('trendMonthly', monthlyData, e.target.value);
    });

    // 표 양식 변경 핸들러
    function updateTableDisplay(tableType) {
        const tables = ['weeklyTable', 'monthlyTable'];
        tables.forEach(tableId => {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr:not(.total-row)');
            const totalRow = table.querySelector('.total-row');
            
            if (tableType === 'basic') {
                // 기본 표시: 원래 값
                rows.forEach(row => {
                    const inbound = row.getAttribute('data-inbound') || 0;
                    const ship = row.getAttribute('data-ship') || 0;
                    const charge = row.getAttribute('data-charge') || 0;
                    row.querySelector('.cell-inbound').textContent = inbound;
                    row.querySelector('.cell-ship').textContent = ship;
                    row.querySelector('.cell-charge').textContent = charge;
                });
                if (totalRow) {
                    const inbound = totalRow.getAttribute('data-inbound') || 0;
                    const ship = totalRow.getAttribute('data-ship') || 0;
                    const charge = totalRow.getAttribute('data-charge') || 0;
                    totalRow.querySelector('.cell-inbound').textContent = inbound;
                    totalRow.querySelector('.cell-ship').textContent = ship;
                    totalRow.querySelector('.cell-charge').textContent = charge;
                }
            } else if (tableType === 'ratio') {
                // 비율 표시
                rows.forEach(row => {
                    const inbound = parseFloat(row.getAttribute('data-inbound')) || 0;
                    const ship = parseFloat(row.getAttribute('data-ship')) || 0;
                    const charge = parseFloat(row.getAttribute('data-charge')) || 0;
                    const total = inbound + ship + charge;
                    
                    if (total > 0) {
                        row.querySelector('.cell-inbound').textContent = `${inbound} (${(inbound / total * 100).toFixed(1)}%)`;
                        row.querySelector('.cell-ship').textContent = `${ship} (${(ship / total * 100).toFixed(1)}%)`;
                        row.querySelector('.cell-charge').textContent = `${charge} (${(charge / total * 100).toFixed(1)}%)`;
                    } else {
                        row.querySelector('.cell-inbound').textContent = '0 (0%)';
                        row.querySelector('.cell-ship').textContent = '0 (0%)';
                        row.querySelector('.cell-charge').textContent = '0 (0%)';
                    }
                });
                if (totalRow) {
                    const inbound = parseFloat(totalRow.getAttribute('data-inbound')) || 0;
                    const ship = parseFloat(totalRow.getAttribute('data-ship')) || 0;
                    const charge = parseFloat(totalRow.getAttribute('data-charge')) || 0;
                    const total = inbound + ship + charge;
                    
                    if (total > 0) {
                        totalRow.querySelector('.cell-inbound').textContent = `${inbound} (${(inbound / total * 100).toFixed(1)}%)`;
                        totalRow.querySelector('.cell-ship').textContent = `${ship} (${(ship / total * 100).toFixed(1)}%)`;
                        totalRow.querySelector('.cell-charge').textContent = `${charge} (${(charge / total * 100).toFixed(1)}%)`;
                    }
                }
            } else if (tableType === 'delta') {
                // 증감 표시
                let prevInbound = 0, prevShip = 0, prevCharge = 0;
                rows.forEach((row, idx) => {
                    const inbound = parseFloat(row.getAttribute('data-inbound')) || 0;
                    const ship = parseFloat(row.getAttribute('data-ship')) || 0;
                    const charge = parseFloat(row.getAttribute('data-charge')) || 0;
                    
                    if (idx === 0) {
                        row.querySelector('.cell-inbound').textContent = `${inbound} (-)`;
                        row.querySelector('.cell-ship').textContent = `${ship} (-)`;
                        row.querySelector('.cell-charge').textContent = `${charge} (-)`;
                    } else {
                        const deltaIn = inbound - prevInbound;
                        const deltaSh = ship - prevShip;
                        const deltaCh = charge - prevCharge;
                        
                        row.querySelector('.cell-inbound').textContent = `${inbound} (${deltaIn >= 0 ? '+' : ''}${deltaIn})`;
                        row.querySelector('.cell-ship').textContent = `${ship} (${deltaSh >= 0 ? '+' : ''}${deltaSh})`;
                        row.querySelector('.cell-charge').textContent = `${charge} (${deltaCh >= 0 ? '+' : ''}${deltaCh})`;
                    }
                    
                    prevInbound = inbound;
                    prevShip = ship;
                    prevCharge = charge;
                });
                if (totalRow) {
                    const inbound = totalRow.getAttribute('data-inbound') || 0;
                    const ship = totalRow.getAttribute('data-ship') || 0;
                    const charge = totalRow.getAttribute('data-charge') || 0;
                    totalRow.querySelector('.cell-inbound').textContent = inbound;
                    totalRow.querySelector('.cell-ship').textContent = ship;
                    totalRow.querySelector('.cell-charge').textContent = charge;
                }
            }
        });
    }

    // 표 양식 라디오 버튼 이벤트
    document.querySelectorAll('input[name="tableType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            updateTableDisplay(e.target.value);
        });
    });
</script>
{% endblock %}
{% endblock %}

