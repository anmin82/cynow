{% extends 'base.html' %}
{% load dashboard_tags %}

{% block title %}ì¶©ì „ ê³„íš - CYNOW{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="page-title">ì¶©ì „ ê³„íš</h1>
    <p class="page-subtitle">FILLING â€¢ ìš©ê¸°ì¢…ë¥˜ë³„ ì›”ê°„ ì¶©ì „ ê³„íš ìˆ˜ëŸ‰ ì…ë ¥</p>
</div>

<div class="alert alert-info mb-3">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Tip:</strong> ì˜¤ë²„í™€/ì…§ë‹¤ìš´ ê¸°ê°„ì—ëŠ” ì…€ì„ í´ë¦­í•´ì„œ "ì˜¤ë²„í™€" ì²´í¬ í›„ ìˆ˜ëŸ‰ì„ 0ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.
    ì˜¤ë²„í™€ í‘œì‹œëœ ì›”ì€ <span class="badge bg-warning text-dark">ğŸ”§</span>ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>ì›”ë³„ ì¶©ì „ ê³„íš ë§¤íŠ¸ë¦­ìŠ¤</span>
        {% if user.is_authenticated %}
        <small class="text-muted">ì…€ì„ í´ë¦­í•˜ì—¬ ìˆ˜ëŸ‰ ì…ë ¥ (ìë™ ì €ì¥)</small>
        {% else %}
        <small class="text-muted text-warning"><i class="bi bi-lock me-1"></i>ìˆ˜ì •í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</small>
        {% endif %}
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered mb-0 matrix-table">
                <thead>
                    <tr>
                        <th class="sticky-col" style="min-width: 250px;">ìš©ê¸°ì¢…ë¥˜</th>
                        {% for month in months %}
                        <th class="text-center month-col">{{ month|date:"Y-m" }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in matrix_data %}
                    <tr data-type-key="{{ row.key }}">
                        <td class="sticky-col type-info">
                            <strong>{{ row.info.gas_name }}</strong>
                            <div class="type-details">
                                {{ row.info.capacity|default:"-" }} | 
                                {{ row.info.valve_type|default:"-" }} | 
                                {{ row.info.cylinder_spec|extract_material }}
                                {% if row.info.usage_place %} | {{ row.info.usage_place }}{% endif %}
                            </div>
                        </td>
                        {% for month in months %}
                        {% with month_key=month|date:"Y-m" %}
                        {% with month_data=row.months|get_item:month_key %}
                        <td class="text-center qty-cell{% if not user.is_authenticated %} readonly{% endif %}{% if month_data.is_shutdown %} shutdown{% endif %}" 
                            data-month="{{ month_key }}"
                            data-shutdown="{{ month_data.is_shutdown|yesno:'true,false' }}"
                            data-note="{{ month_data.note|default:'' }}"
                            {% if user.is_authenticated %}onclick="editCell(this, '{{ row.key }}', '{{ month_key }}')"{% endif %}>
                            {% if month_data.is_shutdown %}
                            <span class="shutdown-badge" title="{{ month_data.note|default:'ì˜¤ë²„í™€/ì…§ë‹¤ìš´' }}">ğŸ”§</span>
                            {% endif %}
                            <span class="qty-value">{{ month_data.planned_fill_qty|default:"" }}</span>
                        </td>
                        {% endwith %}
                        {% endwith %}
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ months|length|add:1 }}" class="text-center text-muted py-5">
                            ìš©ê¸°ì¢…ë¥˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ë²”ë¡€ -->
<div class="mt-3 d-flex gap-3 flex-wrap">
    <span class="legend-item"><span class="qty-cell has-value" style="display:inline-block;width:20px;height:20px;"></span> ì¶©ì „ ê³„íš ìˆìŒ</span>
    <span class="legend-item"><span class="qty-cell shutdown" style="display:inline-block;width:20px;height:20px;">ğŸ”§</span> ì˜¤ë²„í™€/ì…§ë‹¤ìš´</span>
</div>

<!-- ì…ë ¥ ëª¨ë‹¬ -->
<div class="modal fade" id="inputModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="inputModalTitle">ì¶©ì „ ìˆ˜ëŸ‰ ì…ë ¥</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ì¶©ì „ ê³„íš ìˆ˜ëŸ‰</label>
                    <input type="number" id="inputValue" class="form-control form-control-lg text-center" 
                           placeholder="ìˆ˜ëŸ‰" min="0" step="1">
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="inputShutdown">
                        <label class="form-check-label" for="inputShutdown">
                            <strong>ğŸ”§ ì˜¤ë²„í™€/ì…§ë‹¤ìš´</strong> (ì´ ë‹¬ì—ëŠ” ì¶©ì „ ë¶ˆê°€)
                        </label>
                    </div>
                </div>
                <div class="mb-0">
                    <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
                    <input type="text" id="inputNote" class="form-control" 
                           placeholder="ì˜ˆ: 4ì›” ì „ì²´ ì˜¤ë²„í™€">
                </div>
                <small class="text-muted d-block mt-2" id="inputInfo"></small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" onclick="clearValue()">ì‚­ì œ</button>
                <button type="button" class="btn btn-primary" onclick="saveValue()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentCell = null;
let currentTypeKey = '';
let currentMonth = '';
let inputModal = null;

document.addEventListener('DOMContentLoaded', function() {
    inputModal = new bootstrap.Modal(document.getElementById('inputModal'));
    
    // Enter í‚¤ë¡œ ì €ì¥
    document.getElementById('inputValue').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveValue();
        }
    });
    
    // ì˜¤ë²„í™€ ì²´í¬ ì‹œ ìˆ˜ëŸ‰ì„ 0ìœ¼ë¡œ
    document.getElementById('inputShutdown').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('inputValue').value = '0';
        }
    });
});

function editCell(cell, typeKey, month) {
    currentCell = cell;
    currentTypeKey = typeKey;
    currentMonth = month;
    
    const currentValue = cell.querySelector('.qty-value').textContent.trim();
    const isShutdown = cell.dataset.shutdown === 'true';
    const note = cell.dataset.note || '';
    
    document.getElementById('inputValue').value = currentValue;
    document.getElementById('inputShutdown').checked = isShutdown;
    document.getElementById('inputNote').value = note;
    document.getElementById('inputModalTitle').textContent = month + ' ì¶©ì „ ê³„íš';
    
    // ìš©ê¸°ì¢…ë¥˜ ì •ë³´ í‘œì‹œ
    const row = cell.closest('tr');
    const typeInfo = row.querySelector('.type-info').textContent.trim().split('\n')[0];
    document.getElementById('inputInfo').textContent = typeInfo;
    
    inputModal.show();
    setTimeout(() => document.getElementById('inputValue').focus(), 300);
}

function saveValue() {
    const qty = document.getElementById('inputValue').value;
    const isShutdown = document.getElementById('inputShutdown').checked;
    const note = document.getElementById('inputNote').value;
    
    fetch('{% url "plans:filling_save" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            type_key: currentTypeKey,
            month: currentMonth,
            qty: qty,
            is_shutdown: isShutdown,
            note: note
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì…€ ì—…ë°ì´íŠ¸
            currentCell.querySelector('.qty-value').textContent = qty;
            currentCell.dataset.shutdown = isShutdown ? 'true' : 'false';
            currentCell.dataset.note = note;
            
            // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            if (isShutdown) {
                currentCell.classList.add('shutdown');
                if (!currentCell.querySelector('.shutdown-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'shutdown-badge';
                    badge.title = note || 'ì˜¤ë²„í™€/ì…§ë‹¤ìš´';
                    badge.textContent = 'ğŸ”§';
                    currentCell.insertBefore(badge, currentCell.firstChild);
                } else {
                    currentCell.querySelector('.shutdown-badge').title = note || 'ì˜¤ë²„í™€/ì…§ë‹¤ìš´';
                }
            } else {
                currentCell.classList.remove('shutdown');
                const badge = currentCell.querySelector('.shutdown-badge');
                if (badge) badge.remove();
            }
            
            if (qty && qty !== '0') {
                currentCell.classList.add('has-value');
            } else {
                currentCell.classList.remove('has-value');
            }
            
            inputModal.hide();
        } else {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        alert('ì˜¤ë¥˜: ' + error);
    });
}

function clearValue() {
    document.getElementById('inputValue').value = '';
    document.getElementById('inputShutdown').checked = false;
    document.getElementById('inputNote').value = '';
    saveValue();
}

// ê¸°ì¡´ ê°’ì´ ìˆëŠ” ì…€ í‘œì‹œ
document.querySelectorAll('.qty-cell').forEach(cell => {
    const val = cell.querySelector('.qty-value').textContent.trim();
    if (val && val !== '0') {
        cell.classList.add('has-value');
    }
});
</script>

<style>
.matrix-table {
    font-size: 13px;
}
.matrix-table th {
    background: #F5F5F7;
    font-weight: 600;
    font-size: 12px;
    padding: 12px 8px;
    white-space: nowrap;
}
.sticky-col {
    position: sticky;
    left: 0;
    background: #fff;
    z-index: 1;
    border-right: 2px solid #dee2e6 !important;
}
thead .sticky-col {
    background: #F5F5F7;
    z-index: 2;
}
.month-col {
    min-width: 80px;
}
.type-info {
    padding: 8px 12px !important;
}
.type-details {
    font-size: 11px;
    color: var(--ios-gray-1);
    margin-top: 2px;
}
.qty-cell {
    cursor: pointer;
    padding: 8px !important;
    transition: background 0.15s;
    min-width: 70px;
    position: relative;
}
.qty-cell.readonly {
    cursor: default;
}
.qty-cell:not(.readonly):hover {
    background: rgba(0, 122, 255, 0.08);
}
.qty-cell.has-value {
    background: rgba(0, 122, 255, 0.1);
}
.qty-cell.has-value:hover {
    background: rgba(0, 122, 255, 0.2);
}
.qty-cell.shutdown {
    background: rgba(255, 149, 0, 0.15) !important;
}
.qty-cell.shutdown:hover {
    background: rgba(255, 149, 0, 0.25) !important;
}
.qty-value {
    font-size: 16px;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    color: var(--ios-blue);
}
.qty-cell.shutdown .qty-value {
    color: var(--ios-orange);
}
.shutdown-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 10px;
}
.legend-item {
    font-size: 12px;
    color: var(--ios-gray-1);
    display: flex;
    align-items: center;
    gap: 6px;
}
</style>
{% endblock %}

