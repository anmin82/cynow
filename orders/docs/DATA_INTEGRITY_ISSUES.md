# PO 역수입(Backfill) 정합성 이슈 처리 가이드

> FCMS 기존 데이터를 CYNOW PO로 자동 생성 시 발생할 수 있는 정합성 이슈 및 대응 방법

---

## 📋 정합성 이슈 유형 및 처리 방법

### (A) 필수 키 누락

#### 원인
- FCMS 주문 데이터에 거래처 코드 없음
- 고객 발주번호(customer_order_no) 없음
- 품목 코드 누락

#### 증상
```python
supplier_user_code = None  # 또는 빈 문자열
customer_order_no = None
```

#### 대응
1. **자동 처리**:
   - `supplier_user_code` 없음 → `'UNKNOWN'`으로 대체
   - `customer_order_no` 없음 → `'FCMS-{arrival_shipping_no}'` 형식으로 임시값 생성
   - `needs_review=True` 플래그 설정

2. **수동 처리** (관리자):
   - Django Admin 또는 검토 화면에서 `needs_review=True`인 PO 조회
   - 실제 거래처/발주번호 확인 후 수정
   - `needs_review=False`로 변경

#### 화면 표시
```
⚠️ 검토 필요
- 거래처: UNKNOWN → 실제 코드 입력 필요
- 발주번호: FCMS-FP240001 → 실제 번호 입력 필요
```

---

### (B) 수주수량 vs 지시수량 불일치

#### 원인
- FCMS에서 주문 후 수량 변경
- TR_ORDERS와 TR_ORDER_INFORMATIONS 간 불일치
- 추가 지시 또는 취소 발생

#### 증상
```python
po_item.qty = 100  # 수주 수량
instruction_count = 120  # FCMS 지시 수량 (불일치)
```

#### 대응
1. **자동 처리**:
   - 불일치 감지 시 `needs_review=True` 설정
   - `review_note`에 불일치 내역 기록

2. **수동 처리**:
   - 검토 화면에서 불일치 사유 확인
   - 옵션 선택:
     - (1) PO 수량을 FCMS 지시 수량에 맞춤
     - (2) FCMS가 정확하다고 판단하여 현상 유지 + `needs_review=False`
     - (3) PO를 취소하고 새로 생성

#### 화면 표시
```
⚠️ 수량 불일치
- PO 수주 수량: 100개
- FCMS 지시 수량: 120개
- 차이: +20개 (20% 초과)

[PO 수량 조정] [현상 유지] [PO 취소]
```

---

### (C) 이동서만 있고 주문이 없는 케이스

#### 원인
- TR_MOVE_REPORTS에는 있으나 TR_ORDERS에 매칭되지 않음
- 이동서 번호 오입력
- 주문 없이 이동만 발생 (특수 케이스)

#### 증상
```sql
SELECT * FROM fcms_cdc.tr_move_reports mr
WHERE NOT EXISTS (
    SELECT 1 FROM fcms_cdc.tr_orders o
    WHERE o.arrival_shipping_no = mr.move_report_no
);
```

#### 대응
1. **자동 처리**:
   - `OrphanFcmsDoc` 테이블에 등록
   - `doc_type='TR_MOVE_REPORT'`
   - `is_resolved=False`

2. **수동 처리**:
   - 고아 문서 검토 화면 제공
   - 옵션:
     - (1) 기존 PO와 수동 매칭 (`suggested_po` 추천 기능)
     - (2) 새 PO 생성 후 매칭
     - (3) 무시 (정상적인 이동서로 간주)

#### 화면 표시
```
🔍 고아 문서 발견
- 이동서 번호: FP240125
- 이동 일자: 2024-12-01
- 실린더 수: 10개
- 거래처: (연결 주문 없음)

추천 PO: PO-2024-001 (거래처 일치, 날짜 근접)

[추천 PO와 매칭] [새 PO 생성] [무시]
```

---

### (D) 동일 customer_order_no에 여러 arrival_shipping_no

#### 원인
- 분할 납품
- 고객이 하나의 발주서로 여러 회차 주문
- FCMS에서 동일 발주번호로 여러 번 입력

#### 증상
```
customer_order_no: "ABC-2024-001"
  ├─ FP240001 (1회차, 50개)
  ├─ FP240050 (2회차, 30개)
  └─ FP240100 (3회차, 20개)
```

#### 대응
1. **자동 처리**:
   - 첫 번째 문서로 PO 1개 생성
   - 나머지 문서들도 같은 PO에 연결 (POFcmsMatch 여러 건)
   - `POSchedule` 테이블에 회차별 기록

2. **수동 처리**:
   - 분할납품 화면에서 회차별 진행 현황 확인
   - 필요시 회차 추가/삭제

#### 화면 표시
```
📦 분할납품 (3회차)
발주번호: ABC-2024-001

| 회차 | FCMS 번호 | 납기 | 수량 | 진행률 |
|------|-----------|------|------|--------|
| 1차  | FP240001  | 12/10 | 50 | 100% ✓ |
| 2차  | FP240050  | 12/20 | 30 | 60% ⏳ |
| 3차  | FP240100  | 12/30 | 20 | 0% 🔜 |
```

---

## 🔧 Backfill 실행 옵션

### Dry Run 모드 (안전 확인용)
```bash
python manage.py backfill_po_from_fcms --dry-run --days 30
```
- 실제 DB 변경 없이 시뮬레이션만 수행
- 결과 미리보기

### 단계적 실행
```bash
# 1단계: 최근 7일 데이터만 (테스트)
python manage.py backfill_po_from_fcms --days 7 --limit 10

# 2단계: 최근 30일
python manage.py backfill_po_from_fcms --days 30 --limit 100

# 3단계: 전체 (90일)
python manage.py backfill_po_from_fcms --days 90 --limit 1000
```

### 재처리 (수정 후)
```bash
python manage.py backfill_po_from_fcms --force --days 30
```
- `--force`: 이미 처리된 문서도 다시 처리

---

## 📊 검토 리스트 화면 (UI)

### 화면 구성
```
┌─ 역수입 데이터 검토 ────────────────────────────┐
│                                                  │
│ 🔍 필터                                          │
│  ☑ 검토 필요만 보기  ☑ 고아 문서 포함           │
│                                                  │
│ 📋 PO 리스트 (총 45건)                           │
│ ┌────────────────────────────────────────────┐  │
│ │ ⚠️ PO-BACKFILL-FP240001                   │  │
│ │   거래처: UNKNOWN → [수정]                 │  │
│ │   발주번호: FCMS-FP240001 → [수정]         │  │
│ │   [검토 완료] [PO 삭제]                    │  │
│ ├────────────────────────────────────────────┤  │
│ │ ⚠️ PO-BACKFILL-FP240002                   │  │
│ │   수량 불일치: PO 100 ≠ FCMS 120          │  │
│ │   [수량 조정] [현상 유지]                  │  │
│ ├────────────────────────────────────────────┤  │
│ │ ... (more)                                  │  │
│ └────────────────────────────────────────────┘  │
│                                                  │
│ 🔍 고아 문서 (총 12건)                           │
│ ┌────────────────────────────────────────────┐  │
│ │ 🔗 FP240125 (이동서)                       │  │
│ │   추천 PO: PO-2024-001 (유사도 85%)        │  │
│ │   [추천 PO 매칭] [새 PO 생성] [무시]        │  │
│ └────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────┘
```

---

## 🎯 정합성 이슈 우선순위

1. **Critical (즉시 처리)**:
   - 고아 문서 중 최근 7일 이내
   - 수량 불일치 50% 이상

2. **High (1주일 내 처리)**:
   - 거래처 UNKNOWN
   - 고객 발주번호 임시값

3. **Medium (2주일 내 처리)**:
   - 수량 불일치 10~50%
   - 고아 문서 (30일 이내)

4. **Low (순차 처리)**:
   - 경미한 불일치
   - 고아 문서 (30일 이상 경과)

---

## 📈 통계 및 모니터링

### Backfill 결과 요약
```
✅ 처리 완료: 1000건
  ✓ 정상 생성: 850건 (85%)
  ⚠ 검토 필요: 120건 (12%)
  ✗ 고아 문서: 30건 (3%)

검토 필요 사유별:
  - 거래처 없음: 50건
  - 발주번호 없음: 30건
  - 수량 불일치: 40건
```

### Django Admin Action
- "선택한 PO 재검증"
- "검토 완료 처리"
- "일괄 수량 동기화"

---

*문서 버전: 1.0*  
*최종 수정: 2024-12-18*


