{% extends "base.html" %}
{% load humanize %}

{% block title %}{% if is_edit %}ìˆ˜ì£¼ ìˆ˜ì •{% else %}ìƒˆ ìˆ˜ì£¼ ë“±ë¡{% endif %}{% endblock %}

{% block extra_css %}
<style>
    /* í¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .form-section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    .form-section .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 16px 20px;
    }
    .form-section .card-header h5 {
        margin: 0;
        font-weight: 600;
    }
    
    /* í•„ìˆ˜ ì…ë ¥ ê°•ì¡° */
    .required-field {
        border-left: 3px solid #dc3545;
        padding-left: 12px;
    }
    
    /* ìë™ì…ë ¥ í•„ë“œ */
    .auto-filled {
        background-color: #e8f4fd !important;
        border-color: #0d6efd !important;
    }
    
    /* í’ˆëª© í…Œì´ë¸” */
    .items-table {
        font-size: 0.9rem;
    }
    .items-table th {
        background: #f8f9fa;
        font-weight: 500;
        font-size: 0.85rem;
        padding: 10px 8px;
        white-space: nowrap;
        border-bottom: 2px solid #dee2e6;
    }
    .items-table td {
        vertical-align: middle;
        padding: 8px;
    }
    .items-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* ì œí’ˆ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
    .product-select {
        min-width: 260px;
    }
    
    /* ê³„ì‚° ê²°ê³¼ í‘œì‹œ */
    .calc-display {
        background: #f0f7ff;
        border-radius: 6px;
        padding: 6px 10px;
        margin-top: 4px;
        font-size: 0.8rem;
    }
    .calc-display .label {
        color: #666;
    }
    .calc-display .value {
        font-weight: 600;
        color: #0d6efd;
    }
    
    /* í•©ê³„ í–‰ */
    .totals-row {
        background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%) !important;
        font-weight: 600;
    }
    .totals-row td {
        border-top: 2px solid #0d6efd;
        padding: 12px 8px;
    }
    
    /* ì‚­ì œëœ í–‰ */
    .item-form-row.deleted {
        background-color: #fee2e2 !important;
        opacity: 0.5;
    }
    
    /* ë‚©ê¸° í‘œì‹œ */
    .delivery-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
    }
    .delivery-partial {
        background: #dbeafe;
        color: #1e40af;
    }
    .delivery-fixed {
        background: #fef3c7;
        color: #92400e;
    }
    
    /* ì œì¶œ ë²„íŠ¼ */
    .submit-btn {
        padding: 12px 40px;
        font-size: 1.1rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'orders:list' %}">ìˆ˜ì£¼ ëª©ë¡</a></li>
                    {% if is_edit %}
                    <li class="breadcrumb-item"><a href="{% url 'orders:detail' po.customer_order_no %}">{{ po.customer_order_no }}</a></li>
                    <li class="breadcrumb-item active">ìˆ˜ì •</li>
                    {% else %}
                    <li class="breadcrumb-item active">ìƒˆ ìˆ˜ì£¼</li>
                    {% endif %}
                </ol>
            </nav>
            <h2>{% if is_edit %}ìˆ˜ì£¼ ìˆ˜ì •{% else %}ğŸ“ ìƒˆ ìˆ˜ì£¼ ë“±ë¡{% endif %}</h2>
        </div>
    </div>

    <form method="post" id="po-form">
        {% csrf_token %}
        
        <!-- í¼ ì—ëŸ¬ í‘œì‹œ -->
        {% if form.errors or formset.errors %}
        <div class="alert alert-danger mb-4">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>ì…ë ¥ ì˜¤ë¥˜</h5>
            {% if form.errors %}
            <div><strong>ìˆ˜ì£¼ ì •ë³´:</strong>
                <ul class="mb-0">
                {% for field, errors in form.errors.items %}
                    <li>{{ field }}: {{ errors|join:", " }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% if formset.errors %}
            <div><strong>í’ˆëª©:</strong>
                <ul class="mb-0">
                {% for error in formset.errors %}
                    {% if error %}<li>{{ error }}</li>{% endif %}
                {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% if formset.non_form_errors %}
            <div><strong>í’ˆëª© ì „ì²´:</strong> {{ formset.non_form_errors }}</div>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="row">
            <!-- ì¢Œì¸¡: ê¸°ë³¸ ì •ë³´ -->
            <div class="col-lg-4">
                <!-- ê³ ê° & POë²ˆí˜¸ -->
                <div class="card form-section">
                    <div class="card-header">
                        <h5><i class="bi bi-building me-2"></i>ìˆ˜ì£¼ ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <!-- ê³ ê° ì„ íƒ -->
                        <div class="mb-3 required-field">
                            <label class="form-label fw-bold">ê³ ê°ì‚¬ <span class="text-danger">*</span></label>
                            {{ form.customer }}
                        </div>
                        
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label small text-muted">ê³ ê°ì½”ë“œ</label>
                                {{ form.supplier_user_code }}
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label small text-muted">ê³ ê°ëª…</label>
                                {{ form.supplier_user_name }}
                            </div>
                        </div>
                        
                        <!-- POë²ˆí˜¸ -->
                        <div class="mb-3 required-field">
                            <label class="form-label fw-bold">POë²ˆí˜¸ <span class="text-danger">*</span></label>
                            {{ form.customer_order_no }}
                            {% if form.customer_order_no.errors %}
                                <div class="text-danger small">{{ form.customer_order_no.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- ìˆ˜ì£¼ì¼ -->
                        <div class="mb-3">
                            <label class="form-label">ìˆ˜ì£¼ì¼</label>
                            {{ form.received_at }}
                        </div>
                        
                        <!-- ë©”ëª¨ -->
                        <div class="mb-0">
                            <label class="form-label">ë©”ëª¨</label>
                            {{ form.memo }}
                        </div>
                    </div>
                </div>
                
                <!-- ë‚©ê¸° ì•ˆë‚´ -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>ë‚©ê¸°:</strong> ê¸°ë³¸ ë¶„ë‚©(ìµì›”ë§). í’ˆëª©ë³„ ì§€ì •ì¼ ë‚©ê¸°ê°€ í•„ìš”í•˜ë©´ ë‚©ê¸° ì»¬ëŸ¼ì— ë‚ ì§œ ì…ë ¥.
                </div>
            </div>
            
            <!-- ìš°ì¸¡: ìˆ˜ì£¼ í’ˆëª© -->
            <div class="col-lg-8">
                <div class="card form-section">
                    <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>ìˆ˜ì£¼ í’ˆëª©</h5>
                        <button type="button" class="btn btn-light btn-sm" id="add-item-btn">
                            <i class="bi bi-plus-circle"></i> í’ˆëª© ì¶”ê°€
                        </button>
                    </div>
                    <div class="card-body p-0">
                        {{ formset.management_form }}
                        
                        <div class="table-responsive">
                            <table class="table mb-0 items-table" id="items-table">
                                <thead>
                                    <tr>
                                        <th>ì œí’ˆ ì„ íƒ <span class="text-danger">*</span></th>
                                        <th style="width: 80px;" class="text-center">ìˆ˜ëŸ‰ <span class="text-danger">*</span></th>
                                        <th style="width: 120px;">ë‚©ê¸°</th>
                                        <th style="width: 100px;">ë¹„ê³ </th>
                                        <th style="width: 40px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="items-tbody">
                                    {% for item_form in formset %}
                                    <tr class="item-form-row" data-form-index="{{ forloop.counter0 }}">
                                        <!-- Hidden fields -->
                                        {{ item_form.line_no }}
                                        {{ item_form.id }}
                                        {{ item_form.product_code_pk }}
                                        {{ item_form.trade_condition_name }}
                                        {{ item_form.gas_name }}
                                        {{ item_form.cylinder_spec }}
                                        {{ item_form.valve_spec }}
                                        {{ item_form.filling_weight }}
                                        {{ item_form.unit_price }}
                                        {{ item_form.currency }}
                                        <td>
                                            <!-- ì‹¤ì œ ê°’ ì €ì¥ìš© hidden input -->
                                            <input type="hidden" name="{{ item_form.trade_condition_code.html_name }}" 
                                                   class="product-code-input"
                                                   value="{{ item_form.trade_condition_code.value|default:'' }}">
                                            <!-- UIìš© select -->
                                            <select class="form-select form-select-sm product-select"
                                                    data-current="{{ item_form.trade_condition_code.value|default:'' }}">
                                                <option value="">-- ì œí’ˆ ì„ íƒ --</option>
                                            </select>
                                            <div class="calc-display mt-1" style="display: none;">
                                                <span class="label">ì¶©ì „:</span> <span class="value filling-display">-</span> |
                                                <span class="label">ë‹¨ê°€:</span> <span class="value price-display">-</span> |
                                                <span class="label">ê¸ˆì•¡:</span> <span class="value amount-display">-</span>
                                            </div>
                                        </td>
                                        <td>{{ item_form.qty }}</td>
                                        <td>
                                            {{ item_form.delivery_date }}
                                            <div class="text-muted small">ë¹„ìš°ë©´ ë¶„ë‚©</div>
                                        </td>
                                        <td>{{ item_form.remarks }}</td>
                                        <td class="text-center">
                                            {% if item_form.instance.pk %}
                                                <div class="form-check">
                                                    {{ item_form.DELETE }}
                                                </div>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="ì‚­ì œ">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="totals-row">
                                        <td class="text-end">í•©ê³„</td>
                                        <td class="text-center" id="total-qty">0</td>
                                        <td colspan="3">
                                            <span class="text-muted">ê¸ˆì•¡:</span> <span id="total-amount">-</span> |
                                            <span class="text-muted">ì¤‘ëŸ‰:</span> <span id="total-weight">-</span>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- ë²„íŠ¼ -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% if is_edit %}{% url 'orders:detail' po.customer_order_no %}{% else %}{% url 'orders:list' %}{% endif %}" 
                       class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle me-1"></i> ì·¨ì†Œ
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg submit-btn">
                        <i class="bi bi-check-circle me-1"></i> {% if is_edit %}ìˆ˜ì • ì™„ë£Œ{% else %}ìˆ˜ì£¼ ë“±ë¡{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- ë¹ˆ í’ˆëª© í–‰ í…œí”Œë¦¿ -->
<template id="empty-row-template">
    <tr class="item-form-row" data-form-index="__prefix__">
        <!-- Hidden fields -->
        <input type="hidden" name="items-__prefix__-id" id="id_items-__prefix__-id">
        <input type="hidden" name="items-__prefix__-line_no" class="line-no" value="">
        <input type="hidden" name="items-__prefix__-product_code_pk" class="product-code-pk">
        <input type="hidden" name="items-__prefix__-trade_condition_name" class="product-name">
        <input type="hidden" name="items-__prefix__-gas_name" class="gas-name">
        <input type="hidden" name="items-__prefix__-cylinder_spec" class="cylinder-spec">
        <input type="hidden" name="items-__prefix__-valve_spec" class="valve-spec">
        <input type="hidden" name="items-__prefix__-filling_weight" class="filling-weight">
        <input type="hidden" name="items-__prefix__-unit_price" class="unit-price">
        <input type="hidden" name="items-__prefix__-currency" class="currency-value">
        <td>
            <!-- ì‹¤ì œ ê°’ ì €ì¥ìš© hidden input -->
            <input type="hidden" name="items-__prefix__-trade_condition_code" class="product-code-input" value="">
            <!-- UIìš© select -->
            <select class="form-select form-select-sm product-select">
                <option value="">-- ì œí’ˆ ì„ íƒ --</option>
            </select>
            <div class="calc-display mt-1" style="display: none;">
                <span class="label">ì¶©ì „:</span> <span class="value filling-display">-</span> |
                <span class="label">ë‹¨ê°€:</span> <span class="value price-display">-</span> |
                <span class="label">ê¸ˆì•¡:</span> <span class="value amount-display">-</span>
            </div>
        </td>
        <td>
            <input type="number" name="items-__prefix__-qty" class="form-control form-control-sm qty-input" min="1" placeholder="ìˆ˜ëŸ‰" style="width: 80px;">
        </td>
        <td>
            <input type="date" name="items-__prefix__-delivery_date" class="form-control form-control-sm delivery-date" style="width: 130px;">
            <div class="text-muted small">ë¹„ìš°ë©´ ë¶„ë‚©</div>
        </td>
        <td>
            <input type="text" name="items-__prefix__-remarks" class="form-control form-control-sm" placeholder="ë¹„ê³ ">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="ì‚­ì œ">
                <i class="bi bi-x"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const API_CUSTOMER_URL = '{% url "orders:api_get_customer" customer_id=0 %}'.replace('/0/', '/');
    const API_PRODUCTS_URL = '{% url "orders:api_list_products" %}';
    
    const customerSelect = document.getElementById('customer-select');
    const codeInput = document.querySelector('[name="supplier_user_code"]');
    const nameInput = document.querySelector('[name="supplier_user_name"]');
    
    const itemsTbody = document.getElementById('items-tbody');
    const emptyRowTemplate = document.getElementById('empty-row-template');
    const totalFormsInput = document.querySelector('input[name="items-TOTAL_FORMS"]');
    
    let productsData = [];
    
    const currencySymbols = { 'KRW': 'â‚©', 'JPY': 'Â¥', 'USD': '$', 'CNY': 'Â¥' };
    
    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return num.toLocaleString('ko-KR', { maximumFractionDigits: 0 });
    }
    
    // ê³ ê° ì„ íƒ
    const poNumberInput = document.querySelector('[name="customer_order_no"]');
    
    if (customerSelect) {
        customerSelect.addEventListener('change', function() {
            const customerId = this.value;
            if (!customerId) {
                codeInput.value = '';
                nameInput.value = '';
                codeInput.classList.remove('auto-filled');
                nameInput.classList.remove('auto-filled');
                return;
            }
            
            fetch(API_CUSTOMER_URL + customerId + '/')
                .then(r => r.json())
                .then(data => {
                    if (data.code) {
                        codeInput.value = data.code;
                        nameInput.value = data.name;
                        codeInput.classList.add('auto-filled');
                        nameInput.classList.add('auto-filled');
                        
                        // POë²ˆí˜¸ì— ê³ ê°ì½”ë“œ ìë™ ì ‘ë‘ì‚¬ ì¶”ê°€
                        if (poNumberInput && !poNumberInput.value) {
                            poNumberInput.value = data.code;
                            poNumberInput.focus();
                            poNumberInput.setSelectionRange(data.code.length, data.code.length);
                        }
                    }
                });
        });
        
        if (customerSelect.value && codeInput.value) {
            codeInput.classList.add('auto-filled');
            nameInput.classList.add('auto-filled');
        }
    }
    
    // ì œí’ˆ ëª©ë¡ ë¡œë“œ
    function loadProducts() {
        fetch(API_PRODUCTS_URL)
            .then(r => r.json())
            .then(products => {
                productsData = products;
                populateProductSelects();
            });
    }
    
    function populateProductSelects() {
        document.querySelectorAll('.product-select').forEach(select => {
            const currentValue = select.dataset.current || select.value;
            select.innerHTML = '<option value="">-- ì œí’ˆ ì„ íƒ --</option>';
            
            productsData.forEach(p => {
                const option = document.createElement('option');
                option.value = p.code;
                option.textContent = p.display;
                option.dataset.product = JSON.stringify(p);
                if (p.code === currentValue) option.selected = true;
                select.appendChild(option);
            });
            
            if (currentValue) {
                const row = select.closest('.item-form-row');
                const product = productsData.find(p => p.code === currentValue);
                if (product && row) updateRowWithProduct(row, product);
            }
        });
    }
    
    // í’ˆëª© ì¶”ê°€
    document.getElementById('add-item-btn').addEventListener('click', addNewRow);
    
    function addNewRow() {
        const totalForms = parseInt(totalFormsInput.value);
        const templateHtml = emptyRowTemplate.innerHTML.replace(/__prefix__/g, totalForms);
        const tempDiv = document.createElement('tbody');
        tempDiv.innerHTML = templateHtml;
        const newRow = tempDiv.querySelector('tr');
        
        const lineNoInput = newRow.querySelector('.line-no');
        let maxLineNo = 0;
        itemsTbody.querySelectorAll('.item-form-row:not(.deleted)').forEach(row => {
            const ln = parseInt(row.querySelector('.line-no').value) || 0;
            if (ln > maxLineNo) maxLineNo = ln;
        });
        lineNoInput.value = maxLineNo + 1;
        
        itemsTbody.appendChild(newRow);
        totalFormsInput.value = totalForms + 1;
        
        const select = newRow.querySelector('.product-select');
        select.innerHTML = '<option value="">-- ì œí’ˆ ì„ íƒ --</option>';
        productsData.forEach(p => {
            const option = document.createElement('option');
            option.value = p.code;
            option.textContent = p.display;
            option.dataset.product = JSON.stringify(p);
            select.appendChild(option);
        });
        
        initRowEvents(newRow);
        select.focus();
    }
    
    // í–‰ ì´ë²¤íŠ¸
    function initRowEvents(row) {
        const productSelect = row.querySelector('.product-select');
        const qtyInput = row.querySelector('.qty-input');
        const removeBtn = row.querySelector('.remove-row-btn');
        const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        
        if (productSelect) {
            productSelect.addEventListener('change', function() {
                const opt = this.options[this.selectedIndex];
                if (opt && opt.dataset.product) {
                    updateRowWithProduct(row, JSON.parse(opt.dataset.product));
                } else {
                    clearRowProduct(row);
                }
                calculateRowAmount(row);
            });
        }
        
        if (qtyInput) qtyInput.addEventListener('input', () => calculateRowAmount(row));
        if (removeBtn) removeBtn.addEventListener('click', () => { row.remove(); updateTotals(); });
        if (deleteCheckbox) deleteCheckbox.addEventListener('change', function() {
            row.classList.toggle('deleted', this.checked);
            updateTotals();
        });
    }
    
    function updateRowWithProduct(row, product) {
        row.querySelector('.product-code-pk').value = product.pk;
        row.querySelector('.product-code-input').value = product.code;  // hidden inputì— ì½”ë“œ ì €ì¥
        row.querySelector('.product-name').value = product.name;
        row.querySelector('.gas-name').value = product.gas_name;
        row.querySelector('.cylinder-spec').value = product.cylinder_spec;
        row.querySelector('.valve-spec').value = product.valve_spec;
        row.querySelector('.filling-weight').value = product.filling_weight || '';
        row.querySelector('.unit-price').value = product.unit_price || '';
        row.querySelector('.currency-value').value = product.currency;
        
        const calcDisplay = row.querySelector('.calc-display');
        if (calcDisplay) {
            calcDisplay.style.display = 'block';
            row.querySelector('.filling-display').textContent = product.filling_weight ? `${product.filling_weight}kg` : '-';
            row.querySelector('.price-display').textContent = product.unit_price ? `${product.currency_symbol}${formatNumber(product.unit_price)}/kg` : '-';
        }
        calculateRowAmount(row);
    }
    
    function clearRowProduct(row) {
        row.querySelector('.product-code-pk').value = '';
        row.querySelector('.product-code-input').value = '';  // hidden inputë„ í´ë¦¬ì–´
        row.querySelector('.product-name').value = '';
        row.querySelector('.gas-name').value = '';
        row.querySelector('.cylinder-spec').value = '';
        row.querySelector('.valve-spec').value = '';
        row.querySelector('.filling-weight').value = '';
        row.querySelector('.unit-price').value = '';
        row.querySelector('.currency-value').value = 'KRW';
        const calcDisplay = row.querySelector('.calc-display');
        if (calcDisplay) calcDisplay.style.display = 'none';
    }
    
    function calculateRowAmount(row) {
        if (row.classList.contains('deleted')) return;
        
        const fillingWeight = parseFloat(row.querySelector('.filling-weight')?.value) || 0;
        const qty = parseInt(row.querySelector('.qty-input')?.value) || 0;
        const unitPrice = parseFloat(row.querySelector('.unit-price')?.value) || 0;
        const currency = row.querySelector('.currency-value')?.value || 'KRW';
        
        const amountDisplay = row.querySelector('.amount-display');
        if (amountDisplay) {
            if (unitPrice > 0 && fillingWeight > 0 && qty > 0) {
                const amount = unitPrice * fillingWeight * qty;
                amountDisplay.textContent = `${currencySymbols[currency] || ''}${formatNumber(amount)}`;
            } else {
                amountDisplay.textContent = '-';
            }
        }
        updateTotals();
    }
    
    function updateTotals() {
        let totalQty = 0, totalWeight = 0;
        const amounts = {};
        
        document.querySelectorAll('.item-form-row:not(.deleted)').forEach(row => {
            const qty = parseInt(row.querySelector('.qty-input')?.value) || 0;
            const fillingWeight = parseFloat(row.querySelector('.filling-weight')?.value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price')?.value) || 0;
            const currency = row.querySelector('.currency-value')?.value || 'KRW';
            
            totalQty += qty;
            if (fillingWeight > 0 && qty > 0) totalWeight += fillingWeight * qty;
            if (unitPrice > 0 && fillingWeight > 0 && qty > 0) {
                if (!amounts[currency]) amounts[currency] = 0;
                amounts[currency] += unitPrice * fillingWeight * qty;
            }
        });
        
        document.getElementById('total-qty').textContent = formatNumber(totalQty);
        
        const amountParts = Object.entries(amounts).map(([c, a]) => `${currencySymbols[c] || ''}${formatNumber(a)} ${c}`);
        document.getElementById('total-amount').textContent = amountParts.length > 0 ? amountParts.join(' / ') : '-';
        document.getElementById('total-weight').textContent = totalWeight > 0 ? `${formatNumber(totalWeight)}kg` : '-';
    }
    
    loadProducts();
    document.querySelectorAll('.item-form-row').forEach(initRowEvents);
    updateTotals();
});
</script>
{% endblock %}
