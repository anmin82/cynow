{% extends "base.html" %}
{% load humanize %}

{% block title %}{% if is_edit %}ìˆ˜ì£¼ ìˆ˜ì •{% else %}ìƒˆ ìˆ˜ì£¼ ë“±ë¡{% endif %}{% endblock %}

{% block extra_css %}
<style>
    /* í¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .form-section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    .form-section .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 16px 20px;
    }
    .form-section .card-header h5 {
        margin: 0;
        font-weight: 600;
    }
    
    /* í•„ìˆ˜ ì…ë ¥ ê°•ì¡° */
    .required-field {
        border-left: 3px solid #dc3545;
        padding-left: 12px;
    }
    
    /* ìë™ì…ë ¥ í•„ë“œ */
    .auto-filled {
        background-color: #e8f4fd !important;
        border-color: #0d6efd !important;
    }
    
    /* í’ˆëª© í…Œì´ë¸” */
    .items-table {
        font-size: 0.9rem;
    }
    .items-table th {
        background: #f8f9fa;
        font-weight: 500;
        font-size: 0.85rem;
        padding: 10px 8px;
        white-space: nowrap;
        border-bottom: 2px solid #dee2e6;
    }
    .items-table td {
        vertical-align: middle;
        padding: 8px;
    }
    .items-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* ì œí’ˆ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
    .product-select {
        min-width: 280px;
    }
    
    /* ê³„ì‚° ê²°ê³¼ í‘œì‹œ */
    .calc-display {
        background: #f0f7ff;
        border-radius: 6px;
        padding: 8px 12px;
        margin-top: 4px;
    }
    .calc-display .label {
        font-size: 0.75rem;
        color: #666;
    }
    .calc-display .value {
        font-weight: 600;
        color: #0d6efd;
    }
    
    /* í•©ê³„ í–‰ */
    .totals-row {
        background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%) !important;
        font-weight: 600;
    }
    .totals-row td {
        border-top: 2px solid #0d6efd;
        padding: 12px 8px;
    }
    
    /* ì‚­ì œëœ í–‰ */
    .item-form-row.deleted {
        background-color: #fee2e2 !important;
        opacity: 0.5;
    }
    
    /* ë‚©ê¸° ì„ íƒ */
    .delivery-section {
        background: #fffbeb;
        border: 1px solid #fcd34d;
        border-radius: 8px;
        padding: 16px;
    }
    .delivery-section.fixed {
        background: #fef2f2;
        border-color: #fca5a5;
    }
    
    /* ì œì¶œ ë²„íŠ¼ */
    .submit-btn {
        padding: 12px 40px;
        font-size: 1.1rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'orders:list' %}">ìˆ˜ì£¼ ëª©ë¡</a></li>
                    {% if is_edit %}
                    <li class="breadcrumb-item"><a href="{% url 'orders:detail' po.customer_order_no %}">{{ po.customer_order_no }}</a></li>
                    <li class="breadcrumb-item active">ìˆ˜ì •</li>
                    {% else %}
                    <li class="breadcrumb-item active">ìƒˆ ìˆ˜ì£¼</li>
                    {% endif %}
                </ol>
            </nav>
            <h2>{% if is_edit %}ìˆ˜ì£¼ ìˆ˜ì •{% else %}ğŸ“ ìƒˆ ìˆ˜ì£¼ ë“±ë¡{% endif %}</h2>
        </div>
    </div>

    <form method="post" id="po-form">
        {% csrf_token %}
        
        <div class="row">
            <!-- ì¢Œì¸¡: ê¸°ë³¸ ì •ë³´ -->
            <div class="col-lg-5">
                <!-- ê³ ê° & POë²ˆí˜¸ -->
                <div class="card form-section">
                    <div class="card-header">
                        <h5><i class="bi bi-building me-2"></i>ê³ ê° ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <!-- ê³ ê° ì„ íƒ -->
                        <div class="mb-3 required-field">
                            <label class="form-label fw-bold">ê³ ê°ì‚¬ ì„ íƒ <span class="text-danger">*</span></label>
                            {{ form.customer }}
                            <div class="form-text">ê³ ê°ì„ ì„ íƒí•˜ë©´ ì½”ë“œì™€ ì´ë¦„ì´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ê³ ê°ì½”ë“œ</label>
                                {{ form.supplier_user_code }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ê³ ê°ëª…</label>
                                {{ form.supplier_user_name }}
                            </div>
                        </div>
                        
                        <!-- POë²ˆí˜¸ -->
                        <div class="mb-3 required-field">
                            <label class="form-label fw-bold">POë²ˆí˜¸ <span class="text-danger">*</span></label>
                            {{ form.customer_order_no }}
                            {% if form.customer_order_no.errors %}
                                <div class="text-danger small">{{ form.customer_order_no.errors }}</div>
                            {% endif %}
                            <div class="form-text">ê³ ê°ì´ ë°œí–‰í•œ ë°œì£¼ì„œ ë²ˆí˜¸</div>
                        </div>
                        
                        <!-- ìˆ˜ì£¼ì¼ì‹œ -->
                        <div class="mb-0">
                            <label class="form-label">ìˆ˜ì£¼ì¼ì‹œ</label>
                            {{ form.received_at }}
                        </div>
                    </div>
                </div>
                
                <!-- ë‚©ê¸° ì •ë³´ -->
                <div class="card form-section">
                    <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <h5><i class="bi bi-calendar-check me-2"></i>ë‚©ê¸° ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <div class="delivery-section" id="delivery-section">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ë‚©ê¸° ìœ í˜•</label>
                                {{ form.delivery_type }}
                            </div>
                            
                            <div id="delivery-date-wrapper" style="display: none;">
                                <label class="form-label fw-bold">ë‚©ê¸°ì¼ <span class="text-danger">*</span></label>
                                {{ form.delivery_date }}
                                {% if form.delivery_date.errors %}
                                    <div class="text-danger small">{{ form.delivery_date.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div id="delivery-partial-info">
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>ë¶„ë‚©:</strong> ìµì›” ë§ê¹Œì§€ ìˆœì°¨ ì¶œí•˜ë©ë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ìƒíƒœ & ë©”ëª¨ -->
                <div class="card form-section">
                    <div class="card-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                        <h5><i class="bi bi-gear me-2"></i>ê¸°íƒ€</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ìƒíƒœ</label>
                            {{ form.status }}
                        </div>
                        <div class="mb-0">
                            <label class="form-label">ë©”ëª¨</label>
                            {{ form.memo }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ìš°ì¸¡: ìˆ˜ì£¼ í’ˆëª© -->
            <div class="col-lg-7">
                <div class="card form-section">
                    <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>ìˆ˜ì£¼ í’ˆëª©</h5>
                        <button type="button" class="btn btn-light btn-sm" id="add-item-btn">
                            <i class="bi bi-plus-circle"></i> í’ˆëª© ì¶”ê°€
                        </button>
                    </div>
                    <div class="card-body p-0">
                        {{ formset.management_form }}
                        
                        <div class="table-responsive">
                            <table class="table mb-0 items-table" id="items-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">No</th>
                                        <th>ì œí’ˆ ì„ íƒ <span class="text-danger">*</span></th>
                                        <th style="width: 90px;" class="text-center">ìˆ˜ëŸ‰ <span class="text-danger">*</span></th>
                                        <th style="width: 130px;">ë¹„ê³ </th>
                                        <th style="width: 45px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="items-tbody">
                                    {% for item_form in formset %}
                                    <tr class="item-form-row" data-form-index="{{ forloop.counter0 }}">
                                        <td>
                                            {{ item_form.line_no }}
                                            {{ item_form.id }}
                                            {{ item_form.product_code_pk }}
                                            {{ item_form.trade_condition_name }}
                                            {{ item_form.gas_name }}
                                            {{ item_form.cylinder_spec }}
                                            {{ item_form.valve_spec }}
                                            {{ item_form.filling_weight }}
                                            {{ item_form.unit_price }}
                                            {{ item_form.currency }}
                                        </td>
                                        <td>
                                            <select name="{{ item_form.trade_condition_code.html_name }}" 
                                                    class="form-select form-select-sm product-select"
                                                    data-current="{{ item_form.trade_condition_code.value|default:'' }}">
                                                <option value="">-- ì œí’ˆ ì„ íƒ --</option>
                                            </select>
                                            <div class="calc-display mt-2" style="display: none;">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <span class="label">ì¶©ì „ëŸ‰:</span>
                                                        <span class="value filling-display">-</span>
                                                    </div>
                                                    <div class="col-6">
                                                        <span class="label">ë‹¨ê°€:</span>
                                                        <span class="value price-display">-</span>
                                                    </div>
                                                </div>
                                                <div class="row mt-1">
                                                    <div class="col-6">
                                                        <span class="label">ì¤‘ëŸ‰:</span>
                                                        <span class="value weight-display">-</span>
                                                    </div>
                                                    <div class="col-6">
                                                        <span class="label">ê¸ˆì•¡:</span>
                                                        <span class="value amount-display">-</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ item_form.qty }}</td>
                                        <td>{{ item_form.remarks }}</td>
                                        <td class="text-center">
                                            {% if item_form.instance.pk %}
                                                <div class="form-check">
                                                    {{ item_form.DELETE }}
                                                </div>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="ì‚­ì œ">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="totals-row">
                                        <td colspan="2" class="text-end">í•©ê³„</td>
                                        <td class="text-center" id="total-qty">0</td>
                                        <td colspan="2">
                                            <div><span class="text-muted">ê¸ˆì•¡:</span> <span id="total-amount">-</span></div>
                                            <div><span class="text-muted">ì¤‘ëŸ‰:</span> <span id="total-weight">-</span></div>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div class="p-3 bg-light border-top">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                ì œí’ˆì„ ì„ íƒí•˜ë©´ ë‹¨ê°€ì™€ ìŠ¤í™ì´ ìë™ìœ¼ë¡œ ë¡œë”©ë©ë‹ˆë‹¤.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="d-flex justify-content-between mb-5 mt-4">
            <a href="{% if is_edit %}{% url 'orders:detail' po.customer_order_no %}{% else %}{% url 'orders:list' %}{% endif %}" 
               class="btn btn-secondary btn-lg">
                <i class="bi bi-x-circle me-1"></i> ì·¨ì†Œ
            </a>
            <button type="submit" class="btn btn-primary btn-lg submit-btn">
                <i class="bi bi-check-circle me-1"></i> {% if is_edit %}ìˆ˜ì • ì™„ë£Œ{% else %}ìˆ˜ì£¼ ë“±ë¡{% endif %}
            </button>
        </div>
    </form>
</div>

<!-- ë¹ˆ í’ˆëª© í–‰ í…œí”Œë¦¿ -->
<template id="empty-row-template">
    <tr class="item-form-row" data-form-index="__prefix__">
        <td>
            <input type="hidden" name="items-__prefix__-id" id="id_items-__prefix__-id">
            <input type="hidden" name="items-__prefix__-product_code_pk" class="product-code-pk">
            <input type="hidden" name="items-__prefix__-trade_condition_name" class="product-name">
            <input type="hidden" name="items-__prefix__-gas_name" class="gas-name">
            <input type="hidden" name="items-__prefix__-cylinder_spec" class="cylinder-spec">
            <input type="hidden" name="items-__prefix__-valve_spec" class="valve-spec">
            <input type="hidden" name="items-__prefix__-filling_weight" class="filling-weight">
            <input type="hidden" name="items-__prefix__-unit_price" class="unit-price">
            <input type="hidden" name="items-__prefix__-currency" class="currency-value">
            <input type="number" name="items-__prefix__-line_no" class="form-control form-control-sm line-no" min="1" style="width: 50px;" value="">
        </td>
        <td>
            <select name="items-__prefix__-trade_condition_code" class="form-select form-select-sm product-select">
                <option value="">-- ì œí’ˆ ì„ íƒ --</option>
            </select>
            <div class="calc-display mt-2" style="display: none;">
                <div class="row">
                    <div class="col-6">
                        <span class="label">ì¶©ì „ëŸ‰:</span>
                        <span class="value filling-display">-</span>
                    </div>
                    <div class="col-6">
                        <span class="label">ë‹¨ê°€:</span>
                        <span class="value price-display">-</span>
                    </div>
                </div>
                <div class="row mt-1">
                    <div class="col-6">
                        <span class="label">ì¤‘ëŸ‰:</span>
                        <span class="value weight-display">-</span>
                    </div>
                    <div class="col-6">
                        <span class="label">ê¸ˆì•¡:</span>
                        <span class="value amount-display">-</span>
                    </div>
                </div>
            </div>
        </td>
        <td>
            <input type="number" name="items-__prefix__-qty" class="form-control form-control-sm qty-input" min="1" placeholder="ìˆ˜ëŸ‰" style="width: 80px;">
        </td>
        <td>
            <input type="text" name="items-__prefix__-remarks" class="form-control form-control-sm" placeholder="ë¹„ê³ ">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="ì‚­ì œ">
                <i class="bi bi-x"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const API_CUSTOMER_URL = '{% url "orders:api_get_customer" customer_id=0 %}'.replace('/0/', '/');
    const API_PRODUCTS_URL = '{% url "orders:api_list_products" %}';
    
    const customerSelect = document.getElementById('customer-select');
    const codeInput = document.querySelector('[name="supplier_user_code"]');
    const nameInput = document.querySelector('[name="supplier_user_name"]');
    const deliveryTypeSelect = document.getElementById('delivery-type-select');
    const deliveryDateWrapper = document.getElementById('delivery-date-wrapper');
    const deliveryPartialInfo = document.getElementById('delivery-partial-info');
    const deliverySection = document.getElementById('delivery-section');
    
    const itemsTbody = document.getElementById('items-tbody');
    const emptyRowTemplate = document.getElementById('empty-row-template');
    const totalFormsInput = document.querySelector('input[name="items-TOTAL_FORMS"]');
    
    let productsData = [];
    
    // í†µí™” ê¸°í˜¸
    const currencySymbols = {
        'KRW': 'â‚©',
        'JPY': 'Â¥',
        'USD': '$',
        'CNY': 'Â¥'
    };
    
    // ìˆ«ì í¬ë§·íŒ…
    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return num.toLocaleString('ko-KR', { maximumFractionDigits: 0 });
    }
    
    // ========================================
    // ê³ ê° ì„ íƒ ì‹œ ì •ë³´ ìë™ì…ë ¥
    // ========================================
    if (customerSelect) {
        customerSelect.addEventListener('change', function() {
            const customerId = this.value;
            if (!customerId) {
                codeInput.value = '';
                nameInput.value = '';
                codeInput.classList.remove('auto-filled');
                nameInput.classList.remove('auto-filled');
                return;
            }
            
            fetch(API_CUSTOMER_URL + customerId + '/')
                .then(response => response.json())
                .then(data => {
                    if (data.code) {
                        codeInput.value = data.code;
                        nameInput.value = data.name;
                        codeInput.classList.add('auto-filled');
                        nameInput.classList.add('auto-filled');
                    }
                })
                .catch(err => console.error('ê³ ê° ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', err));
        });
        
        // ì´ˆê¸° ë¡œë“œ ì‹œ ì´ë¯¸ ì„ íƒëœ ê³ ê°ì´ ìˆìœ¼ë©´ ìŠ¤íƒ€ì¼ ì ìš©
        if (customerSelect.value && codeInput.value) {
            codeInput.classList.add('auto-filled');
            nameInput.classList.add('auto-filled');
        }
    }
    
    // ========================================
    // ë‚©ê¸° ìœ í˜• ë³€ê²½
    // ========================================
    function updateDeliveryUI() {
        const type = deliveryTypeSelect.value;
        if (type === 'FIXED') {
            deliveryDateWrapper.style.display = 'block';
            deliveryPartialInfo.style.display = 'none';
            deliverySection.classList.add('fixed');
        } else {
            deliveryDateWrapper.style.display = 'none';
            deliveryPartialInfo.style.display = 'block';
            deliverySection.classList.remove('fixed');
        }
    }
    
    if (deliveryTypeSelect) {
        deliveryTypeSelect.addEventListener('change', updateDeliveryUI);
        updateDeliveryUI(); // ì´ˆê¸° ìƒíƒœ
    }
    
    // ========================================
    // ì œí’ˆ ëª©ë¡ ë¡œë“œ
    // ========================================
    function loadProducts() {
        fetch(API_PRODUCTS_URL)
            .then(response => response.json())
            .then(products => {
                productsData = products;
                populateProductSelects();
            })
            .catch(err => console.error('ì œí’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err));
    }
    
    function populateProductSelects() {
        document.querySelectorAll('.product-select').forEach(select => {
            const currentValue = select.dataset.current || select.value;
            select.innerHTML = '<option value="">-- ì œí’ˆ ì„ íƒ --</option>';
            
            productsData.forEach(p => {
                const option = document.createElement('option');
                option.value = p.code;
                option.textContent = p.display;
                option.dataset.product = JSON.stringify(p);
                if (p.code === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // ê¸°ì¡´ ê°’ì´ ìˆìœ¼ë©´ ê³„ì‚° í‘œì‹œ
            if (currentValue) {
                const row = select.closest('.item-form-row');
                const product = productsData.find(p => p.code === currentValue);
                if (product && row) {
                    updateRowWithProduct(row, product);
                }
            }
        });
    }
    
    // ========================================
    // í’ˆëª© ì¶”ê°€ ë²„íŠ¼
    // ========================================
    document.getElementById('add-item-btn').addEventListener('click', function() {
        addNewRow();
    });
    
    function addNewRow() {
        const totalForms = parseInt(totalFormsInput.value);
        const templateHtml = emptyRowTemplate.innerHTML.replace(/__prefix__/g, totalForms);
        const tempDiv = document.createElement('tbody');
        tempDiv.innerHTML = templateHtml;
        const newRow = tempDiv.querySelector('tr');
        
        // ë¼ì¸ë²ˆí˜¸ ì„¤ì •
        const lineNoInput = newRow.querySelector('.line-no');
        const existingRows = itemsTbody.querySelectorAll('.item-form-row:not(.deleted)');
        let maxLineNo = 0;
        existingRows.forEach(row => {
            const ln = parseInt(row.querySelector('.line-no').value) || 0;
            if (ln > maxLineNo) maxLineNo = ln;
        });
        lineNoInput.value = maxLineNo + 1;
        
        itemsTbody.appendChild(newRow);
        totalFormsInput.value = totalForms + 1;
        
        // ì œí’ˆ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        const select = newRow.querySelector('.product-select');
        select.innerHTML = '<option value="">-- ì œí’ˆ ì„ íƒ --</option>';
        productsData.forEach(p => {
            const option = document.createElement('option');
            option.value = p.code;
            option.textContent = p.display;
            option.dataset.product = JSON.stringify(p);
            select.appendChild(option);
        });
        
        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        initRowEvents(newRow);
        
        // í¬ì»¤ìŠ¤
        select.focus();
    }
    
    // ========================================
    // í–‰ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
    // ========================================
    function initRowEvents(row) {
        const productSelect = row.querySelector('.product-select');
        const qtyInput = row.querySelector('.qty-input');
        const removeBtn = row.querySelector('.remove-row-btn');
        const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        
        // ì œí’ˆ ì„ íƒ ë³€ê²½
        if (productSelect) {
            productSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.product) {
                    const product = JSON.parse(selectedOption.dataset.product);
                    updateRowWithProduct(row, product);
                } else {
                    clearRowProduct(row);
                }
                calculateRowAmount(row);
            });
        }
        
        // ìˆ˜ëŸ‰ ë³€ê²½
        if (qtyInput) {
            qtyInput.addEventListener('input', () => calculateRowAmount(row));
        }
        
        // ì‚­ì œ ë²„íŠ¼
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                row.remove();
                updateTotals();
            });
        }
        
        // ì‚­ì œ ì²´í¬ë°•ìŠ¤
        if (deleteCheckbox) {
            deleteCheckbox.addEventListener('change', function() {
                row.classList.toggle('deleted', this.checked);
                updateTotals();
            });
        }
    }
    
    function updateRowWithProduct(row, product) {
        row.querySelector('.product-code-pk').value = product.pk;
        row.querySelector('.product-name').value = product.name;
        row.querySelector('.gas-name').value = product.gas_name;
        row.querySelector('.cylinder-spec').value = product.cylinder_spec;
        row.querySelector('.valve-spec').value = product.valve_spec;
        row.querySelector('.filling-weight').value = product.filling_weight || '';
        row.querySelector('.unit-price').value = product.unit_price || '';
        row.querySelector('.currency-value').value = product.currency;
        
        // ê³„ì‚° í‘œì‹œ ì˜ì—­ ë³´ì´ê¸°
        const calcDisplay = row.querySelector('.calc-display');
        if (calcDisplay) {
            calcDisplay.style.display = 'block';
            row.querySelector('.filling-display').textContent = 
                product.filling_weight ? `${product.filling_weight} kg` : '-';
            row.querySelector('.price-display').textContent = 
                product.unit_price ? `${product.currency_symbol}${formatNumber(product.unit_price)}/kg` : '-';
        }
        
        calculateRowAmount(row);
    }
    
    function clearRowProduct(row) {
        row.querySelector('.product-code-pk').value = '';
        row.querySelector('.product-name').value = '';
        row.querySelector('.gas-name').value = '';
        row.querySelector('.cylinder-spec').value = '';
        row.querySelector('.valve-spec').value = '';
        row.querySelector('.filling-weight').value = '';
        row.querySelector('.unit-price').value = '';
        row.querySelector('.currency-value').value = 'KRW';
        
        const calcDisplay = row.querySelector('.calc-display');
        if (calcDisplay) {
            calcDisplay.style.display = 'none';
        }
    }
    
    // ========================================
    // ê¸ˆì•¡ ê³„ì‚°
    // ========================================
    function calculateRowAmount(row) {
        if (row.classList.contains('deleted')) return;
        
        const fillingWeight = parseFloat(row.querySelector('.filling-weight')?.value) || 0;
        const qty = parseInt(row.querySelector('.qty-input')?.value) || 0;
        const unitPrice = parseFloat(row.querySelector('.unit-price')?.value) || 0;
        const currency = row.querySelector('.currency-value')?.value || 'KRW';
        
        const weightDisplay = row.querySelector('.weight-display');
        const amountDisplay = row.querySelector('.amount-display');
        
        if (weightDisplay) {
            if (fillingWeight > 0 && qty > 0) {
                const totalWeight = fillingWeight * qty;
                weightDisplay.textContent = `${formatNumber(totalWeight)} kg`;
            } else {
                weightDisplay.textContent = '-';
            }
        }
        
        if (amountDisplay) {
            if (unitPrice > 0 && fillingWeight > 0 && qty > 0) {
                const packingPrice = unitPrice * fillingWeight;
                const amount = packingPrice * qty;
                amountDisplay.textContent = `${currencySymbols[currency] || ''}${formatNumber(amount)}`;
            } else {
                amountDisplay.textContent = '-';
            }
        }
        
        updateTotals();
    }
    
    // ========================================
    // í•©ê³„ ì—…ë°ì´íŠ¸
    // ========================================
    function updateTotals() {
        let totalQty = 0;
        let totalWeight = 0;
        const amountsByCurrency = {};
        
        document.querySelectorAll('.item-form-row:not(.deleted)').forEach(row => {
            const qty = parseInt(row.querySelector('.qty-input')?.value) || 0;
            const fillingWeight = parseFloat(row.querySelector('.filling-weight')?.value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price')?.value) || 0;
            const currency = row.querySelector('.currency-value')?.value || 'KRW';
            
            totalQty += qty;
            
            if (fillingWeight > 0 && qty > 0) {
                totalWeight += fillingWeight * qty;
            }
            
            if (unitPrice > 0 && fillingWeight > 0 && qty > 0) {
                const amount = unitPrice * fillingWeight * qty;
                if (!amountsByCurrency[currency]) {
                    amountsByCurrency[currency] = 0;
                }
                amountsByCurrency[currency] += amount;
            }
        });
        
        document.getElementById('total-qty').textContent = formatNumber(totalQty);
        
        // ì´ ê¸ˆì•¡
        const amountParts = [];
        for (const [currency, amount] of Object.entries(amountsByCurrency)) {
            amountParts.push(`${currencySymbols[currency] || ''}${formatNumber(amount)} ${currency}`);
        }
        document.getElementById('total-amount').textContent = amountParts.length > 0 ? amountParts.join(' / ') : '-';
        
        // ì´ ì¤‘ëŸ‰
        document.getElementById('total-weight').textContent = totalWeight > 0 ? `${formatNumber(totalWeight)} kg` : '-';
    }
    
    // ========================================
    // ì´ˆê¸°í™”
    // ========================================
    loadProducts();
    
    document.querySelectorAll('.item-form-row').forEach(row => {
        initRowEvents(row);
    });
    
    updateTotals();
});
</script>
{% endblock %}
