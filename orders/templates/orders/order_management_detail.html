{% extends 'base.html' %}
{% load static %}
{% load order_extras %}

{% block title %}수주관리표 - {{ po.customer_order_no }} - CYNOW{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'orders:list' %}">수주</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'orders:management' %}">수주관리표</a></li>
                    <li class="breadcrumb-item active">{{ po.customer_order_no }}</li>
                </ol>
            </nav>
            <h2 class="mb-1">
                <i class="fas fa-clipboard-list me-2 text-primary"></i>
                {{ po.customer_order_no }}
            </h2>
            <p class="text-muted mb-0">
                <strong>{{ po.supplier_user_code }}</strong> / {{ po.supplier_user_name }}
                <span class="mx-2">|</span>
                수주일: {{ po.received_at|date:"Y-m-d" }}
            </p>
        </div>
        <div>
            <a href="{% url 'orders:planned_moves' po.customer_order_no %}" class="btn btn-primary">
                <i class="fas fa-file-export me-1"></i>가발행 이동서
            </a>
            <form action="{% url 'orders:sync_progress' po.customer_order_no %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-sync-alt me-1"></i>FCMS 동기화
                </button>
            </form>
            <a href="{% url 'orders:detail' po.customer_order_no %}" class="btn btn-outline-secondary">
                <i class="fas fa-file-alt me-1"></i>수주 상세
            </a>
            <a href="{% url 'orders:management' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>목록
            </a>
        </div>
    </div>

    <!-- 제품코드별 진척 현황 (핵심) -->
    {% for item_data in items_with_progress %}
    <div class="card mb-4 border-start border-4 {% if item_data.remaining_qty > 0 %}border-warning{% else %}border-success{% endif %}">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col">
                    <span class="badge bg-primary fs-6 me-2">{{ item_data.item.trade_condition_code }}</span>
                    <strong>{{ item_data.item.gas_name|default:"" }}</strong>
                    {% if item_data.item.cylinder_spec %}
                        <small class="text-muted ms-2">({{ item_data.item.cylinder_spec }} {{ item_data.item.valve_spec|default:"" }})</small>
                    {% endif %}
                </div>
                <div class="col-auto">
                    <span class="badge {% if item_data.remaining_qty > 0 %}bg-warning text-dark{% else %}bg-success{% endif %} fs-6 me-2">
                        수주: <strong>{{ item_data.ordered_qty }}</strong>병
                    </span>
                    <span class="badge bg-info fs-6 me-2">
                        발행: <strong>{{ item_data.issued_qty }}</strong>병
                    </span>
                    {% if item_data.remaining_qty > 0 %}
                    <span class="badge bg-danger fs-6">
                        잔여: <strong>{{ item_data.remaining_qty }}</strong>병
                    </span>
                    <a href="{% url 'orders:planned_moves' po.customer_order_no %}?item={{ item_data.item.pk }}&code={{ item_data.item.trade_condition_code }}" 
                       class="btn btn-sm btn-outline-primary ms-2" title="가발행 등록">
                        <i class="fas fa-plus"></i> 가발행
                    </a>
                    {% else %}
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-check me-1"></i>완료
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="mt-2">
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar {% if item_data.progress_percent >= 100 %}bg-success{% elif item_data.progress_percent >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
                         style="width: {{ item_data.progress_percent }}%;" 
                         title="{{ item_data.progress_percent }}% 발행됨"></div>
                </div>
                <small class="text-muted">발행률: {{ item_data.progress_percent }}%</small>
            </div>
        </div>
        
        {% if item_data.orders %}
        <div class="card-body p-0">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>이동서번호</th>
                        <th class="text-center">지시</th>
                        <th class="text-center">확정</th>
                        <th class="text-center">출하</th>
                        <th class="text-center">충전예정</th>
                        <th class="text-center">입고예정</th>
                        <th class="text-center">출하예정</th>
                        <th class="text-center">충전일</th>
                        <th class="text-center">출하일</th>
                        <th>충전LOT</th>
                        <th>수주메모</th>
                        <th>업무메모</th>
                        <th>제조메모</th>
                        <th class="text-center">상태</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in item_data.orders %}
                    <tr>
                        <td>
                            <a href="#" class="move-report-link text-decoration-none" 
                               data-move-report-no="{{ order.arrival_shipping_no }}">
                                <code class="text-success fw-bold">{{ order.arrival_shipping_no }}</code>
                            </a>
                        </td>
                        <td class="text-center">
                            <span class="fw-bold">{{ order.instruction_count }}</span>
                        </td>
                        <td class="text-center">
                            {% if order.confirmed_count %}
                                <span class="text-primary fw-bold">{{ order.confirmed_count }}</span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="text-center">
                            {% if order.shipped_count %}
                                <span class="text-success fw-bold">{{ order.shipped_count }}</span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="text-center">{{ order.filling_plan_date|date:"m/d"|default:"-" }}</td>
                        <td class="text-center">{{ order.warehousing_plan_date|date:"m/d"|default:"-" }}</td>
                        <td class="text-center">{{ order.shipping_plan_date|date:"m/d"|default:"-" }}</td>
                        <td class="text-center">
                            {% if order.filling_date %}
                                <span class="badge bg-warning text-dark">{{ order.filling_date|date:"m/d" }}</span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="text-center">
                            {% if order.shipping_date %}
                                <span class="badge bg-success">{{ order.shipping_date|date:"m/d" }}</span>
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if order.filling_lot_no %}
                                <code class="small">{{ order.filling_lot_no }}</code>
                            {% else %}-{% endif %}
                        </td>
                        <td class="small">{{ order.sales_remarks|default:"-" }}</td>
                        <td class="small">{{ order.business_remarks|default:"-" }}</td>
                        <td class="small">{{ order.production_remarks|default:"-" }}</td>
                        <td class="text-center">
                            <span class="status-badge" data-code="{{ order.last_move_code }}"></span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary">
                    <tr>
                        <td class="text-end fw-bold">합계</td>
                        <td class="text-center fw-bold text-primary">{{ item_data.issued_qty }}병</td>
                        <td colspan="12"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="card-body bg-light-subtle text-center py-4">
            <i class="fas fa-unlink fa-2x text-muted mb-2"></i>
            <p class="mb-2 text-muted">FCMS에 등록된 이동서가 없습니다</p>
            <a href="{% url 'orders:planned_moves' po.customer_order_no %}?item={{ item_data.item.pk }}&code={{ item_data.item.trade_condition_code }}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus me-1"></i>가발행 등록
            </a>
        </div>
        {% endif %}
    </div>
    {% empty %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
            <h5>등록된 품목이 없습니다</h5>
            <a href="{% url 'orders:edit' po.customer_order_no %}" class="btn btn-primary mt-2">
                <i class="fas fa-edit me-1"></i>수주 수정
            </a>
        </div>
    </div>
    {% endfor %}

    <!-- 안내 -->
    <div class="card mt-4 bg-light">
        <div class="card-body py-3">
            <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-1"></i>진행 흐름</h6>
            <div class="d-flex align-items-center flex-wrap">
                <span class="badge bg-secondary me-1">수주등록</span>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <span class="badge bg-primary me-1">가발행</span>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <span class="badge bg-info me-1">FCMS입력</span>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <span class="badge bg-warning text-dark me-1">충전</span>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <span class="badge bg-success me-1">입고/출하</span>
            </div>
        </div>
    </div>
</div>

<!-- 이동서 상세 모달 -->
<div class="modal fade" id="moveReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>이동서 상세: <span id="modalMoveReportNo"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 이동서 정보 -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <strong><i class="fas fa-info-circle me-1"></i>이동서 정보</strong>
                    </div>
                    <div class="card-body py-2">
                        <div class="row small">
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr><th style="width:100px">고객사</th><td id="modalSupplier">-</td></tr>
                                    <tr><th>제품</th><td id="modalItem">-</td></tr>
                                    <tr><th>포장</th><td id="modalPacking">-</td></tr>
                                    <tr><th>지시수량</th><td id="modalInstruction">-</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr><th style="width:100px">납기</th><td id="modalDelivery">-</td></tr>
                                    <tr><th>충전LOT</th><td id="modalLot">-</td></tr>
                                    <tr><th>충전일</th><td id="modalFillingDate">-</td></tr>
                                    <tr><th>출하일</th><td id="modalShippingDate">-</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row small mt-2">
                            <div class="col-md-4">
                                <span class="text-muted">충전예정:</span> <span id="modalFillingPlan">-</span>
                            </div>
                            <div class="col-md-4">
                                <span class="text-muted">입고예정:</span> <span id="modalWarehousingPlan">-</span>
                            </div>
                            <div class="col-md-4">
                                <span class="text-muted">출하예정:</span> <span id="modalShippingPlan">-</span>
                            </div>
                        </div>
                        <div id="modalRemarks" class="mt-2 small" style="display:none;">
                            <hr class="my-2">
                            <div id="modalSalesRemarks"></div>
                            <div id="modalBusinessRemarks"></div>
                            <div id="modalProductionRemarks"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 용기번호 리스트 -->
                <div class="card">
                    <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                        <strong><i class="fas fa-cylinder me-1"></i>용기번호 리스트</strong>
                        <span class="badge bg-primary" id="modalCylinderCount">0개</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="modalCylinderLoading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">로딩 중...</p>
                        </div>
                        <table class="table table-sm table-hover mb-0" id="modalCylinderTable" style="display:none;">
                            <thead class="table-secondary">
                                <tr>
                                    <th style="width:50px">#</th>
                                    <th>용기번호</th>
                                    <th style="width:100px" class="text-center">상태</th>
                                    <th style="width:140px">최종처리일시</th>
                                </tr>
                            </thead>
                            <tbody id="modalCylinderBody"></tbody>
                        </table>
                        <div id="modalNoCylinders" class="text-center py-4 text-muted" style="display:none;">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>연결된 용기가 없습니다</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<style>
.border-start.border-4 {
    border-left-width: 4px !important;
}
.progress {
    border-radius: 8px;
}
.move-report-link:hover code {
    text-decoration: underline;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('moveReportModal'));
    
    // 메인 테이블 상태 배지 초기화
    document.querySelectorAll('.status-badge').forEach(span => {
        const code = span.dataset.code;
        span.outerHTML = getMoveCodeBadge(code);
    });
    
    // 이동서 링크 클릭 이벤트
    document.querySelectorAll('.move-report-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const moveReportNo = this.dataset.moveReportNo;
            loadMoveReportDetail(moveReportNo);
        });
    });
    
    function loadMoveReportDetail(moveReportNo) {
        // 모달 초기화
        document.getElementById('modalMoveReportNo').textContent = moveReportNo;
        document.getElementById('modalCylinderLoading').style.display = 'block';
        document.getElementById('modalCylinderTable').style.display = 'none';
        document.getElementById('modalNoCylinders').style.display = 'none';
        
        modal.show();
        
        // API 호출
        fetch(`/cynow/orders/api/move-report/${moveReportNo}/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    modal.hide();
                    return;
                }
                
                const mr = data.move_report;
                
                // 이동서 정보 표시
                document.getElementById('modalSupplier').textContent = mr.supplier_user_name || '-';
                document.getElementById('modalItem').textContent = mr.item_name || '-';
                document.getElementById('modalPacking').textContent = mr.packing_name || '-';
                document.getElementById('modalInstruction').textContent = mr.instruction_count ? `${mr.instruction_count}병` : '-';
                document.getElementById('modalDelivery').textContent = mr.delivery_date || '-';
                document.getElementById('modalLot').innerHTML = mr.filling_lot_no ? `<code>${mr.filling_lot_no}</code>` : '-';
                document.getElementById('modalFillingDate').innerHTML = mr.filling_date ? 
                    `<span class="badge bg-warning text-dark">${mr.filling_date}</span>` : '-';
                document.getElementById('modalShippingDate').innerHTML = mr.shipping_date ? 
                    `<span class="badge bg-success">${mr.shipping_date}</span>` : '-';
                
                document.getElementById('modalFillingPlan').textContent = mr.filling_plan_date || '-';
                document.getElementById('modalWarehousingPlan').textContent = mr.warehousing_plan_date || '-';
                document.getElementById('modalShippingPlan').textContent = mr.shipping_plan_date || '-';
                
                // 메모
                const remarksDiv = document.getElementById('modalRemarks');
                const hasRemarks = mr.sales_remarks || mr.business_remarks || mr.production_remarks;
                remarksDiv.style.display = hasRemarks ? 'block' : 'none';
                document.getElementById('modalSalesRemarks').innerHTML = mr.sales_remarks ? 
                    `<span class="badge bg-primary me-1">수주</span>${mr.sales_remarks}` : '';
                document.getElementById('modalBusinessRemarks').innerHTML = mr.business_remarks ? 
                    `<span class="badge bg-secondary me-1">업무</span>${mr.business_remarks}` : '';
                document.getElementById('modalProductionRemarks').innerHTML = mr.production_remarks ? 
                    `<span class="badge bg-dark me-1">제조</span>${mr.production_remarks}` : '';
                
                // 용기 리스트
                document.getElementById('modalCylinderLoading').style.display = 'none';
                const cylinders = data.cylinders || [];
                document.getElementById('modalCylinderCount').textContent = `${cylinders.length}개`;
                
                if (cylinders.length === 0) {
                    document.getElementById('modalNoCylinders').style.display = 'block';
                } else {
                    document.getElementById('modalCylinderTable').style.display = 'table';
                    const tbody = document.getElementById('modalCylinderBody');
                    tbody.innerHTML = '';
                    
                    cylinders.forEach((cyl, idx) => {
                        const moveCodeBadge = getMoveCodeBadge(cyl.last_move_code);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="text-muted">${idx + 1}</td>
                            <td><code class="fw-bold">${cyl.cylinder_no}</code></td>
                            <td class="text-center">${moveCodeBadge}</td>
                            <td class="small text-muted">${cyl.last_move_date || '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            })
            .catch(err => {
                console.error(err);
                alert('이동서 정보를 불러오는데 실패했습니다.');
                modal.hide();
            });
    }
    
    function getMoveCodeBadge(code) {
        const codes = {
            '00': ['신규구매', 'bg-secondary'],
            '01': ['신규등록', 'bg-secondary'],
            '10': ['입하', 'bg-info'],
            '14': ['회수완료', 'bg-secondary'],
            '16': ['회수없음', 'bg-secondary'],
            '17': ['재보관', 'bg-secondary'],
            '21': ['충전선택', 'bg-warning text-dark'],
            '22': ['충전완료', 'bg-warning text-dark'],
            '30': ['창고출고', 'bg-secondary'],
            '31': ['외부충전', 'bg-warning text-dark'],
            '41': ['분석중', 'bg-primary'],
            '42': ['분석완료', 'bg-info'],
            '50': ['창고입고', 'bg-primary'],
            '51': ['수주연결', 'bg-primary'],
            '52': ['연결해제', 'bg-secondary'],
            '60': ['출하', 'bg-success'],
            '65': ['영업외출하', 'bg-success'],
            '70': ['반품', 'bg-danger'],
            '85': ['전출', 'bg-secondary'],
            '86': ['전입', 'bg-secondary'],
            '99': ['폐기', 'bg-dark'],
        };
        if (!code) return '<span class="badge bg-light text-dark">-</span>';
        const [label, cls] = codes[code] || [code, 'bg-secondary'];
        return `<span class="badge ${cls}">${label}</span>`;
    }
});
</script>
{% endblock %}
