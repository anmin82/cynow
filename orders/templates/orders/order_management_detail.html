{% extends 'base.html' %}
{% load static %}
{% load order_extras %}

{% block title %}수주관리표 - {{ po.customer_order_no }} - CYNOW{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'orders:list' %}">수주</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'orders:management' %}">수주관리표</a></li>
                    <li class="breadcrumb-item active">{{ po.customer_order_no }}</li>
                </ol>
            </nav>
            <h2 class="mb-1">
                <i class="fas fa-clipboard-list me-2 text-primary"></i>
                {{ po.customer_order_no }}
            </h2>
            <p class="text-muted mb-0">
                <strong>{{ po.supplier_user_code }}</strong> / {{ po.supplier_user_name }}
                <span class="mx-2">|</span>
                수주일: {{ po.received_at|date:"Y-m-d" }}
            </p>
        </div>
        <div>
            <a href="{% url 'orders:planned_moves' po.customer_order_no %}" class="btn btn-primary">
                <i class="fas fa-file-export me-1"></i>가발행 이동서
            </a>
            <form action="{% url 'orders:sync_progress' po.customer_order_no %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-sync-alt me-1"></i>FCMS 동기화
                </button>
            </form>
            <a href="{% url 'orders:detail' po.customer_order_no %}" class="btn btn-outline-secondary">
                <i class="fas fa-file-alt me-1"></i>수주 상세
            </a>
            <a href="{% url 'orders:management' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>목록
            </a>
        </div>
    </div>

    <!-- 제품코드별 진척 현황 (핵심) -->
    {% for item_data in items_with_progress %}
    <div class="card mb-4 border-start border-4 {% if item_data.remaining_qty > 0 %}border-warning{% else %}border-success{% endif %}">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col">
                    <span class="badge bg-primary fs-6 me-2">{{ item_data.item.trade_condition_code }}</span>
                    <strong>{{ item_data.item.gas_name|default:"" }}</strong>
                    {% if item_data.item.cylinder_spec %}
                        <small class="text-muted ms-2">({{ item_data.item.cylinder_spec }} {{ item_data.item.valve_spec|default:"" }})</small>
                    {% endif %}
                </div>
                <div class="col-auto">
                    <span class="badge {% if item_data.remaining_qty > 0 %}bg-warning text-dark{% else %}bg-success{% endif %} fs-6 me-2">
                        수주: <strong>{{ item_data.ordered_qty }}</strong>병
                    </span>
                    <span class="badge bg-info fs-6 me-2">
                        발행: <strong>{{ item_data.issued_qty }}</strong>병
                    </span>
                    {% if item_data.remaining_qty > 0 %}
                    <span class="badge bg-danger fs-6">
                        잔여: <strong>{{ item_data.remaining_qty }}</strong>병
                    </span>
                    <a href="{% url 'orders:planned_moves' po.customer_order_no %}?item={{ item_data.item.pk }}&code={{ item_data.item.trade_condition_code }}" 
                       class="btn btn-sm btn-outline-primary ms-2" title="가발행 등록">
                        <i class="fas fa-plus"></i> 가발행
                    </a>
                    {% else %}
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-check me-1"></i>완료
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="mt-2">
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar {% if item_data.progress_percent >= 100 %}bg-success{% elif item_data.progress_percent >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
                         style="width: {{ item_data.progress_percent }}%;" 
                         title="{{ item_data.progress_percent }}% 발행됨"></div>
                </div>
                <small class="text-muted">발행률: {{ item_data.progress_percent }}%</small>
            </div>
        </div>
        
        {% if item_data.orders %}
        <div class="card-body p-0">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>이동서번호</th>
                        <th class="text-center">지시</th>
                        <th class="text-center">충전예정</th>
                        <th class="text-center">입고예정</th>
                        <th class="text-center">출하예정</th>
                        <th class="text-center">충전일</th>
                        <th class="text-center">출하일</th>
                        <th>충전LOT</th>
                        <th>수주메모</th>
                        <th>업무메모</th>
                        <th>제조메모</th>
                        <th class="text-center">상태</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in item_data.orders %}
                    <tr>
                        <td>
                            <code class="text-success fw-bold">{{ order.arrival_shipping_no }}</code>
                        </td>
                        <td class="text-center">
                            <span class="fw-bold">{{ order.instruction_count }}</span>
                        </td>
                        <td class="text-center">{{ order.filling_plan_date|date:"m/d"|default:"-" }}</td>
                        <td class="text-center">{{ order.warehousing_plan_date|date:"m/d"|default:"-" }}</td>
                        <td class="text-center">{{ order.shipping_plan_date|date:"m/d"|default:"-" }}</td>
                        <td class="text-center">
                            {% if order.filling_date %}
                                <span class="badge bg-warning text-dark">{{ order.filling_date|date:"m/d" }}</span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="text-center">
                            {% if order.shipping_date %}
                                <span class="badge bg-success">{{ order.shipping_date|date:"m/d" }}</span>
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if order.filling_lot_no %}
                                <code class="small">{{ order.filling_lot_no }}</code>
                            {% else %}-{% endif %}
                        </td>
                        <td class="small">{{ order.sales_remarks|default:"-" }}</td>
                        <td class="small">{{ order.business_remarks|default:"-" }}</td>
                        <td class="small">{{ order.production_remarks|default:"-" }}</td>
                        <td class="text-center">
                            {% if order.shipping_date %}
                                <span class="badge bg-success">출하</span>
                            {% elif order.filling_date %}
                                <span class="badge bg-warning text-dark">충전</span>
                            {% else %}
                                <span class="badge bg-info">등록</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary">
                    <tr>
                        <td class="text-end fw-bold">합계</td>
                        <td class="text-center fw-bold text-primary">{{ item_data.issued_qty }}병</td>
                        <td colspan="10"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="card-body bg-light-subtle text-center py-4">
            <i class="fas fa-unlink fa-2x text-muted mb-2"></i>
            <p class="mb-2 text-muted">FCMS에 등록된 이동서가 없습니다</p>
            <a href="{% url 'orders:planned_moves' po.customer_order_no %}?item={{ item_data.item.pk }}&code={{ item_data.item.trade_condition_code }}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus me-1"></i>가발행 등록
            </a>
        </div>
        {% endif %}
    </div>
    {% empty %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
            <h5>등록된 품목이 없습니다</h5>
            <a href="{% url 'orders:edit' po.customer_order_no %}" class="btn btn-primary mt-2">
                <i class="fas fa-edit me-1"></i>수주 수정
            </a>
        </div>
    </div>
    {% endfor %}

    <!-- 안내 -->
    <div class="card mt-4 bg-light">
        <div class="card-body py-3">
            <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-1"></i>진행 흐름</h6>
            <div class="d-flex align-items-center flex-wrap">
                <span class="badge bg-secondary me-1">수주등록</span>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <span class="badge bg-primary me-1">가발행</span>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <span class="badge bg-info me-1">FCMS입력</span>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <span class="badge bg-warning text-dark me-1">충전</span>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <span class="badge bg-success me-1">입고/출하</span>
            </div>
        </div>
    </div>
</div>

<style>
.border-start.border-4 {
    border-left-width: 4px !important;
}
.progress {
    border-radius: 8px;
}
</style>
{% endblock %}
