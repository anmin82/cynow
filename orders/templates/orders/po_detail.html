{% extends "base.html" %}
{% load timezone_tags %}
{% load humanize %}

{% block title %}수주 상세 - {{ po.customer_order_no }}{% endblock %}

{% block extra_css %}
<style>
    /* 기본 스타일 */
    .info-table th {
        width: 140px;
        background: #f8f9fa;
        font-weight: 500;
    }
    
    /* 품목 테이블 */
    .items-table {
        font-size: 0.9rem;
    }
    .items-table th {
        background: #f8f9fa;
        font-weight: 500;
        white-space: nowrap;
    }
    .items-table td {
        vertical-align: middle;
    }
    
    /* 통화 배지 */
    .currency-badge {
        font-size: 0.75rem;
    }
    .currency-krw { color: #28a745; }
    .currency-jpy { color: #f0ad4e; }
    .currency-usd { color: #0d6efd; }
    
    /* 합계 행 */
    .totals-row {
        background: #e7f3ff !important;
        font-weight: 600;
    }
    .totals-row td {
        border-top: 2px solid #0d6efd;
    }
    
    /* 스펙 표시 */
    .spec-text {
        font-size: 0.8rem;
        color: #888;
    }
    
    /* 금액 표시 */
    .amount-display {
        font-weight: 600;
        color: #28a745;
    }
    
    /* 가이드 카드 */
    .guide-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0d6efd;
    }
    
    /* 인쇄 스타일 */
    @media print {
        .no-print { display: none !important; }
        
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body { 
            background: white !important;
            font-size: 9pt !important;
            line-height: 1.3 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
        }
        
        .row { margin: 0 !important; }
        .col-lg-8 { width: 100% !important; max-width: 100% !important; flex: 0 0 100% !important; }
        .col-lg-4 { display: none !important; }
        
        .card { 
            box-shadow: none !important;
            border: none !important;
            margin-bottom: 10px !important;
        }
        .card-header {
            background: #333 !important;
            color: white !important;
            padding: 5px 10px !important;
            font-size: 10pt !important;
        }
        .card-body {
            padding: 10px !important;
        }
        
        .main-container { padding: 0 !important; }
        .navbar, nav.breadcrumb, .breadcrumb { display: none !important; }
        
        /* 인쇄 헤더 */
        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px double #333;
        }
        .print-header h1 {
            font-size: 20pt;
            font-weight: bold;
            margin: 0 0 5px 0;
        }
        .print-header p {
            font-size: 9pt;
            margin: 0;
            color: #333;
        }
        
        /* 기본 정보 테이블 */
        .info-table {
            font-size: 9pt !important;
        }
        .info-table th {
            width: 80px !important;
            padding: 3px 8px !important;
            background: #f0f0f0 !important;
        }
        .info-table td {
            padding: 3px 8px !important;
        }
        
        /* 품목 테이블 - 핵심 */
        .items-table {
            font-size: 8pt !important;
            width: 100% !important;
        }
        .items-table th {
            background: #e0e0e0 !important;
            padding: 4px 5px !important;
            font-size: 8pt !important;
            white-space: nowrap !important;
            border: 1px solid #999 !important;
        }
        .items-table td {
            padding: 3px 5px !important;
            border: 1px solid #ccc !important;
            vertical-align: middle !important;
        }
        .items-table .spec-text {
            font-size: 7pt !important;
        }
        
        /* 합계 행 */
        .totals-row {
            background: #f5f5f5 !important;
        }
        .totals-row td {
            border-top: 2px solid #333 !important;
            font-weight: bold !important;
        }
        
        /* 인쇄 푸터 */
        .print-footer {
            display: block !important;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
            text-align: center;
            font-size: 8pt;
            color: #666;
        }
        
        @page {
            size: A4;
            margin: 12mm 10mm;
        }
    }
    
    .print-header { display: none; }
    .print-footer { display: none; }
    .print-summary { display: none; }
    
    @media print {
        .print-summary { display: block !important; }
    }
</style>
{% endblock %}

{% block content %}
<!-- 인쇄용 헤더 -->
<div class="print-header">
    <h1>수 주 확 인 서</h1>
    <table style="width: 100%; margin-top: 10px; font-size: 10pt;">
        <tr>
            <td style="text-align: left;"><strong>KDFPK Co., Ltd.</strong></td>
            <td style="text-align: right;">발행일: {% now "Y년 m월 d일" %}</td>
        </tr>
    </table>
</div>

<div class="container-fluid mt-4">
    <!-- 헤더 -->
    <div class="row mb-3 no-print">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'orders:list' %}">수주 목록</a></li>
                    <li class="breadcrumb-item active">{{ po.customer_order_no }}</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center gap-3">
                <h2 class="mb-0">수주 상세</h2>
                {% if po.status == 'DRAFT' %}
                    <span class="badge bg-secondary fs-6">{{ po.get_status_display }}</span>
                {% elif po.status == 'GUIDED' %}
                    <span class="badge bg-info fs-6">{{ po.get_status_display }}</span>
                {% elif po.status == 'MATCHED' %}
                    <span class="badge bg-success fs-6">{{ po.get_status_display }}</span>
                {% elif po.status == 'IN_PROGRESS' %}
                    <span class="badge bg-primary fs-6">{{ po.get_status_display }}</span>
                {% elif po.status == 'COMPLETED' %}
                    <span class="badge bg-dark fs-6">{{ po.get_status_display }}</span>
                {% endif %}
            </div>
        </div>
        <div class="col-auto">
            <button onclick="window.print()" class="btn btn-outline-secondary">
                <i class="bi bi-printer"></i> 인쇄
            </button>
            <button type="button"
                    class="btn btn-outline-warning btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#editModal"
                    title="수정">
                <i class="bi bi-pencil"></i>
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>

    <div class="row">
        <!-- 좌측: 수주 정보 + 품목 -->
        <div class="col-lg-8">
            <!-- 기본 정보 -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>기본 정보</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm info-table mb-0">
                                <tbody>
                                    <tr>
                                        <th>PO번호</th>
                                        <td><strong class="text-primary">{{ po.customer_order_no }}</strong></td>
                                    </tr>
                                    <tr>
                                        <th>고객코드</th>
                                        <td><code>{{ po.supplier_user_code }}</code></td>
                                    </tr>
                                    <tr>
                                        <th>고객명</th>
                                        <td>{{ po.supplier_user_name|default:"-" }}</td>
                                    </tr>
                                    <tr>
                                        <th>수주일시</th>
                                        <td>{{ po.received_at|date:"Y-m-d" }}</td>
                                    </tr>
                                    <tr>
                                        <th>납기</th>
                                        <td>
                                            <span class="badge bg-info">{{ po.delivery_summary }}</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm info-table mb-0">
                                <tbody>
                                    <tr>
                                        <th>작성자</th>
                                        <td>{{ po.created_by|default:"-" }}</td>
                                    </tr>
                                    <tr>
                                        <th>생성일시</th>
                                        <td>{{ po.created_at|kst|date:"Y-m-d H:i:s" }}</td>
                                    </tr>
                                    <tr>
                                        <th>수정일시</th>
                                        <td>{{ po.updated_at|kst|date:"Y-m-d H:i:s" }}</td>
                                    </tr>
                                    <tr>
                                        <th>메모</th>
                                        <td>{{ po.memo|default:"-"|linebreaksbr }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 수주 품목 -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>수주 품목</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 items-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">No</th>
                                    <th style="width: 80px;">제품코드</th>
                                    <th>품명/스펙</th>
                                    <th class="text-center" style="width: 50px;">충전</th>
                                    <th class="text-center" style="width: 50px;">수량</th>
                                    <th style="width: 60px;">납기</th>
                                    <th class="text-end" style="width: 80px;">단가</th>
                                    <th class="text-end" style="width: 90px;">금액</th>
                                    <th class="text-center" style="width: 60px;">중량</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td class="text-center">{{ item.line_no }}</td>
                                    <td><code>{{ item.trade_condition_code }}</code></td>
                                    <td>
                                        <strong>{{ item.trade_condition_name|default:item.gas_name|default:"-" }}</strong>
                                        {% if item.cylinder_spec or item.valve_spec %}
                                        <br><span class="spec-text">{{ item.cylinder_spec|default:"" }}{% if item.valve_spec %} / {{ item.valve_spec }}{% endif %}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{% if item.filling_weight %}{{ item.filling_weight|floatformat:0 }}{% else %}-{% endif %}</td>
                                    <td class="text-center"><strong>{{ item.qty }}</strong></td>
                                    <td class="text-center">{% if item.delivery_date %}{{ item.delivery_date|date:"m/d" }}{% else %}분납{% endif %}</td>
                                    <td class="text-end">{% if item.unit_price %}{{ item.unit_price|floatformat:0|intcomma }}{% else %}-{% endif %}</td>
                                    <td class="text-end"><strong>{% if item.amount %}{{ item.amount|floatformat:0|intcomma }}{% else %}-{% endif %}</strong></td>
                                    <td class="text-center">{% if item.total_weight %}{{ item.total_weight|floatformat:0 }}{% else %}-{% endif %}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">
                                        등록된 품목이 없습니다.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="totals-row">
                                    <td colspan="4" class="text-end">합계</td>
                                    <td class="text-center"><strong>{{ po.total_qty }}</strong></td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-end"><strong>{% if po.total_amount_display %}{{ po.total_amount_display }}{% else %}-{% endif %}</strong></td>
                                    <td class="text-center"><strong>{% if po.total_weight %}{{ po.total_weight|floatformat:0 }}{% else %}-{% endif %}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 우측: 가이드 및 매칭 -->
        <div class="col-lg-4 no-print">
            <!-- FCMS 매칭 상태 -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>FCMS 매칭</h5>
                    <form method="post" action="{% url 'orders:check_match' po.customer_order_no %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-secondary">
                            <i class="bi bi-arrow-repeat"></i> 확인
                        </button>
                    </form>
                </div>
                <div class="card-body">
                    {% if match_status %}
                        <div class="text-center py-2">
                            {% if match_status.match_state == 'MATCHED' %}
                                <span class="badge bg-success fs-6">매칭완료</span>
                            {% elif match_status.match_state == 'NOT_ENTERED' %}
                                <span class="badge bg-warning fs-6">미입력</span>
                            {% elif match_status.match_state == 'MISMATCH' %}
                                <span class="badge bg-danger fs-6">번호불일치</span>
                            {% endif %}
                        </div>
                        
                        <table class="table table-sm mt-3 mb-0">
                            <tbody>
                                {% if match_status.fcms_arrival_shipping_no %}
                                <tr>
                                    <th width="50%">도착출하번호</th>
                                    <td><code>{{ match_status.fcms_arrival_shipping_no }}</code></td>
                                </tr>
                                {% endif %}
                                {% if match_status.fcms_move_report_no %}
                                <tr>
                                    <th>이동서번호</th>
                                    <td><code>{{ match_status.fcms_move_report_no }}</code></td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>최종 확인</th>
                                    <td>{{ match_status.last_checked_at|kst|date:"Y-m-d H:i" }}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        {% if match_status.note %}
                        <div class="mt-2 small text-muted">
                            {{ match_status.note }}
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-link-45deg" style="font-size: 2rem; opacity: 0.3;"></i>
                            <p class="mt-2 mb-0">아직 매칭을 확인하지 않았습니다.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- 수주 요약 (제품코드별) -->
            <div class="card mb-3 bg-light">
                <div class="card-body">
                    <h6 class="text-muted mb-3"><i class="bi bi-box-seam me-2"></i>수주 요약</h6>
                    <table class="table table-sm mb-2" style="font-size: 0.85rem;">
                        <thead>
                            <tr class="text-muted">
                                <th style="width: 35%;">제품코드</th>
                                <th class="text-end" style="width: 25%;">수량</th>
                                <th class="text-end" style="width: 40%;">중량</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td>
                                    <code class="small">{{ item.trade_condition_code }}</code>
                                </td>
                                <td class="text-end fw-bold">{{ item.qty }}</td>
                                <td class="text-end">
                                    {% if item.total_weight %}
                                        {{ item.total_weight|floatformat:0 }} kg
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">품목 없음</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="border-top">
                            <tr class="fw-bold">
                                <td>합계</td>
                                <td class="text-end">{{ po.total_qty }}</td>
                                <td class="text-end">
                                    {% if po.total_weight %}{{ po.total_weight|floatformat:0 }} kg{% else %}-{% endif %}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    {% if po.total_amount_display %}
                    <div class="text-end pt-2 border-top">
                        <span class="text-muted small">총 금액:</span>
                        <span class="fw-bold text-success">{{ po.total_amount_display }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- 인쇄용 요약 (화면에서는 숨김) -->
    <div class="print-summary" style="display: none;">
        <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
            <tr>
                <td style="width: 50%; vertical-align: top; padding-right: 20px;">
                    <table style="width: 100%; font-size: 9pt; border: 1px solid #333;">
                        <tr style="background: #f0f0f0;">
                            <th colspan="2" style="padding: 5px; text-align: center; border-bottom: 1px solid #333;">수주 정보</th>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; width: 80px; background: #f9f9f9;">PO번호</td>
                            <td style="padding: 4px 8px; font-weight: bold;">{{ po.customer_order_no }}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; background: #f9f9f9;">고객</td>
                            <td style="padding: 4px 8px;">{{ po.supplier_user_code }} / {{ po.supplier_user_name|default:"-" }}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; background: #f9f9f9;">수주일</td>
                            <td style="padding: 4px 8px;">{{ po.received_at|date:"Y-m-d" }}</td>
                        </tr>
                    </table>
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <table style="width: 100%; font-size: 9pt; border: 1px solid #333;">
                        <tr style="background: #f0f0f0;">
                            <th colspan="2" style="padding: 5px; text-align: center; border-bottom: 1px solid #333;">합계</th>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; width: 80px; background: #f9f9f9;">총 수량</td>
                            <td style="padding: 4px 8px; font-weight: bold; text-align: right;">{{ po.total_qty }} 병</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; background: #f9f9f9;">총 중량</td>
                            <td style="padding: 4px 8px; font-weight: bold; text-align: right;">{% if po.total_weight %}{{ po.total_weight|floatformat:1 }} kg{% else %}-{% endif %}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; background: #f9f9f9;">총 금액</td>
                            <td style="padding: 4px 8px; font-weight: bold; text-align: right;">{% if po.total_amount_display %}{{ po.total_amount_display }}{% else %}-{% endif %}</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>
    
    <!-- 인쇄용 푸터 -->
    <div class="print-footer">
        본 수주확인서는 CYNOW 시스템에서 자동 생성되었습니다. | KDFPK Co., Ltd.
    </div>
</div>

<!-- 수정 확인(잠금 해제) 모달 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="bi bi-pencil-square me-2"></i>수주 수정
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'orders:edit_unlock' po.customer_order_no %}" id="editUnlockForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>확인:</strong> 수정은 실수 방지를 위해 한 번 더 확인합니다.<br>
                        수정을 진행하려면 PO번호를 한 번 더 입력해 주세요.
                    </div>

                    <div class="mb-3">
                        <label class="form-label">수정을 진행하려면 PO번호를 입력하세요:</label>
                        <input type="text" class="form-control" id="confirmPoNumberEdit" name="confirm_customer_order_no"
                               placeholder="{{ po.customer_order_no }}" autocomplete="off" required>
                        <div class="form-text">정확히 <code>{{ po.customer_order_no }}</code>를 입력하세요.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-warning" id="editBtn" disabled>
                        <i class="bi bi-pencil me-1"></i>수정 진행
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>수주 삭제
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'orders:delete' po.customer_order_no %}" id="deleteForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>경고!</strong> 이 작업은 되돌릴 수 없습니다.<br>
                        수주 <strong>{{ po.customer_order_no }}</strong>와 모든 품목 정보가 영구적으로 삭제됩니다.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">삭제를 확인하려면 PO번호를 입력하세요:</label>
                        <input type="text" class="form-control" id="confirmPoNumber" 
                               placeholder="{{ po.customer_order_no }}" autocomplete="off">
                        <div class="form-text">정확히 <code>{{ po.customer_order_no }}</code>를 입력하세요.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-danger" id="deleteBtn" disabled>
                        <i class="bi bi-trash me-1"></i>삭제
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmInput = document.getElementById('confirmPoNumber');
    const deleteBtn = document.getElementById('deleteBtn');
    const editConfirmInput = document.getElementById('confirmPoNumberEdit');
    const editBtn = document.getElementById('editBtn');
    const expectedValue = '{{ po.customer_order_no }}';
    
    if (confirmInput && deleteBtn) {
        confirmInput.addEventListener('input', function() {
            deleteBtn.disabled = this.value !== expectedValue;
        });
    }

    function updateEditButtonState() {
        const poOk = (editConfirmInput.value || '').trim() === expectedValue;
        editBtn.disabled = !poOk;
    }

    if (editConfirmInput && editBtn) {
        editConfirmInput.addEventListener('input', updateEditButtonState);
    }
});
</script>
{% endblock %}
