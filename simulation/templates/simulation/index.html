{% extends 'base.html' %}
{% load humanize %}

{% block title %}ìš©ê¸° ì‚¬ì´í´ ì‹œë®¬ë ˆì´ì…˜ - CYNOW{% endblock %}

{% block extra_head %}
<!-- ApexCharts will be loaded in extra_js -->
{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="page-title">ğŸ”„ ìš©ê¸° ì‚¬ì´í´ ì‹œë®¬ë ˆì´ì…˜</h1>
    <p class="page-subtitle">CYLINDER LIFECYCLE â€¢ ì¶œí•˜/íšŒìˆ˜/íˆ¬ì… ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì¸¡</p>
</div>

<!-- ìš©ê¸°ì¢…ë¥˜ ì„ íƒ (í•­ìƒ í‘œì‹œ) -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="row align-items-center">
            <div class="col-auto">
                <label class="form-label mb-0 fw-bold"><i class="bi bi-box-seam me-2"></i>ìš©ê¸°ì¢…ë¥˜</label>
            </div>
            <div class="col-md-4">
                <select id="cylinderTypeSelect" class="form-select">
                    <option value="">-- ìš©ê¸°ì¢…ë¥˜ ì„ íƒ --</option>
                    {% for ct in cylinder_types %}
                    <option value="{{ ct.cylinder_type_key }}" 
                            data-gas="{{ ct.gas_name }}"
                            data-capacity="{{ ct.capacity }}">
                        {{ ct.display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="simMode" id="modeBasic" checked>
                    <label class="btn btn-outline-primary" for="modeBasic">
                        <i class="bi bi-sliders me-1"></i>ê¸°ë³¸ ëª¨ë“œ
                    </label>
                    <input type="radio" class="btn-check" name="simMode" id="modeMatrix">
                    <label class="btn btn-outline-primary" for="modeMatrix">
                        <i class="bi bi-table me-1"></i>ë§¤íŠ¸ë¦­ìŠ¤ ëª¨ë“œ
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ê¸°ë³¸ ëª¨ë“œ ==================== -->
<div id="basicModePanel">
    <div class="row g-4">
        <!-- ì¢Œì¸¡: ì„¤ì • íŒ¨ë„ -->
        <div class="col-lg-4">
            <!-- í˜„ì¬ ì¬ê³  í˜„í™© -->
            <div class="card mb-3" id="currentInventoryCard" style="display: none;">
                <div class="card-header">
                    <i class="bi bi-pie-chart me-2"></i>í˜„ì¬ ì¬ê³  í˜„í™©
                </div>
                <div class="card-body">
                    <div class="row g-2 text-center">
                        <div class="col-6">
                            <div class="inventory-stat available">
                                <div class="stat-value" id="currentAvailable">-</div>
                                <div class="stat-label">ê°€ìš©ì¬ê³ </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="inventory-stat enduser">
                                <div class="stat-value" id="currentEnduser">-</div>
                                <div class="stat-label">ì—”ë“œìœ ì €</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="inventory-stat repair">
                                <div class="stat-value" id="currentRepair">-</div>
                                <div class="stat-label">ì •ë¹„ëŒ€ê¸°</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="inventory-stat expired">
                                <div class="stat-value" id="currentExpired">-</div>
                                <div class="stat-label">ë‚´ì••ë§Œë£Œ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íšŒìˆ˜ ì˜ˆì¸¡ ì„¤ì • -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-arrow-return-left me-2"></i>íšŒìˆ˜ ì˜ˆì¸¡ ì„¤ì •
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="recoveryMethod" 
                                   id="methodFixedRate" value="fixed_rate" checked>
                            <label class="form-check-label" for="methodFixedRate">ê³ ì • ë¹„ìœ¨</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="recoveryMethod" 
                                   id="methodHistorical" value="historical">
                            <label class="form-check-label" for="methodHistorical">ê³¼ê±° ì‹¤ì  ê¸°ë°˜</label>
                        </div>
                    </div>

                    <div id="fixedRateSettings">
                        <div class="mb-3">
                            <label class="form-label">íšŒìˆ˜ìœ¨</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range flex-grow-1" id="recoveryRateSlider" 
                                       min="0" max="100" value="80">
                                <span class="badge bg-primary" id="recoveryRateValue">80%</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">íšŒìˆ˜ ë¦¬ë“œíƒ€ì„</label>
                            <select id="recoveryLeadMonths" class="form-select form-select-sm">
                                <option value="1">1ê°œì›”</option>
                                <option value="2" selected>2ê°œì›”</option>
                                <option value="3">3ê°œì›”</option>
                                <option value="4">4ê°œì›”</option>
                                <option value="6">6ê°œì›”</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íˆ¬ì… ì¡°ì ˆ -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-sliders me-2"></i>íˆ¬ì… ì¡°ì ˆ
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>ì‹ ê·œ êµ¬ë§¤ ë°°ìˆ˜</span>
                            <span class="text-primary fw-bold" id="purchaseMultValue">1.0x</span>
                        </label>
                        <input type="range" class="form-range" id="purchaseMultiplier" 
                               min="0" max="2" step="0.1" value="1">
                    </div>
                    <div class="mb-0">
                        <label class="form-label d-flex justify-content-between">
                            <span>ì •ë¹„ íˆ¬ì… ë°°ìˆ˜</span>
                            <span class="text-primary fw-bold" id="repairMultValue">1.0x</span>
                        </label>
                        <input type="range" class="form-range" id="repairMultiplier" 
                               min="0" max="2" step="0.1" value="1">
                    </div>
                </div>
            </div>

            <button class="btn btn-primary w-100 btn-lg" id="simulateBtn" disabled>
                <i class="bi bi-play-fill me-2"></i>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
            </button>
        </div>

        <!-- ìš°ì¸¡: ê·¸ë˜í”„ ë° ê²°ê³¼ -->
        <div class="col-lg-8">
            {% include 'simulation/_chart_panel.html' %}
        </div>
    </div>
</div>

<!-- ==================== ë§¤íŠ¸ë¦­ìŠ¤ ëª¨ë“œ ==================== -->
<div id="matrixModePanel" style="display: none;">
    <div class="row g-3">
        <!-- ê·¸ë˜í”„ (ìƒë‹¨) -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <span><i class="bi bi-graph-up me-2"></i>ì‹¤ì‹œê°„ ì¬ê³  ì˜ˆì¸¡</span>
                    <small class="text-muted">ìˆ«ìë¥¼ ë³€ê²½í•˜ë©´ ì¦‰ì‹œ ê·¸ë˜í”„ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</small>
                </div>
                <div class="card-body py-2">
                    <div id="matrixChart" style="min-height: 280px;"></div>
                </div>
            </div>
        </div>

        <!-- í¸ì§‘ ê°€ëŠ¥í•œ ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸” -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-pencil-square me-2"></i>ì›”ë³„ ë°ì´í„° ì…ë ¥</span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="loadPlanData()">
                            <i class="bi bi-download me-1"></i>ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="resetMatrix()">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0 matrix-edit-table" id="matrixTable">
                            <thead>
                                <tr>
                                    <th class="sticky-col">í•­ëª©</th>
                                    <!-- ì›” ì»¬ëŸ¼ì€ JSì—ì„œ ë™ì  ìƒì„± -->
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-row="ship">
                                    <td class="sticky-col row-label"><span class="badge bg-danger">ì¶œí•˜</span> ì¶œí•˜ ìˆ˜ëŸ‰</td>
                                </tr>
                                <tr data-row="fill">
                                    <td class="sticky-col row-label"><span class="badge bg-purple">ì¶©ì „</span> ì¶©ì „ ìˆ˜ëŸ‰</td>
                                </tr>
                                <tr data-row="recover">
                                    <td class="sticky-col row-label"><span class="badge bg-success">íšŒìˆ˜</span> íšŒìˆ˜ ìˆ˜ëŸ‰</td>
                                </tr>
                                <tr data-row="purchase">
                                    <td class="sticky-col row-label"><span class="badge bg-primary">êµ¬ë§¤</span> ì‹ ê·œ êµ¬ë§¤</td>
                                </tr>
                                <tr data-row="repair">
                                    <td class="sticky-col row-label"><span class="badge bg-info">ì •ë¹„</span> ì •ë¹„ íˆ¬ì…</td>
                                </tr>
                                <tr class="result-row" data-row="available">
                                    <td class="sticky-col row-label"><strong>ğŸ“¦ ê°€ìš©ì¬ê³ </strong></td>
                                </tr>
                                <tr class="result-row" data-row="enduser">
                                    <td class="sticky-col row-label"><strong>ğŸ­ ì—”ë“œìœ ì €</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- í˜„ì¬ ì¬ê³  í˜„í™© (ì¶•ì†Œ) -->
        <div class="col-12">
            <div class="d-flex gap-3 justify-content-center flex-wrap" id="matrixInventorySummary">
                <div class="inventory-badge available">
                    <span class="label">ê°€ìš©ì¬ê³ </span>
                    <span class="value" id="matrixAvailable">-</span>
                </div>
                <div class="inventory-badge enduser">
                    <span class="label">ì—”ë“œìœ ì €</span>
                    <span class="value" id="matrixEnduser">-</span>
                </div>
                <div class="inventory-badge repair">
                    <span class="label">ì •ë¹„ëŒ€ê¸°</span>
                    <span class="value" id="matrixRepair">-</span>
                </div>
                <div class="inventory-badge expired">
                    <span class="label">ë‚´ì••ë§Œë£Œ</span>
                    <span class="value" id="matrixExpired">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì°¨íŠ¸ íŒ¨ë„ í…œí”Œë¦¿ (ê¸°ë³¸ ëª¨ë“œìš©) -->
{% verbatim %}
<template id="chartPanelTemplate">
</template>
{% endverbatim %}

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
let chart = null;
let matrixChart = null;
let simulationData = null;
let currentMode = 'basic';
let matrixData = {
    months: [],
    ship: {},
    fill: {},
    recover: {},
    purchase: {},
    repair: {},
    available: {},
    enduser: {},
    inRepair: {},
    expired: {}
};
let currentInventory = null;
let debounceTimer = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeMonths();
    
    // ëª¨ë“œ ì „í™˜
    document.getElementById('modeBasic').addEventListener('change', function() {
        if (this.checked) switchMode('basic');
    });
    document.getElementById('modeMatrix').addEventListener('change', function() {
        if (this.checked) switchMode('matrix');
    });
    
    // ìš©ê¸°ì¢…ë¥˜ ì„ íƒ
    document.getElementById('cylinderTypeSelect').addEventListener('change', function() {
        const selected = this.value;
        document.getElementById('simulateBtn').disabled = !selected;
        if (selected) {
            document.getElementById('currentInventoryCard').style.display = 'block';
            if (currentMode === 'basic') {
                runSimulation();
            } else {
                loadPlanData();
            }
        } else {
            document.getElementById('currentInventoryCard').style.display = 'none';
        }
    });

    // ê¸°ë³¸ ëª¨ë“œ ì´ë²¤íŠ¸ë“¤
    document.querySelectorAll('input[name="recoveryMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (simulationData) runSimulation();
        });
    });

    document.getElementById('recoveryRateSlider').addEventListener('input', function() {
        document.getElementById('recoveryRateValue').textContent = this.value + '%';
    });
    document.getElementById('recoveryRateSlider').addEventListener('change', function() {
        if (simulationData) runSimulation();
    });

    document.getElementById('purchaseMultiplier').addEventListener('input', function() {
        document.getElementById('purchaseMultValue').textContent = parseFloat(this.value).toFixed(1) + 'x';
    });
    document.getElementById('purchaseMultiplier').addEventListener('change', function() {
        if (simulationData) runSimulation();
    });

    document.getElementById('repairMultiplier').addEventListener('input', function() {
        document.getElementById('repairMultValue').textContent = parseFloat(this.value).toFixed(1) + 'x';
    });
    document.getElementById('repairMultiplier').addEventListener('change', function() {
        if (simulationData) runSimulation();
    });

    document.getElementById('recoveryLeadMonths').addEventListener('change', function() {
        if (simulationData) runSimulation();
    });

    document.getElementById('simulateBtn').addEventListener('click', runSimulation);

    document.querySelectorAll('input[name="chartType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (simulationData) renderChart(simulationData);
        });
    });
});

function initializeMonths() {
    const today = new Date();
    matrixData.months = [];
    for (let i = 0; i < 12; i++) {
        const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const monthKey = d.toISOString().slice(0, 7);
        matrixData.months.push(monthKey);
        
        // ì´ˆê¸°ê°’
        matrixData.ship[monthKey] = 0;
        matrixData.fill[monthKey] = 0;
        matrixData.recover[monthKey] = 0;
        matrixData.purchase[monthKey] = 0;
        matrixData.repair[monthKey] = 0;
    }
    buildMatrixTable();
}

function buildMatrixTable() {
    const table = document.getElementById('matrixTable');
    const thead = table.querySelector('thead tr');
    const rows = table.querySelectorAll('tbody tr');
    
    // í—¤ë” ì›” ì¶”ê°€
    thead.innerHTML = '<th class="sticky-col">í•­ëª©</th>';
    matrixData.months.forEach(month => {
        thead.innerHTML += `<th class="text-center month-header">${month}</th>`;
    });
    
    // ê° í–‰ì— ì…€ ì¶”ê°€
    rows.forEach(row => {
        const rowType = row.dataset.row;
        const isEditable = !row.classList.contains('result-row');
        const existingLabel = row.querySelector('.row-label');
        row.innerHTML = '';
        row.appendChild(existingLabel);
        
        matrixData.months.forEach(month => {
            const td = document.createElement('td');
            td.className = 'text-center matrix-cell';
            td.dataset.month = month;
            td.dataset.type = rowType;
            
            if (isEditable) {
                td.innerHTML = `<input type="number" class="matrix-input" value="0" min="0" 
                    data-month="${month}" data-type="${rowType}"
                    onchange="onMatrixChange(this)" oninput="onMatrixInput(this)">`;
            } else {
                td.innerHTML = `<span class="result-value">0</span>`;
            }
            row.appendChild(td);
        });
    });
}

function switchMode(mode) {
    currentMode = mode;
    if (mode === 'basic') {
        document.getElementById('basicModePanel').style.display = 'block';
        document.getElementById('matrixModePanel').style.display = 'none';
        if (document.getElementById('cylinderTypeSelect').value && simulationData) {
            renderChart(simulationData);
        }
    } else {
        document.getElementById('basicModePanel').style.display = 'none';
        document.getElementById('matrixModePanel').style.display = 'block';
        if (document.getElementById('cylinderTypeSelect').value) {
            loadPlanData();
        }
    }
}

async function loadPlanData() {
    const cylinderTypeKey = document.getElementById('cylinderTypeSelect').value;
    if (!cylinderTypeKey) return;

    try {
        // ê¸°ë³¸ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰í•´ì„œ ê³„íš ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch('{% url "simulation:calculate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                cylinder_type_key: cylinderTypeKey,
                recovery_method: 'fixed_rate',
                recovery_rate: 80,
                recovery_lead_months: 2,
                purchase_multiplier: 1,
                repair_multiplier: 1
            })
        });

        const result = await response.json();
        
        if (result.success) {
            currentInventory = result.data.current;
            updateMatrixInventory(currentInventory);
            
            // ê³„íš ë°ì´í„°ë¥¼ ë§¤íŠ¸ë¦­ìŠ¤ì— ë°˜ì˜
            result.data.details.forEach(row => {
                const month = row.month;
                matrixData.ship[month] = Math.abs(row.ship) || 0;
                matrixData.fill[month] = row.fill || 0;
                matrixData.recover[month] = row.recover || 0;
                matrixData.purchase[month] = row.purchase || 0;
                matrixData.repair[month] = row.repair || 0;
            });
            
            // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
            updateMatrixInputs();
            
            // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
            calculateMatrix();
        }
    } catch (error) {
        console.error('Load plan error:', error);
    }
}

function updateMatrixInputs() {
    ['ship', 'fill', 'recover', 'purchase', 'repair'].forEach(type => {
        matrixData.months.forEach(month => {
            const input = document.querySelector(`input[data-month="${month}"][data-type="${type}"]`);
            if (input) {
                input.value = matrixData[type][month] || 0;
            }
        });
    });
}

function updateMatrixInventory(inv) {
    document.getElementById('matrixAvailable').textContent = inv.available.toLocaleString();
    document.getElementById('matrixEnduser').textContent = inv.at_enduser.toLocaleString();
    document.getElementById('matrixRepair').textContent = inv.in_repair.toLocaleString();
    document.getElementById('matrixExpired').textContent = inv.expired.toLocaleString();
    
    // ê¸°ë³¸ ëª¨ë“œ í˜„í™©ë„ ì—…ë°ì´íŠ¸
    document.getElementById('currentAvailable').textContent = inv.available.toLocaleString();
    document.getElementById('currentEnduser').textContent = inv.at_enduser.toLocaleString();
    document.getElementById('currentRepair').textContent = inv.in_repair.toLocaleString();
    document.getElementById('currentExpired').textContent = inv.expired.toLocaleString();
}

function onMatrixInput(input) {
    // ì…ë ¥ ì¤‘ì—ëŠ” debounceë¡œ ê³„ì‚° ì§€ì—°
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        onMatrixChange(input);
    }, 300);
}

function onMatrixChange(input) {
    const month = input.dataset.month;
    const type = input.dataset.type;
    const value = parseInt(input.value) || 0;
    
    matrixData[type][month] = value;
    calculateMatrix();
}

function calculateMatrix() {
    if (!currentInventory) return;
    
    let available = currentInventory.available;
    let atEnduser = currentInventory.at_enduser;
    let inRepair = currentInventory.in_repair;
    let expired = currentInventory.expired;
    
    const availableSeries = [];
    const enduserSeries = [];
    
    matrixData.months.forEach(month => {
        const ship = matrixData.ship[month] || 0;
        const fill = matrixData.fill[month] || 0;
        const recover = matrixData.recover[month] || 0;
        const purchase = matrixData.purchase[month] || 0;
        const repair = matrixData.repair[month] || 0;
        
        // ì¶œí•˜: ê°€ìš© â†’ ì—”ë“œìœ ì €
        const actualShip = Math.min(ship, available);
        available -= actualShip;
        atEnduser += actualShip;
        
        // íšŒìˆ˜: ì—”ë“œìœ ì € â†’ ê°€ìš©
        const actualRecover = Math.min(recover, atEnduser);
        atEnduser -= actualRecover;
        available += actualRecover;
        
        // ì‹ ê·œ êµ¬ë§¤
        available += purchase;
        
        // ì •ë¹„ íˆ¬ì…
        const actualRepair = Math.min(repair, inRepair);
        inRepair -= actualRepair;
        available += actualRepair;
        
        // ê²°ê³¼ ì €ì¥
        matrixData.available[month] = available;
        matrixData.enduser[month] = atEnduser;
        
        availableSeries.push(available);
        enduserSeries.push(atEnduser);
    });
    
    // ê²°ê³¼ í–‰ ì—…ë°ì´íŠ¸
    matrixData.months.forEach(month => {
        const availableCell = document.querySelector(`tr[data-row="available"] td[data-month="${month}"] .result-value`);
        const enduserCell = document.querySelector(`tr[data-row="enduser"] td[data-month="${month}"] .result-value`);
        
        if (availableCell) availableCell.textContent = matrixData.available[month].toLocaleString();
        if (enduserCell) enduserCell.textContent = matrixData.enduser[month].toLocaleString();
    });
    
    // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
    renderMatrixChart(availableSeries, enduserSeries);
}

function renderMatrixChart(availableSeries, enduserSeries) {
    const options = {
        series: [
            { name: 'ê°€ìš©ì¬ê³ ', data: availableSeries },
            { name: 'ì—”ë“œìœ ì €', data: enduserSeries },
        ],
        chart: {
            type: 'area',
            height: 280,
            stacked: false,
            toolbar: { show: false },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 300
            }
        },
        colors: ['#34C759', '#007AFF'],
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 3 },
        fill: {
            type: 'gradient',
            gradient: { opacityFrom: 0.5, opacityTo: 0.1 }
        },
        xaxis: {
            categories: matrixData.months,
            labels: { style: { fontSize: '11px' } }
        },
        yaxis: {
            title: { text: 'ìš©ê¸° ìˆ˜ëŸ‰' },
            labels: {
                formatter: function(val) { return val.toLocaleString(); }
            }
        },
        tooltip: {
            shared: true,
            y: {
                formatter: function(val) { return val.toLocaleString() + 'ë³‘'; }
            }
        },
        legend: { position: 'top' }
    };

    if (matrixChart) {
        matrixChart.updateOptions(options);
    } else {
        matrixChart = new ApexCharts(document.getElementById('matrixChart'), options);
        matrixChart.render();
    }
}

function resetMatrix() {
    matrixData.months.forEach(month => {
        matrixData.ship[month] = 0;
        matrixData.fill[month] = 0;
        matrixData.recover[month] = 0;
        matrixData.purchase[month] = 0;
        matrixData.repair[month] = 0;
    });
    updateMatrixInputs();
    calculateMatrix();
}

// ==================== ê¸°ë³¸ ëª¨ë“œ í•¨ìˆ˜ë“¤ ====================

async function runSimulation() {
    const cylinderTypeKey = document.getElementById('cylinderTypeSelect').value;
    if (!cylinderTypeKey) return;

    const recoveryMethod = document.querySelector('input[name="recoveryMethod"]:checked').value;
    const recoveryRate = document.getElementById('recoveryRateSlider').value;
    const recoveryLeadMonths = document.getElementById('recoveryLeadMonths').value;
    const purchaseMultiplier = document.getElementById('purchaseMultiplier').value;
    const repairMultiplier = document.getElementById('repairMultiplier').value;

    try {
        const response = await fetch('{% url "simulation:calculate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                cylinder_type_key: cylinderTypeKey,
                recovery_method: recoveryMethod,
                recovery_rate: recoveryRate,
                recovery_lead_months: recoveryLeadMonths,
                purchase_multiplier: purchaseMultiplier,
                repair_multiplier: repairMultiplier
            })
        });

        const result = await response.json();
        
        if (result.success) {
            simulationData = result.data;
            currentInventory = result.data.current;
            updateCurrentInventory(result.data.current);
            renderChart(result.data);
            renderTable(result.data.details);
            document.getElementById('chartPlaceholder').style.display = 'none';
        } else {
            alert('ì˜¤ë¥˜: ' + result.error);
        }
    } catch (error) {
        console.error('Simulation error:', error);
        alert('ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function updateCurrentInventory(current) {
    document.getElementById('currentAvailable').textContent = current.available.toLocaleString();
    document.getElementById('currentEnduser').textContent = current.at_enduser.toLocaleString();
    document.getElementById('currentRepair').textContent = current.in_repair.toLocaleString();
    document.getElementById('currentExpired').textContent = current.expired.toLocaleString();
}

function renderChart(data) {
    const chartTypeEl = document.querySelector('input[name="chartType"]:checked');
    const chartType = chartTypeEl ? chartTypeEl.id : 'chartArea';
    
    let type = 'area';
    if (chartType === 'chartLine') type = 'line';
    if (chartType === 'chartBar') type = 'bar';

    const options = {
        series: [
            { name: 'ê°€ìš©ì¬ê³ ', data: data.series.available },
            { name: 'ì—”ë“œìœ ì €', data: data.series.at_enduser },
            { name: 'ì •ë¹„ëŒ€ê¸°', data: data.series.in_repair },
            { name: 'ë‚´ì••ë§Œë£Œ', data: data.series.expired },
        ],
        chart: {
            type: type,
            height: 350,
            stacked: type === 'area' || type === 'bar',
            toolbar: {
                show: true,
                tools: { download: true, selection: false, zoom: false, zoomin: false, zoomout: false, pan: false, reset: false }
            },
            animations: { enabled: true, easing: 'easeinout', speed: 500 }
        },
        colors: ['#34C759', '#007AFF', '#FF9500', '#FF3B30'],
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: type === 'area' ? 2 : 3 },
        fill: {
            type: type === 'area' ? 'gradient' : 'solid',
            gradient: { opacityFrom: 0.6, opacityTo: 0.1 }
        },
        xaxis: {
            categories: data.months,
            labels: { style: { fontSize: '11px' } }
        },
        yaxis: {
            title: { text: 'ìš©ê¸° ìˆ˜ëŸ‰' },
            labels: { formatter: function(val) { return val.toLocaleString(); } }
        },
        tooltip: {
            shared: true,
            intersect: false,
            y: { formatter: function(val) { return val.toLocaleString() + 'ë³‘'; } }
        },
        legend: { position: 'top', horizontalAlign: 'center' }
    };

    if (chart) chart.destroy();
    chart = new ApexCharts(document.getElementById('simulationChart'), options);
    chart.render();
}

function renderTable(details) {
    const tbody = document.getElementById('detailsBody');
    
    let html = '';
    for (const row of details) {
        const fillDisplay = row.is_shutdown 
            ? '<span class="badge bg-warning text-dark">ğŸ”§ ì˜¤ë²„í™€</span>' 
            : (row.fill ? row.fill : '-');
        html += `
            <tr class="${row.is_shutdown ? 'table-warning' : ''}">
                <td><strong>${row.month}</strong></td>
                <td class="text-end">${row.available.toLocaleString()}</td>
                <td class="text-end" style="color:#5856D6;">${fillDisplay}</td>
                <td class="text-end text-danger">${row.ship}</td>
                <td class="text-end text-success">+${row.recover}</td>
                <td class="text-end text-primary">+${row.purchase}</td>
                <td class="text-end text-info">+${row.repair}</td>
                <td class="text-end text-warning">${row.expire}</td>
                <td class="text-end">${row.at_enduser.toLocaleString()}</td>
            </tr>
        `;
    }
    
    tbody.innerHTML = html;
}
</script>

<style>
.inventory-stat {
    padding: 12px 8px;
    border-radius: 8px;
    background: #f8f9fa;
}
.inventory-stat.available { background: rgba(52, 199, 89, 0.1); }
.inventory-stat.enduser { background: rgba(0, 122, 255, 0.1); }
.inventory-stat.repair { background: rgba(255, 149, 0, 0.1); }
.inventory-stat.expired { background: rgba(255, 59, 48, 0.1); }

.inventory-stat .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
}
.inventory-stat.available .stat-value { color: #34C759; }
.inventory-stat.enduser .stat-value { color: #007AFF; }
.inventory-stat.repair .stat-value { color: #FF9500; }
.inventory-stat.expired .stat-value { color: #FF3B30; }

.inventory-stat .stat-label {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

/* ë§¤íŠ¸ë¦­ìŠ¤ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
.matrix-edit-table {
    font-size: 13px;
}
.matrix-edit-table th {
    background: #F5F5F7;
    font-weight: 600;
    font-size: 11px;
    padding: 8px 4px;
    white-space: nowrap;
}
.matrix-edit-table .sticky-col {
    position: sticky;
    left: 0;
    background: #fff;
    z-index: 1;
    border-right: 2px solid #dee2e6 !important;
    min-width: 140px;
}
.matrix-edit-table thead .sticky-col {
    background: #F5F5F7;
    z-index: 2;
}
.matrix-edit-table .row-label {
    font-size: 12px;
    padding: 4px 8px;
}
.matrix-edit-table .matrix-cell {
    padding: 2px !important;
}
.matrix-input {
    width: 60px;
    text-align: center;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 4px;
    font-size: 13px;
    font-variant-numeric: tabular-nums;
}
.matrix-input:focus {
    outline: none;
    border-color: var(--ios-blue);
    box-shadow: 0 0 0 2px rgba(0,122,255,0.2);
}
.result-row {
    background: #f8f9fa !important;
}
.result-row td {
    font-weight: 600;
}
.result-value {
    font-variant-numeric: tabular-nums;
    color: var(--ios-blue);
}
.month-header {
    min-width: 70px;
}
.bg-purple {
    background-color: #5856D6 !important;
}

/* ë§¤íŠ¸ë¦­ìŠ¤ ì¬ê³  ë°°ì§€ */
.inventory-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
}
.inventory-badge.available { background: rgba(52, 199, 89, 0.1); }
.inventory-badge.enduser { background: rgba(0, 122, 255, 0.1); }
.inventory-badge.repair { background: rgba(255, 149, 0, 0.1); }
.inventory-badge.expired { background: rgba(255, 59, 48, 0.1); }

.inventory-badge .label { color: #666; }
.inventory-badge .value { 
    font-weight: 700; 
    font-variant-numeric: tabular-nums;
}
.inventory-badge.available .value { color: #34C759; }
.inventory-badge.enduser .value { color: #007AFF; }
.inventory-badge.repair .value { color: #FF9500; }
.inventory-badge.expired .value { color: #FF3B30; }

.legend-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #666;
}
.legend-badge .dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}
.legend-badge.available .dot { background: #34C759; }
.legend-badge.enduser .dot { background: #007AFF; }
.legend-badge.repair .dot { background: #FF9500; }
.legend-badge.expired .dot { background: #FF3B30; }

#detailsTable th {
    background: #f8f9fa;
    font-size: 11px;
    font-weight: 600;
    padding: 8px 12px;
}
#detailsTable td {
    padding: 8px 12px;
    font-variant-numeric: tabular-nums;
}

.form-range::-webkit-slider-thumb {
    background: var(--ios-blue);
}
</style>
{% endblock %}
