{% extends 'base.html' %}
{% load humanize %}

{% block title %}ìš©ê¸° ì‚¬ì´í´ ì‹œë®¬ë ˆì´ì…˜ - CYNOW{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="page-title">ğŸ”„ ìš©ê¸° ì‚¬ì´í´ ì‹œë®¬ë ˆì´ì…˜</h1>
    <p class="page-subtitle">CYLINDER LIFECYCLE â€¢ ì¶œí•˜/íšŒìˆ˜/íˆ¬ì… ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì¸¡</p>
</div>

<div class="row g-4">
    <!-- ì¢Œì¸¡: ì„¤ì • íŒ¨ë„ -->
    <div class="col-lg-4">
        <!-- ìš©ê¸°ì¢…ë¥˜ ì„ íƒ -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-box-seam me-2"></i>ìš©ê¸°ì¢…ë¥˜ ì„ íƒ
            </div>
            <div class="card-body">
                <select id="cylinderTypeSelect" class="form-select">
                    <option value="">-- ìš©ê¸°ì¢…ë¥˜ ì„ íƒ --</option>
                    {% for ct in cylinder_types %}
                    <option value="{{ ct.cylinder_type_key }}" 
                            data-gas="{{ ct.gas_name }}"
                            data-capacity="{{ ct.capacity }}">
                        {{ ct.display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- í˜„ì¬ ì¬ê³  í˜„í™© -->
        <div class="card mb-3" id="currentInventoryCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-pie-chart me-2"></i>í˜„ì¬ ì¬ê³  í˜„í™©
            </div>
            <div class="card-body">
                <div class="row g-2 text-center">
                    <div class="col-6">
                        <div class="inventory-stat available">
                            <div class="stat-value" id="currentAvailable">-</div>
                            <div class="stat-label">ê°€ìš©ì¬ê³ </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="inventory-stat enduser">
                            <div class="stat-value" id="currentEnduser">-</div>
                            <div class="stat-label">ì—”ë“œìœ ì €</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="inventory-stat repair">
                            <div class="stat-value" id="currentRepair">-</div>
                            <div class="stat-label">ì •ë¹„ëŒ€ê¸°</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="inventory-stat expired">
                            <div class="stat-value" id="currentExpired">-</div>
                            <div class="stat-label">ë‚´ì••ë§Œë£Œ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- íšŒìˆ˜ ì˜ˆì¸¡ ì„¤ì • -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-arrow-return-left me-2"></i>íšŒìˆ˜ ì˜ˆì¸¡ ì„¤ì •
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="recoveryMethod" 
                               id="methodFixedRate" value="fixed_rate" checked>
                        <label class="form-check-label" for="methodFixedRate">
                            ê³ ì • ë¹„ìœ¨
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="recoveryMethod" 
                               id="methodHistorical" value="historical">
                        <label class="form-check-label" for="methodHistorical">
                            ê³¼ê±° ì‹¤ì  ê¸°ë°˜
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="recoveryMethod" 
                               id="methodManual" value="manual">
                        <label class="form-check-label" for="methodManual">
                            ì§ì ‘ ì…ë ¥
                        </label>
                    </div>
                </div>

                <!-- ê³ ì • ë¹„ìœ¨ ì„¤ì • -->
                <div id="fixedRateSettings">
                    <div class="mb-3">
                        <label class="form-label">íšŒìˆ˜ìœ¨</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="range" class="form-range flex-grow-1" id="recoveryRateSlider" 
                                   min="0" max="100" value="80">
                            <span class="badge bg-primary" id="recoveryRateValue">80%</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">íšŒìˆ˜ ë¦¬ë“œíƒ€ì„</label>
                        <select id="recoveryLeadMonths" class="form-select form-select-sm">
                            <option value="1">1ê°œì›”</option>
                            <option value="2" selected>2ê°œì›”</option>
                            <option value="3">3ê°œì›”</option>
                            <option value="4">4ê°œì›”</option>
                            <option value="6">6ê°œì›”</option>
                        </select>
                    </div>
                </div>

                <!-- ì§ì ‘ ì…ë ¥ (ìˆ¨ê¹€) -->
                <div id="manualSettings" style="display: none;">
                    <p class="text-muted small">ì›”ë³„ íšŒìˆ˜ëŸ‰ì€ í•˜ë‹¨ í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <!-- íˆ¬ì… ì¡°ì ˆ -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-sliders me-2"></i>íˆ¬ì… ì¡°ì ˆ
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label d-flex justify-content-between">
                        <span>ì‹ ê·œ êµ¬ë§¤ ë°°ìˆ˜</span>
                        <span class="text-primary fw-bold" id="purchaseMultValue">1.0x</span>
                    </label>
                    <input type="range" class="form-range" id="purchaseMultiplier" 
                           min="0" max="2" step="0.1" value="1">
                    <div class="d-flex justify-content-between text-muted small">
                        <span>0x</span>
                        <span>ê³„íšëŒ€ë¹„</span>
                        <span>2x</span>
                    </div>
                </div>
                <div class="mb-0">
                    <label class="form-label d-flex justify-content-between">
                        <span>ì •ë¹„ íˆ¬ì… ë°°ìˆ˜</span>
                        <span class="text-primary fw-bold" id="repairMultValue">1.0x</span>
                    </label>
                    <input type="range" class="form-range" id="repairMultiplier" 
                           min="0" max="2" step="0.1" value="1">
                    <div class="d-flex justify-content-between text-muted small">
                        <span>0x</span>
                        <span>ê³„íšëŒ€ë¹„</span>
                        <span>2x</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ -->
        <button class="btn btn-primary w-100 btn-lg" id="simulateBtn" disabled>
            <i class="bi bi-play-fill me-2"></i>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
        </button>
    </div>

    <!-- ìš°ì¸¡: ê·¸ë˜í”„ ë° ê²°ê³¼ -->
    <div class="col-lg-8">
        <!-- ê·¸ë˜í”„ ì¹´ë“œ -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up me-2"></i>12ê°œì›” ì¬ê³  ì˜ˆì¸¡</span>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="chartType" id="chartArea" checked>
                    <label class="btn btn-outline-secondary" for="chartArea">ì˜ì—­</label>
                    <input type="radio" class="btn-check" name="chartType" id="chartLine">
                    <label class="btn btn-outline-secondary" for="chartLine">ì„ </label>
                    <input type="radio" class="btn-check" name="chartType" id="chartBar">
                    <label class="btn btn-outline-secondary" for="chartBar">ë§‰ëŒ€</label>
                </div>
            </div>
            <div class="card-body">
                <div id="simulationChart" style="min-height: 350px;"></div>
                <div id="chartPlaceholder" class="text-center text-muted py-5">
                    <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
                    <p class="mt-3">ìš©ê¸°ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ê³  ì‹œë®¬ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>

        <!-- ë²”ë¡€ -->
        <div class="d-flex gap-3 mb-3 flex-wrap justify-content-center">
            <span class="legend-badge available"><span class="dot"></span>ê°€ìš©ì¬ê³ </span>
            <span class="legend-badge enduser"><span class="dot"></span>ì—”ë“œìœ ì € ë³´ìœ </span>
            <span class="legend-badge repair"><span class="dot"></span>ì •ë¹„ëŒ€ê¸°</span>
            <span class="legend-badge expired"><span class="dot"></span>ë‚´ì••ë§Œë£Œ</span>
        </div>

        <!-- ìƒì„¸ í…Œì´ë¸” -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table me-2"></i>ì›”ë³„ ìƒì„¸ ë‚´ì—­</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#detailsCollapse">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            <div class="collapse show" id="detailsCollapse">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="detailsTable">
                            <thead>
                                <tr>
                                    <th>ì›”</th>
                                    <th class="text-end">ê°€ìš©</th>
                                    <th class="text-end text-danger">ì¶œí•˜</th>
                                    <th class="text-end text-success">íšŒìˆ˜</th>
                                    <th class="text-end text-primary">êµ¬ë§¤</th>
                                    <th class="text-end text-info">ì •ë¹„</th>
                                    <th class="text-end text-warning">ë§Œë£Œ</th>
                                    <th class="text-end">ì—”ë“œìœ ì €</th>
                                </tr>
                            </thead>
                            <tbody id="detailsBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let chart = null;
let simulationData = null;

document.addEventListener('DOMContentLoaded', function() {
    // ìš©ê¸°ì¢…ë¥˜ ì„ íƒ ì‹œ
    document.getElementById('cylinderTypeSelect').addEventListener('change', function() {
        const selected = this.value;
        document.getElementById('simulateBtn').disabled = !selected;
        if (selected) {
            document.getElementById('currentInventoryCard').style.display = 'block';
            // ìë™ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
            runSimulation();
        } else {
            document.getElementById('currentInventoryCard').style.display = 'none';
        }
    });

    // íšŒìˆ˜ ë°©ë²• ë³€ê²½ ì‹œ
    document.querySelectorAll('input[name="recoveryMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('fixedRateSettings').style.display = 
                (this.value === 'fixed_rate' || this.value === 'historical') ? 'block' : 'none';
            document.getElementById('manualSettings').style.display = 
                this.value === 'manual' ? 'block' : 'none';
            
            if (simulationData) runSimulation();
        });
    });

    // ìŠ¬ë¼ì´ë” ë³€ê²½ ì‹œ
    document.getElementById('recoveryRateSlider').addEventListener('input', function() {
        document.getElementById('recoveryRateValue').textContent = this.value + '%';
    });
    document.getElementById('recoveryRateSlider').addEventListener('change', function() {
        if (simulationData) runSimulation();
    });

    document.getElementById('purchaseMultiplier').addEventListener('input', function() {
        document.getElementById('purchaseMultValue').textContent = parseFloat(this.value).toFixed(1) + 'x';
    });
    document.getElementById('purchaseMultiplier').addEventListener('change', function() {
        if (simulationData) runSimulation();
    });

    document.getElementById('repairMultiplier').addEventListener('input', function() {
        document.getElementById('repairMultValue').textContent = parseFloat(this.value).toFixed(1) + 'x';
    });
    document.getElementById('repairMultiplier').addEventListener('change', function() {
        if (simulationData) runSimulation();
    });

    document.getElementById('recoveryLeadMonths').addEventListener('change', function() {
        if (simulationData) runSimulation();
    });

    // ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼
    document.getElementById('simulateBtn').addEventListener('click', runSimulation);

    // ì°¨íŠ¸ íƒ€ì… ë³€ê²½
    document.querySelectorAll('input[name="chartType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (simulationData) {
                renderChart(simulationData);
            }
        });
    });
});

async function runSimulation() {
    const cylinderTypeKey = document.getElementById('cylinderTypeSelect').value;
    if (!cylinderTypeKey) return;

    const recoveryMethod = document.querySelector('input[name="recoveryMethod"]:checked').value;
    const recoveryRate = document.getElementById('recoveryRateSlider').value;
    const recoveryLeadMonths = document.getElementById('recoveryLeadMonths').value;
    const purchaseMultiplier = document.getElementById('purchaseMultiplier').value;
    const repairMultiplier = document.getElementById('repairMultiplier').value;

    try {
        const response = await fetch('{% url "simulation:calculate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                cylinder_type_key: cylinderTypeKey,
                recovery_method: recoveryMethod,
                recovery_rate: recoveryRate,
                recovery_lead_months: recoveryLeadMonths,
                purchase_multiplier: purchaseMultiplier,
                repair_multiplier: repairMultiplier
            })
        });

        const result = await response.json();
        
        if (result.success) {
            simulationData = result.data;
            updateCurrentInventory(result.data.current);
            renderChart(result.data);
            renderTable(result.data.details);
            document.getElementById('chartPlaceholder').style.display = 'none';
        } else {
            alert('ì˜¤ë¥˜: ' + result.error);
        }
    } catch (error) {
        console.error('Simulation error:', error);
        alert('ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function updateCurrentInventory(current) {
    document.getElementById('currentAvailable').textContent = current.available.toLocaleString();
    document.getElementById('currentEnduser').textContent = current.at_enduser.toLocaleString();
    document.getElementById('currentRepair').textContent = current.in_repair.toLocaleString();
    document.getElementById('currentExpired').textContent = current.expired.toLocaleString();
}

function renderChart(data) {
    const chartType = document.querySelector('input[name="chartType"]:checked').id;
    
    let type = 'area';
    if (chartType === 'chartLine') type = 'line';
    if (chartType === 'chartBar') type = 'bar';

    const options = {
        series: [
            { name: 'ê°€ìš©ì¬ê³ ', data: data.series.available },
            { name: 'ì—”ë“œìœ ì €', data: data.series.at_enduser },
            { name: 'ì •ë¹„ëŒ€ê¸°', data: data.series.in_repair },
            { name: 'ë‚´ì••ë§Œë£Œ', data: data.series.expired },
        ],
        chart: {
            type: type,
            height: 350,
            stacked: type === 'area' || type === 'bar',
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 500
            }
        },
        colors: ['#34C759', '#007AFF', '#FF9500', '#FF3B30'],
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth',
            width: type === 'area' ? 2 : 3
        },
        fill: {
            type: type === 'area' ? 'gradient' : 'solid',
            gradient: {
                opacityFrom: 0.6,
                opacityTo: 0.1,
            }
        },
        xaxis: {
            categories: data.months,
            labels: {
                style: {
                    fontSize: '11px'
                }
            }
        },
        yaxis: {
            title: {
                text: 'ìš©ê¸° ìˆ˜ëŸ‰'
            },
            labels: {
                formatter: function(val) {
                    return val.toLocaleString();
                }
            }
        },
        tooltip: {
            shared: true,
            intersect: false,
            y: {
                formatter: function(val) {
                    return val.toLocaleString() + 'ë³‘';
                }
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'center'
        }
    };

    if (chart) {
        chart.destroy();
    }

    chart = new ApexCharts(document.getElementById('simulationChart'), options);
    chart.render();
}

function renderTable(details) {
    const tbody = document.getElementById('detailsBody');
    
    let html = '';
    for (const row of details) {
        html += `
            <tr>
                <td><strong>${row.month}</strong></td>
                <td class="text-end">${row.available.toLocaleString()}</td>
                <td class="text-end text-danger">${row.ship}</td>
                <td class="text-end text-success">+${row.recover}</td>
                <td class="text-end text-primary">+${row.purchase}</td>
                <td class="text-end text-info">+${row.repair}</td>
                <td class="text-end text-warning">${row.expire}</td>
                <td class="text-end">${row.at_enduser.toLocaleString()}</td>
            </tr>
        `;
    }
    
    tbody.innerHTML = html;
}
</script>

<style>
.inventory-stat {
    padding: 12px 8px;
    border-radius: 8px;
    background: #f8f9fa;
}
.inventory-stat.available { background: rgba(52, 199, 89, 0.1); }
.inventory-stat.enduser { background: rgba(0, 122, 255, 0.1); }
.inventory-stat.repair { background: rgba(255, 149, 0, 0.1); }
.inventory-stat.expired { background: rgba(255, 59, 48, 0.1); }

.inventory-stat .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
}
.inventory-stat.available .stat-value { color: #34C759; }
.inventory-stat.enduser .stat-value { color: #007AFF; }
.inventory-stat.repair .stat-value { color: #FF9500; }
.inventory-stat.expired .stat-value { color: #FF3B30; }

.inventory-stat .stat-label {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

.legend-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #666;
}
.legend-badge .dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}
.legend-badge.available .dot { background: #34C759; }
.legend-badge.enduser .dot { background: #007AFF; }
.legend-badge.repair .dot { background: #FF9500; }
.legend-badge.expired .dot { background: #FF3B30; }

#detailsTable th {
    background: #f8f9fa;
    font-size: 11px;
    font-weight: 600;
    padding: 8px 12px;
}
#detailsTable td {
    padding: 8px 12px;
    font-variant-numeric: tabular-nums;
}

.form-range::-webkit-slider-thumb {
    background: var(--ios-blue);
}
</style>
{% endblock %}

