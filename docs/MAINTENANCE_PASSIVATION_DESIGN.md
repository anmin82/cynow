# 정비/패시베이션(외주) 관리 설계 (CYNOW)

## 목적

- **FCMS에서 아직 전산 처리가 없는 “정비대상 용기(내압만료/이상상태)”**를 CYNOW에서 우선 운영 가능하게 한다.
- 현장 업무 특성상 **문서 출력 + 바코드 스캔** 기반으로 정확하게 처리되도록 한다.
- FCMS 원상태를 훼손하지 않고도 운영 가능하도록, CYNOW는 **오버레이(overlay) 상태**를 별도로 관리한다.

---

## 용어 정의

- **정비업체(Vendor)**: 외주 정비 업체(현재 2곳).
- **정비지시서(Instruction)**: 정비 작업을 시작하기 위한 내부 문서(세션을 여는 “키”).
- **정비세션(Session)**: 정비지시서 1건에 해당하는 실행 단위. “어떤 업체에 어떤 용기들을 보낼지”를 담는다.
- **정비의뢰서(Request)**: 정비업체로 실제 전달하는 문서(업체 제출용).
- **패시베이션(Passivation)**: 정비 후 제조부에서 내부 코팅 목적의 소량 충전 + **2주 보관**이 필요한 프로세스.
- **오버레이 상태(CYNOW State)**: FCMS 상태와 별개로, CYNOW에서만 관리하는 상태(정비중/보관 등).

---

## 범위(가정)

- “정비대상(내압만료/이상)”은 FCMS에 별도 처리가 없어도 CYNOW에서 선제적으로 관리한다.
- 추후 FCMS에서 정비출고/정비입고 처리가 가능해질 경우, CYNOW는 운영 방식을 재검토한다.

---

## 전체 업무 흐름(사용자 여정)

### 1) 정비지시서 생성(UI)

- 정비업체 선택(2곳), 요청일/희망출고일, 사유(내압만료/이상), 비고를 입력한다.
- 생성 시 **정비지시서 번호**를 부여하고 **바코드(또는 QR) 포함**하여 출력 가능해야 한다.

### 2) 정비지시서 스캔 → 세션 오픈(UI, 스캔 모드)

- 현장에서 **정비지시서 바코드 스캔** → 해당 정비세션 화면으로 진입(또는 자동 생성/오픈).
- 이후 **용기번호 바코드**를 연속 스캔하여 세션에 용기를 추가/제거한다.
- 검증(즉시 경고):
  - 이미 다른 세션에 묶인 용기
  - 이미 “정비중/보관” 오버레이 상태인 용기
  - 중복 스캔

### 3) 정비의뢰서 출력(PDF)

- 세션에 용기들이 확정되면 **정비의뢰서 출력**.
- 포함 정보(예시):
  - 업체/요청자/연락처
  - 요청일/희망일
  - 용기 목록(용기번호, 규격, 가스/용량 등)
  - 이상 내용(표준 분류 + 비고)

### 4) 출고 처리(용기번호 1개씩 스캔)

- 실제 출고일에 정비세션을 선택 → “출고 처리”로 진입
- 용기번호를 하나씩 스캔하여 **출고 완료 처리**
- 스캔된 용기만 출고로 인정(누락 방지)
- 출고 완료된 용기는 **오버레이 상태=정비중**으로 전환
- “정비중 대시보드”에 업체별/경과일/수량이 표시되어야 한다.

### 5) 입고 처리(정비완료 스캔)

- 돌아온 용기를 “입고/정비완료” 화면에서 용기번호 스캔
- 용기별 **정비완료일/입고일** 기록
- 다음 단계인 패시베이션 필요 여부를 체크(기본값 정책 필요)

### 6) 패시베이션 의뢰(문서 + 메일)

- 패시베이션 대상 묶음을 생성(세션/일자 단위 등 운영 기준 필요)
- **패시베이션 의뢰서 출력(PDF)** 후, “패시베이션 의뢰 메일”에 첨부
- MVP 권장:
  - 시스템이 **메일 본문 텍스트 생성** + 의뢰서 PDF 다운로드 제공
  - 실제 발송은 사람이 수행(그룹웨어/SMTP 연동은 2차)

### 7) 패시베이션 완료 → 2주 보관 → 상태 전환

- 패시베이션 완료 처리 시 **오버레이 상태=보관:미회수**로 변경
- **보관 만료 예정일(완료일 + 14일)** 트래킹
- 회수/가용 전환(누가/언제)을 기록(정책 필요)

---

## 상태 모델(제안)

### 정비세션 상태(예시)

- 작성중 → 용기선정완료 → 의뢰서발행 → 출고중 → 정비중 → 입고완료 → 종료

### 용기 오버레이 상태(예시)

- 정비출고대기 → 정비중 → 정비완료 → 패시베이션대기 → 보관:미회수 → (가용 전환/오버레이 해제)

> 원칙: **현장 스캔 이벤트가 상태 진행의 트리거**가 된다.

---

## 데이터 모델(개념 설계)

### 정비업체(Vendor)

- 업체명, 담당자, 연락처, 주소
- 의뢰서 양식(로고/문구/필드 차이 대응 여부)

### 정비세션(MaintenanceSession)

- 세션번호(=정비지시서 번호), 업체, 생성자, 생성일
- 요청일/희망출고일/실출고일/실입고일
- 상태, 메모

### 정비세션 항목(MaintenanceSessionItem)

- 세션(FK), 용기번호
- 선택 시각, 출고 스캔 시각, 입고 스캔 시각
- 항목 상태(선정/출고/입고 등), 비고/이상 내용

### 패시베이션 세션(PassivationSession)

- 세션번호, 대상 용기 목록
- 의뢰서 출력 이력, 완료일
- 보관 만료 예정일(완료일 + 14일)

### 오버레이 용기 상태(CynowCylinderState)

- 용기번호 기준으로 CYNOW 상태를 저장(정비중/보관 등)
- FCMS의 원상태는 변경하지 않음(조회는 병행)

---

## UI 구성(MVP 화면)

- 정비지시서 작성
- 정비지시서 스캔/용기선정(스캔 모드: 큰 글씨/큰 버튼/자동 포커스)
- 정비의뢰서 출력(PDF)
- 정비 출고 처리(스캔 모드)
- 정비중 대시보드(업체별, 경과일, 지연 경고)
- 정비 입고/정비완료 처리(스캔 모드)
- 패시베이션 의뢰서 작성/출력 + 메일 본문 텍스트 생성
- 보관(미회수) 목록/2주 타이머/회수 처리

---

## 운영/정책 결정이 필요한 질문(체크리스트)

1) 정비대상 판정 기준(자동 추출 가능 여부)
   - 예: `pressure_expire_date` 기반, 이상 플래그(예: `needs_fcms_fix`) 기반 등
2) “이상 용기” 표준 분류(의뢰서에 찍힐 코드/라벨)
3) 정비업체 2곳의 의뢰서 양식 동일/상이 여부
4) 정비 완료 후 패시베이션 진행 비율(예외 케이스 존재 여부)
5) “보관:미회수” 이후 다음 단계 정의(회수=가용 전환인지, 제조부 회수인지)
6) 정비/보관 중 용기가 용기재고(가용/보유현황)에 표시되는 방식
   - 권장: 가용 제외 + 별도 카운트(정비중/보관)

---

## FCMS/현장 스캐너 운영 옵션(비교)

- 옵션 1(MVP 권장): iPad/PC + 블루투스 스캐너(키보드 웨지)로 CYNOW 스캔 모드 운영
- 옵션 2(통합 지향): FCMS 핸디터미널로 정비 처리가 가능해지면 CYNOW는 조회/문서/대시보드 중심으로 축소
- 옵션 3(중간): 현장 스캔은 FCMS 유지, CYNOW는 세션/문서/보관만 수기/업로드로 연결


